"""
HydraRecon Penetration Testing Report Generator Module
Professional pentest reporting with OWASP, PTES, and NIST frameworks
"""

import asyncio
import json
import hashlib
from datetime import datetime, timedelta
from typing import Dict, List, Any, Optional, Set, Tuple
from dataclasses import dataclass, field
from enum import Enum
import sqlite3
import logging


class ReportType(Enum):
    """Report type categories"""
    EXECUTIVE_SUMMARY = "executive_summary"
    TECHNICAL_REPORT = "technical_report"
    VULNERABILITY_REPORT = "vulnerability_report"
    COMPLIANCE_REPORT = "compliance_report"
    PENTEST_REPORT = "pentest_report"
    RED_TEAM_REPORT = "red_team_report"
    SECURITY_ASSESSMENT = "security_assessment"
    RISK_ASSESSMENT = "risk_assessment"
    REMEDIATION_REPORT = "remediation_report"
    RETESTING_REPORT = "retesting_report"


class ReportFormat(Enum):
    """Output format types"""
    PDF = "pdf"
    HTML = "html"
    DOCX = "docx"
    MARKDOWN = "markdown"
    JSON = "json"
    CSV = "csv"
    XML = "xml"


class ComplianceFramework(Enum):
    """Compliance frameworks"""
    OWASP_TOP10 = "owasp_top10"
    OWASP_ASVS = "owasp_asvs"
    PTES = "ptes"
    NIST_CSF = "nist_csf"
    NIST_800_53 = "nist_800_53"
    PCI_DSS = "pci_dss"
    HIPAA = "hipaa"
    SOC2 = "soc2"
    ISO_27001 = "iso_27001"
    GDPR = "gdpr"
    CIS_CONTROLS = "cis_controls"
    MITRE_ATTACK = "mitre_attack"


class SeverityLevel(Enum):
    """Vulnerability severity levels"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFORMATIONAL = "informational"


class EngagementPhase(Enum):
    """Penetration testing phases"""
    RECONNAISSANCE = "reconnaissance"
    SCANNING = "scanning"
    GAINING_ACCESS = "gaining_access"
    MAINTAINING_ACCESS = "maintaining_access"
    COVERING_TRACKS = "covering_tracks"
    REPORTING = "reporting"


@dataclass
class Finding:
    """Security finding/vulnerability"""
    finding_id: str
    title: str
    description: str
    severity: SeverityLevel
    
    # Technical details
    vulnerability_type: str = ""
    affected_asset: str = ""
    affected_component: str = ""
    cvss_score: float = 0.0
    cvss_vector: str = ""
    cve_ids: List[str] = field(default_factory=list)
    cwe_ids: List[str] = field(default_factory=list)
    
    # Impact
    business_impact: str = ""
    technical_impact: str = ""
    likelihood: str = "medium"
    exploitability: str = "medium"
    
    # Evidence
    proof_of_concept: str = ""
    evidence: List[str] = field(default_factory=list)
    screenshots: List[str] = field(default_factory=list)
    request_response: str = ""
    
    # Remediation
    recommendation: str = ""
    remediation_steps: List[str] = field(default_factory=list)
    references: List[str] = field(default_factory=list)
    remediation_effort: str = "medium"
    remediation_priority: int = 1
    
    # Compliance mapping
    owasp_category: str = ""
    pci_requirement: str = ""
    nist_control: str = ""
    mitre_technique: str = ""
    
    # Status
    status: str = "open"
    verified_date: Optional[datetime] = None
    remediated_date: Optional[datetime] = None
    
    # Metadata
    discovered_date: datetime = field(default_factory=datetime.now)
    discovered_by: str = ""
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "finding_id": self.finding_id,
            "title": self.title,
            "description": self.description,
            "severity": self.severity.value,
            "vulnerability_type": self.vulnerability_type,
            "affected_asset": self.affected_asset,
            "cvss_score": self.cvss_score,
            "cve_ids": self.cve_ids,
            "cwe_ids": self.cwe_ids,
            "business_impact": self.business_impact,
            "recommendation": self.recommendation,
            "status": self.status,
            "owasp_category": self.owasp_category,
            "mitre_technique": self.mitre_technique
        }


@dataclass
class Engagement:
    """Penetration testing engagement"""
    engagement_id: str
    name: str
    client: str
    scope_type: str  # network, web, mobile, api, cloud, etc.
    
    # Timeline
    start_date: datetime = field(default_factory=datetime.now)
    end_date: Optional[datetime] = None
    report_due_date: Optional[datetime] = None
    
    # Scope
    in_scope_targets: List[str] = field(default_factory=list)
    out_of_scope_targets: List[str] = field(default_factory=list)
    testing_hours: str = ""
    testing_restrictions: List[str] = field(default_factory=list)
    
    # Team
    lead_tester: str = ""
    team_members: List[str] = field(default_factory=list)
    client_contacts: List[str] = field(default_factory=list)
    
    # Methodology
    methodology: str = "ptes"
    compliance_frameworks: List[str] = field(default_factory=list)
    testing_type: str = "gray_box"  # black_box, gray_box, white_box
    
    # Findings
    findings: List[Finding] = field(default_factory=list)
    
    # Status
    status: str = "active"
    current_phase: EngagementPhase = EngagementPhase.RECONNAISSANCE
    
    # Metadata
    created_at: datetime = field(default_factory=datetime.now)
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "engagement_id": self.engagement_id,
            "name": self.name,
            "client": self.client,
            "scope_type": self.scope_type,
            "start_date": self.start_date.isoformat(),
            "status": self.status,
            "finding_count": len(self.findings)
        }


@dataclass
class ReportTemplate:
    """Report template configuration"""
    template_id: str
    name: str
    report_type: ReportType
    
    # Structure
    sections: List[str] = field(default_factory=list)
    include_executive_summary: bool = True
    include_methodology: bool = True
    include_findings: bool = True
    include_remediation: bool = True
    include_appendix: bool = True
    
    # Styling
    logo_path: str = ""
    header_text: str = ""
    footer_text: str = ""
    color_scheme: str = "professional"
    font_family: str = "Arial"
    
    # Customization
    custom_sections: Dict[str, str] = field(default_factory=dict)
    findings_grouping: str = "severity"  # severity, asset, type
    include_risk_matrix: bool = True
    include_charts: bool = True
    
    # Branding
    company_name: str = ""
    company_address: str = ""
    company_website: str = ""
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "template_id": self.template_id,
            "name": self.name,
            "report_type": self.report_type.value,
            "sections": self.sections
        }


@dataclass
class GeneratedReport:
    """Generated report instance"""
    report_id: str
    engagement_id: str
    template_id: str
    title: str
    
    # Content
    content: str = ""
    format: ReportFormat = ReportFormat.HTML
    
    # Statistics
    total_findings: int = 0
    critical_count: int = 0
    high_count: int = 0
    medium_count: int = 0
    low_count: int = 0
    info_count: int = 0
    
    # Risk metrics
    overall_risk_score: float = 0.0
    risk_rating: str = "medium"
    
    # Metadata
    generated_at: datetime = field(default_factory=datetime.now)
    generated_by: str = ""
    file_path: str = ""
    file_size: int = 0
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "report_id": self.report_id,
            "engagement_id": self.engagement_id,
            "title": self.title,
            "format": self.format.value,
            "total_findings": self.total_findings,
            "overall_risk_score": self.overall_risk_score,
            "generated_at": self.generated_at.isoformat()
        }


class PentestReportEngine:
    """Penetration Testing Report Generator Engine"""
    
    def __init__(self, db_path: str = "pentest_reports.db"):
        self.db_path = db_path
        self.logger = logging.getLogger("PentestReportEngine")
        self.engagements: Dict[str, Engagement] = {}
        self.templates: Dict[str, ReportTemplate] = {}
        self.generated_reports: Dict[str, GeneratedReport] = {}
        
        # Initialize database and templates
        self._init_database()
        self._init_default_templates()
    
    def _init_database(self):
        """Initialize SQLite database"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Engagements table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS engagements (
                engagement_id TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                client TEXT NOT NULL,
                scope_type TEXT,
                start_date TIMESTAMP,
                end_date TIMESTAMP,
                lead_tester TEXT,
                team_members TEXT,
                methodology TEXT,
                testing_type TEXT,
                status TEXT,
                current_phase TEXT,
                in_scope_targets TEXT,
                out_of_scope_targets TEXT,
                compliance_frameworks TEXT,
                created_at TIMESTAMP
            )
        """)
        
        # Findings table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS findings (
                finding_id TEXT PRIMARY KEY,
                engagement_id TEXT NOT NULL,
                title TEXT NOT NULL,
                description TEXT,
                severity TEXT NOT NULL,
                vulnerability_type TEXT,
                affected_asset TEXT,
                affected_component TEXT,
                cvss_score REAL,
                cvss_vector TEXT,
                cve_ids TEXT,
                cwe_ids TEXT,
                business_impact TEXT,
                technical_impact TEXT,
                likelihood TEXT,
                exploitability TEXT,
                proof_of_concept TEXT,
                evidence TEXT,
                screenshots TEXT,
                recommendation TEXT,
                remediation_steps TEXT,
                "references" TEXT,
                owasp_category TEXT,
                pci_requirement TEXT,
                nist_control TEXT,
                mitre_technique TEXT,
                status TEXT,
                discovered_date TIMESTAMP,
                discovered_by TEXT,
                verified_date TIMESTAMP,
                remediated_date TIMESTAMP,
                FOREIGN KEY (engagement_id) REFERENCES engagements(engagement_id)
            )
        """)
        
        # Templates table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS report_templates (
                template_id TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                report_type TEXT NOT NULL,
                sections TEXT,
                include_executive_summary INTEGER,
                include_methodology INTEGER,
                include_findings INTEGER,
                include_remediation INTEGER,
                logo_path TEXT,
                header_text TEXT,
                footer_text TEXT,
                color_scheme TEXT,
                company_name TEXT,
                custom_sections TEXT,
                created_at TIMESTAMP
            )
        """)
        
        # Generated reports table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS generated_reports (
                report_id TEXT PRIMARY KEY,
                engagement_id TEXT NOT NULL,
                template_id TEXT NOT NULL,
                title TEXT NOT NULL,
                format TEXT,
                content TEXT,
                total_findings INTEGER,
                critical_count INTEGER,
                high_count INTEGER,
                medium_count INTEGER,
                low_count INTEGER,
                info_count INTEGER,
                overall_risk_score REAL,
                risk_rating TEXT,
                file_path TEXT,
                file_size INTEGER,
                generated_at TIMESTAMP,
                generated_by TEXT,
                FOREIGN KEY (engagement_id) REFERENCES engagements(engagement_id)
            )
        """)
        
        # Create indexes
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_findings_engagement ON findings(engagement_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_findings_severity ON findings(severity)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_reports_engagement ON generated_reports(engagement_id)")
        
        conn.commit()
        conn.close()
    
    def _init_default_templates(self):
        """Initialize default report templates"""
        # Executive Summary Template
        self.templates["exec_summary"] = ReportTemplate(
            template_id="exec_summary",
            name="Executive Summary",
            report_type=ReportType.EXECUTIVE_SUMMARY,
            sections=[
                "Cover Page", "Executive Summary", "Key Findings Overview",
                "Risk Rating", "Recommendations Summary", "Next Steps"
            ],
            include_methodology=False,
            include_appendix=False
        )
        
        # Full Technical Report Template
        self.templates["full_technical"] = ReportTemplate(
            template_id="full_technical",
            name="Full Technical Report",
            report_type=ReportType.TECHNICAL_REPORT,
            sections=[
                "Cover Page", "Table of Contents", "Executive Summary",
                "Engagement Overview", "Methodology", "Testing Scope",
                "Tools Used", "Findings Summary", "Detailed Findings",
                "Risk Assessment", "Remediation Roadmap", "Appendix A: Raw Data",
                "Appendix B: Screenshots", "Appendix C: References"
            ]
        )
        
        # OWASP Report Template
        self.templates["owasp"] = ReportTemplate(
            template_id="owasp",
            name="OWASP Top 10 Report",
            report_type=ReportType.COMPLIANCE_REPORT,
            sections=[
                "Cover Page", "Executive Summary", "OWASP Top 10 Overview",
                "A01: Broken Access Control", "A02: Cryptographic Failures",
                "A03: Injection", "A04: Insecure Design",
                "A05: Security Misconfiguration", "A06: Vulnerable Components",
                "A07: Authentication Failures", "A08: Integrity Failures",
                "A09: Logging Failures", "A10: SSRF",
                "Remediation Priorities", "Appendix"
            ]
        )
        
        # PCI-DSS Report Template
        self.templates["pci_dss"] = ReportTemplate(
            template_id="pci_dss",
            name="PCI-DSS Assessment Report",
            report_type=ReportType.COMPLIANCE_REPORT,
            sections=[
                "Cover Page", "Executive Summary", "Scope of Assessment",
                "Requirement 1: Firewall Configuration",
                "Requirement 2: Default Passwords",
                "Requirement 3: Cardholder Data Protection",
                "Requirement 4: Transmission Encryption",
                "Requirement 5: Anti-virus",
                "Requirement 6: Secure Development",
                "Requirement 7: Access Control",
                "Requirement 8: Authentication",
                "Requirement 9: Physical Security",
                "Requirement 10: Logging and Monitoring",
                "Requirement 11: Security Testing",
                "Requirement 12: Security Policies",
                "Compliance Summary", "Remediation Plan"
            ]
        )
        
        # Red Team Report Template
        self.templates["red_team"] = ReportTemplate(
            template_id="red_team",
            name="Red Team Assessment Report",
            report_type=ReportType.RED_TEAM_REPORT,
            sections=[
                "Cover Page", "Executive Summary", "Campaign Overview",
                "Attack Narrative", "Kill Chain Analysis",
                "Initial Access", "Execution", "Persistence",
                "Privilege Escalation", "Defense Evasion",
                "Credential Access", "Discovery", "Lateral Movement",
                "Collection", "Exfiltration", "Impact",
                "Detection Gaps", "Security Control Effectiveness",
                "Recommendations", "MITRE ATT&CK Mapping"
            ]
        )
    
    async def create_engagement(self, engagement: Engagement) -> Engagement:
        """Create a new penetration testing engagement"""
        engagement.created_at = datetime.now()
        self.engagements[engagement.engagement_id] = engagement
        
        # Save to database
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            INSERT INTO engagements (
                engagement_id, name, client, scope_type, start_date, end_date,
                lead_tester, team_members, methodology, testing_type, status,
                current_phase, in_scope_targets, out_of_scope_targets,
                compliance_frameworks, created_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            engagement.engagement_id, engagement.name, engagement.client,
            engagement.scope_type, engagement.start_date.isoformat(),
            engagement.end_date.isoformat() if engagement.end_date else None,
            engagement.lead_tester, json.dumps(engagement.team_members),
            engagement.methodology, engagement.testing_type, engagement.status,
            engagement.current_phase.value, json.dumps(engagement.in_scope_targets),
            json.dumps(engagement.out_of_scope_targets),
            json.dumps(engagement.compliance_frameworks), engagement.created_at.isoformat()
        ))
        
        conn.commit()
        conn.close()
        
        self.logger.info(f"Created engagement: {engagement.name}")
        return engagement
    
    async def add_finding(self, engagement_id: str, finding: Finding) -> Finding:
        """Add a finding to an engagement"""
        if engagement_id not in self.engagements:
            raise ValueError(f"Engagement {engagement_id} not found")
        
        finding.discovered_date = datetime.now()
        self.engagements[engagement_id].findings.append(finding)
        
        # Save to database
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            INSERT INTO findings (
                finding_id, engagement_id, title, description, severity,
                vulnerability_type, affected_asset, affected_component,
                cvss_score, cvss_vector, cve_ids, cwe_ids, business_impact,
                technical_impact, likelihood, exploitability, proof_of_concept,
                evidence, screenshots, recommendation, remediation_steps,
                "references", owasp_category, pci_requirement, nist_control,
                mitre_technique, status, discovered_date, discovered_by
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            finding.finding_id, engagement_id, finding.title, finding.description,
            finding.severity.value, finding.vulnerability_type, finding.affected_asset,
            finding.affected_component, finding.cvss_score, finding.cvss_vector,
            json.dumps(finding.cve_ids), json.dumps(finding.cwe_ids),
            finding.business_impact, finding.technical_impact, finding.likelihood,
            finding.exploitability, finding.proof_of_concept,
            json.dumps(finding.evidence), json.dumps(finding.screenshots),
            finding.recommendation, json.dumps(finding.remediation_steps),
            json.dumps(finding.references), finding.owasp_category,
            finding.pci_requirement, finding.nist_control, finding.mitre_technique,
            finding.status, finding.discovered_date.isoformat(), finding.discovered_by
        ))
        
        conn.commit()
        conn.close()
        
        return finding
    
    async def generate_report(self, engagement_id: str, template_id: str,
                             format: ReportFormat = ReportFormat.HTML,
                             generated_by: str = "system") -> GeneratedReport:
        """Generate a report for an engagement"""
        if engagement_id not in self.engagements:
            raise ValueError(f"Engagement {engagement_id} not found")
        
        if template_id not in self.templates:
            raise ValueError(f"Template {template_id} not found")
        
        engagement = self.engagements[engagement_id]
        template = self.templates[template_id]
        
        report_id = hashlib.sha256(
            f"{engagement_id}{template_id}{datetime.now().isoformat()}".encode()
        ).hexdigest()[:16]
        
        # Count findings by severity
        severity_counts = {
            SeverityLevel.CRITICAL: 0,
            SeverityLevel.HIGH: 0,
            SeverityLevel.MEDIUM: 0,
            SeverityLevel.LOW: 0,
            SeverityLevel.INFORMATIONAL: 0
        }
        
        for finding in engagement.findings:
            severity_counts[finding.severity] += 1
        
        # Calculate risk score
        risk_score = (
            severity_counts[SeverityLevel.CRITICAL] * 10 +
            severity_counts[SeverityLevel.HIGH] * 7 +
            severity_counts[SeverityLevel.MEDIUM] * 4 +
            severity_counts[SeverityLevel.LOW] * 1
        )
        
        # Normalize risk score (0-10)
        max_possible = len(engagement.findings) * 10 if engagement.findings else 1
        normalized_score = min(risk_score / max_possible * 10, 10) if max_possible > 0 else 0
        
        # Determine risk rating
        if normalized_score >= 8:
            risk_rating = "critical"
        elif normalized_score >= 6:
            risk_rating = "high"
        elif normalized_score >= 4:
            risk_rating = "medium"
        elif normalized_score >= 2:
            risk_rating = "low"
        else:
            risk_rating = "minimal"
        
        # Generate content based on format
        content = await self._generate_content(engagement, template, format)
        
        report = GeneratedReport(
            report_id=report_id,
            engagement_id=engagement_id,
            template_id=template_id,
            title=f"{engagement.name} - {template.name}",
            content=content,
            format=format,
            total_findings=len(engagement.findings),
            critical_count=severity_counts[SeverityLevel.CRITICAL],
            high_count=severity_counts[SeverityLevel.HIGH],
            medium_count=severity_counts[SeverityLevel.MEDIUM],
            low_count=severity_counts[SeverityLevel.LOW],
            info_count=severity_counts[SeverityLevel.INFORMATIONAL],
            overall_risk_score=normalized_score,
            risk_rating=risk_rating,
            generated_by=generated_by
        )
        
        self.generated_reports[report_id] = report
        
        # Save to database
        await self._save_report_to_db(report)
        
        self.logger.info(f"Generated report: {report.title}")
        return report
    
    async def _generate_content(self, engagement: Engagement, template: ReportTemplate,
                                format: ReportFormat) -> str:
        """Generate report content"""
        if format == ReportFormat.HTML:
            return await self._generate_html_report(engagement, template)
        elif format == ReportFormat.MARKDOWN:
            return await self._generate_markdown_report(engagement, template)
        elif format == ReportFormat.JSON:
            return await self._generate_json_report(engagement, template)
        else:
            return await self._generate_html_report(engagement, template)
    
    async def _generate_html_report(self, engagement: Engagement, template: ReportTemplate) -> str:
        """Generate HTML report content"""
        html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{engagement.name} - Security Assessment Report</title>
    <style>
        body {{ font-family: {template.font_family}, sans-serif; margin: 40px; color: #333; }}
        .header {{ background: #1a1a2e; color: white; padding: 30px; border-radius: 8px; }}
        .header h1 {{ margin: 0; color: #00d4ff; }}
        .section {{ margin: 30px 0; }}
        .section h2 {{ color: #1a1a2e; border-bottom: 2px solid #00d4ff; padding-bottom: 10px; }}
        .finding {{ background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0; border-left: 4px solid #ccc; }}
        .finding.critical {{ border-left-color: #dc3545; }}
        .finding.high {{ border-left-color: #fd7e14; }}
        .finding.medium {{ border-left-color: #ffc107; }}
        .finding.low {{ border-left-color: #17a2b8; }}
        .finding.informational {{ border-left-color: #6c757d; }}
        .severity {{ display: inline-block; padding: 4px 12px; border-radius: 4px; color: white; font-weight: bold; }}
        .severity.critical {{ background: #dc3545; }}
        .severity.high {{ background: #fd7e14; }}
        .severity.medium {{ background: #ffc107; color: #333; }}
        .severity.low {{ background: #17a2b8; }}
        .severity.informational {{ background: #6c757d; }}
        .stats {{ display: flex; gap: 20px; margin: 20px 0; }}
        .stat-card {{ background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; flex: 1; }}
        .stat-value {{ font-size: 36px; font-weight: bold; color: #1a1a2e; }}
        .stat-label {{ color: #666; margin-top: 8px; }}
        table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}
        th, td {{ padding: 12px; text-align: left; border: 1px solid #ddd; }}
        th {{ background: #1a1a2e; color: white; }}
        tr:nth-child(even) {{ background: #f8f9fa; }}
        .risk-matrix {{ display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; max-width: 500px; }}
        .risk-cell {{ padding: 10px; text-align: center; color: white; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ”’ {engagement.name}</h1>
        <p>Security Assessment Report</p>
        <p>Client: {engagement.client} | Date: {engagement.start_date.strftime('%B %d, %Y')}</p>
    </div>
"""
        
        # Executive Summary
        if template.include_executive_summary:
            critical_count = sum(1 for f in engagement.findings if f.severity == SeverityLevel.CRITICAL)
            high_count = sum(1 for f in engagement.findings if f.severity == SeverityLevel.HIGH)
            
            html += f"""
    <div class="section">
        <h2>Executive Summary</h2>
        <p>This report presents the findings from the security assessment conducted on {engagement.client}'s 
        infrastructure. The assessment was performed from {engagement.start_date.strftime('%B %d, %Y')} 
        and identified <strong>{len(engagement.findings)}</strong> security findings.</p>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" style="color: #dc3545;">{critical_count}</div>
                <div class="stat-label">Critical</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #fd7e14;">{high_count}</div>
                <div class="stat-label">High</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #ffc107;">{sum(1 for f in engagement.findings if f.severity == SeverityLevel.MEDIUM)}</div>
                <div class="stat-label">Medium</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #17a2b8;">{sum(1 for f in engagement.findings if f.severity == SeverityLevel.LOW)}</div>
                <div class="stat-label">Low</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(engagement.findings)}</div>
                <div class="stat-label">Total</div>
            </div>
        </div>
    </div>
"""
        
        # Methodology
        if template.include_methodology:
            html += f"""
    <div class="section">
        <h2>Methodology</h2>
        <p>The assessment was conducted following the <strong>{engagement.methodology.upper()}</strong> methodology 
        using a <strong>{engagement.testing_type.replace('_', ' ').title()}</strong> testing approach.</p>
        
        <h3>Scope</h3>
        <p><strong>In-Scope Targets:</strong></p>
        <ul>
            {''.join(f'<li>{target}</li>' for target in engagement.in_scope_targets)}
        </ul>
        
        <h3>Testing Team</h3>
        <p><strong>Lead Tester:</strong> {engagement.lead_tester}</p>
        <p><strong>Team Members:</strong> {', '.join(engagement.team_members) if engagement.team_members else 'N/A'}</p>
    </div>
"""
        
        # Findings
        if template.include_findings:
            html += """
    <div class="section">
        <h2>Detailed Findings</h2>
"""
            # Sort by severity
            sorted_findings = sorted(engagement.findings, 
                                    key=lambda f: list(SeverityLevel).index(f.severity))
            
            for finding in sorted_findings:
                html += f"""
        <div class="finding {finding.severity.value}">
            <h3>{finding.title}</h3>
            <span class="severity {finding.severity.value}">{finding.severity.value.upper()}</span>
            {f'<span style="margin-left: 10px;">CVSS: {finding.cvss_score}</span>' if finding.cvss_score > 0 else ''}
            
            <h4>Description</h4>
            <p>{finding.description}</p>
            
            <h4>Affected Asset</h4>
            <p>{finding.affected_asset}</p>
            
            <h4>Business Impact</h4>
            <p>{finding.business_impact}</p>
            
            <h4>Recommendation</h4>
            <p>{finding.recommendation}</p>
            
            {f'<h4>Proof of Concept</h4><pre>{finding.proof_of_concept}</pre>' if finding.proof_of_concept else ''}
            
            {f'<p><strong>OWASP Category:</strong> {finding.owasp_category}</p>' if finding.owasp_category else ''}
            {f'<p><strong>MITRE ATT&CK:</strong> {finding.mitre_technique}</p>' if finding.mitre_technique else ''}
        </div>
"""
            
            html += """
    </div>
"""
        
        # Remediation
        if template.include_remediation:
            html += """
    <div class="section">
        <h2>Remediation Priorities</h2>
        <table>
            <tr>
                <th>Priority</th>
                <th>Finding</th>
                <th>Severity</th>
                <th>Effort</th>
            </tr>
"""
            for i, finding in enumerate(sorted(engagement.findings, 
                                              key=lambda f: list(SeverityLevel).index(f.severity)), 1):
                html += f"""
            <tr>
                <td>{i}</td>
                <td>{finding.title}</td>
                <td><span class="severity {finding.severity.value}">{finding.severity.value.upper()}</span></td>
                <td>{finding.remediation_effort.title()}</td>
            </tr>
"""
            
            html += """
        </table>
    </div>
"""
        
        html += f"""
    <div class="section" style="text-align: center; color: #666; font-size: 12px;">
        <p>Report generated on {datetime.now().strftime('%B %d, %Y at %H:%M:%S')}</p>
        <p>{template.footer_text}</p>
    </div>
</body>
</html>
"""
        
        return html
    
    async def _generate_markdown_report(self, engagement: Engagement, template: ReportTemplate) -> str:
        """Generate Markdown report content"""
        md = f"""# ðŸ”’ {engagement.name}
## Security Assessment Report

**Client:** {engagement.client}  
**Date:** {engagement.start_date.strftime('%B %d, %Y')}  
**Lead Tester:** {engagement.lead_tester}

---

## Executive Summary

This security assessment identified **{len(engagement.findings)}** findings:

| Severity | Count |
|----------|-------|
| ðŸ”´ Critical | {sum(1 for f in engagement.findings if f.severity == SeverityLevel.CRITICAL)} |
| ðŸŸ  High | {sum(1 for f in engagement.findings if f.severity == SeverityLevel.HIGH)} |
| ðŸŸ¡ Medium | {sum(1 for f in engagement.findings if f.severity == SeverityLevel.MEDIUM)} |
| ðŸ”µ Low | {sum(1 for f in engagement.findings if f.severity == SeverityLevel.LOW)} |
| âšª Info | {sum(1 for f in engagement.findings if f.severity == SeverityLevel.INFORMATIONAL)} |

---

## Detailed Findings

"""
        
        for i, finding in enumerate(engagement.findings, 1):
            severity_emoji = {
                SeverityLevel.CRITICAL: "ðŸ”´",
                SeverityLevel.HIGH: "ðŸŸ ",
                SeverityLevel.MEDIUM: "ðŸŸ¡",
                SeverityLevel.LOW: "ðŸ”µ",
                SeverityLevel.INFORMATIONAL: "âšª"
            }
            
            md += f"""### {i}. {finding.title}

{severity_emoji[finding.severity]} **Severity:** {finding.severity.value.upper()}  
**Affected Asset:** {finding.affected_asset}  
{f'**CVSS Score:** {finding.cvss_score}' if finding.cvss_score > 0 else ''}

#### Description
{finding.description}

#### Business Impact
{finding.business_impact}

#### Recommendation
{finding.recommendation}

{f'#### Proof of Concept\n```\n{finding.proof_of_concept}\n```' if finding.proof_of_concept else ''}

---

"""
        
        md += f"""
## Remediation Roadmap

| Priority | Finding | Severity | Effort |
|----------|---------|----------|--------|
"""
        
        for i, finding in enumerate(sorted(engagement.findings, 
                                          key=lambda f: list(SeverityLevel).index(f.severity)), 1):
            md += f"| {i} | {finding.title} | {finding.severity.value.upper()} | {finding.remediation_effort} |\n"
        
        md += f"""

---

*Report generated on {datetime.now().strftime('%B %d, %Y at %H:%M:%S')}*
"""
        
        return md
    
    async def _generate_json_report(self, engagement: Engagement, template: ReportTemplate) -> str:
        """Generate JSON report content"""
        report_data = {
            "report_metadata": {
                "title": f"{engagement.name} - Security Assessment Report",
                "generated_at": datetime.now().isoformat(),
                "template": template.name
            },
            "engagement": {
                "id": engagement.engagement_id,
                "name": engagement.name,
                "client": engagement.client,
                "scope_type": engagement.scope_type,
                "start_date": engagement.start_date.isoformat(),
                "methodology": engagement.methodology,
                "testing_type": engagement.testing_type,
                "lead_tester": engagement.lead_tester,
                "in_scope_targets": engagement.in_scope_targets
            },
            "summary": {
                "total_findings": len(engagement.findings),
                "by_severity": {
                    "critical": sum(1 for f in engagement.findings if f.severity == SeverityLevel.CRITICAL),
                    "high": sum(1 for f in engagement.findings if f.severity == SeverityLevel.HIGH),
                    "medium": sum(1 for f in engagement.findings if f.severity == SeverityLevel.MEDIUM),
                    "low": sum(1 for f in engagement.findings if f.severity == SeverityLevel.LOW),
                    "informational": sum(1 for f in engagement.findings if f.severity == SeverityLevel.INFORMATIONAL)
                }
            },
            "findings": [finding.to_dict() for finding in engagement.findings]
        }
        
        return json.dumps(report_data, indent=2)
    
    async def _save_report_to_db(self, report: GeneratedReport):
        """Save generated report to database"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            INSERT INTO generated_reports (
                report_id, engagement_id, template_id, title, format, content,
                total_findings, critical_count, high_count, medium_count,
                low_count, info_count, overall_risk_score, risk_rating,
                file_path, file_size, generated_at, generated_by
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            report.report_id, report.engagement_id, report.template_id,
            report.title, report.format.value, report.content,
            report.total_findings, report.critical_count, report.high_count,
            report.medium_count, report.low_count, report.info_count,
            report.overall_risk_score, report.risk_rating, report.file_path,
            report.file_size, report.generated_at.isoformat(), report.generated_by
        ))
        
        conn.commit()
        conn.close()
    
    async def get_engagement_statistics(self, engagement_id: str) -> Dict[str, Any]:
        """Get statistics for an engagement"""
        if engagement_id not in self.engagements:
            return {}
        
        engagement = self.engagements[engagement_id]
        
        # Severity distribution
        severity_dist = {}
        for severity in SeverityLevel:
            severity_dist[severity.value] = sum(
                1 for f in engagement.findings if f.severity == severity
            )
        
        # OWASP categories
        owasp_dist = {}
        for finding in engagement.findings:
            if finding.owasp_category:
                owasp_dist[finding.owasp_category] = owasp_dist.get(finding.owasp_category, 0) + 1
        
        # Asset distribution
        asset_dist = {}
        for finding in engagement.findings:
            if finding.affected_asset:
                asset_dist[finding.affected_asset] = asset_dist.get(finding.affected_asset, 0) + 1
        
        # Calculate average CVSS
        cvss_scores = [f.cvss_score for f in engagement.findings if f.cvss_score > 0]
        avg_cvss = sum(cvss_scores) / len(cvss_scores) if cvss_scores else 0
        
        return {
            "engagement_id": engagement_id,
            "total_findings": len(engagement.findings),
            "severity_distribution": severity_dist,
            "owasp_distribution": owasp_dist,
            "asset_distribution": asset_dist,
            "average_cvss": round(avg_cvss, 1),
            "open_findings": sum(1 for f in engagement.findings if f.status == "open"),
            "remediated_findings": sum(1 for f in engagement.findings if f.status == "remediated")
        }
    
    async def export_findings_csv(self, engagement_id: str) -> str:
        """Export findings to CSV format"""
        if engagement_id not in self.engagements:
            return ""
        
        engagement = self.engagements[engagement_id]
        
        headers = [
            "Finding ID", "Title", "Severity", "CVSS", "Affected Asset",
            "Vulnerability Type", "Status", "OWASP Category", "Recommendation"
        ]
        
        csv_content = ",".join(headers) + "\n"
        
        for finding in engagement.findings:
            row = [
                finding.finding_id,
                f'"{finding.title}"',
                finding.severity.value,
                str(finding.cvss_score),
                f'"{finding.affected_asset}"',
                f'"{finding.vulnerability_type}"',
                finding.status,
                finding.owasp_category,
                f'"{finding.recommendation[:100]}..."' if len(finding.recommendation) > 100 else f'"{finding.recommendation}"'
            ]
            csv_content += ",".join(row) + "\n"
        
        return csv_content


# Create singleton instance
pentest_report_engine = PentestReportEngine()
