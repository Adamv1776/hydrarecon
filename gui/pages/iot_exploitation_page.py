"""
IoT Exploitation Page - Ultimate IoT Security Testing Interface
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QGridLayout,
    QLabel, QPushButton, QTableWidget, QTableWidgetItem,
    QTabWidget, QTextEdit, QLineEdit, QComboBox,
    QProgressBar, QFrame, QSplitter, QGroupBox,
    QFileDialog, QSpinBox, QCheckBox, QTreeWidget,
    QTreeWidgetItem, QHeaderView, QMessageBox
)
from PyQt6.QtCore import Qt, pyqtSignal, QThread
from PyQt6.QtGui import QFont, QColor
import asyncio
from datetime import datetime


class IoTWorker(QThread):
    """Worker thread for IoT operations"""
    finished = pyqtSignal(object)
    progress = pyqtSignal(str, object)
    error = pyqtSignal(str)
    
    def __init__(self, operation, *args, **kwargs):
        super().__init__()
        self.operation = operation
        self.args = args
        self.kwargs = kwargs
    
    def run(self):
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            result = loop.run_until_complete(self.operation(*self.args, **self.kwargs))
            self.finished.emit(result)
        except Exception as e:
            self.error.emit(str(e))
        finally:
            loop.close()


class IoTExploitationPage(QWidget):
    """IoT Exploitation Framework Interface"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.parent = parent
        self.iot_framework = None
        self.current_worker = None
        self.devices = {}
        
        self._init_framework()
        self._setup_ui()
    
    def _init_framework(self):
        """Initialize IoT framework"""
        try:
            from core.iot_exploitation import IoTExploitationFramework
            self.iot_framework = IoTExploitationFramework()
            self.iot_framework.add_callback(self._on_framework_event)
        except ImportError as e:
            print(f"IoT framework import error: {e}")
    
    def _on_framework_event(self, event: str, data):
        """Handle framework events"""
        pass
    
    def _setup_ui(self):
        """Setup the user interface"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        # Header
        header = self._create_header()
        layout.addWidget(header)
        
        # Main content with tabs
        tabs = QTabWidget()
        tabs.setStyleSheet("""
            QTabWidget::pane {
                border: 1px solid #3a3a4a;
                background: #1a1a2e;
                border-radius: 8px;
            }
            QTabBar::tab {
                background: #252535;
                color: #8888aa;
                padding: 10px 20px;
                margin-right: 2px;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            QTabBar::tab:selected {
                background: #1a1a2e;
                color: #00d4ff;
            }
        """)
        
        tabs.addTab(self._create_discovery_tab(), "üì° Discovery")
        tabs.addTab(self._create_devices_tab(), "üîå Devices")
        tabs.addTab(self._create_firmware_tab(), "üíæ Firmware")
        tabs.addTab(self._create_exploits_tab(), "üíÄ Exploits")
        tabs.addTab(self._create_fuzzing_tab(), "üîÄ Fuzzing")
        
        layout.addWidget(tabs)
    
    def _create_header(self) -> QFrame:
        """Create header section"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #1a1a2e, stop:1 #252545);
                border-radius: 15px;
                padding: 15px;
            }
        """)
        
        layout = QHBoxLayout(frame)
        
        # Title
        title_layout = QVBoxLayout()
        title = QLabel("üîå IoT EXPLOITATION FRAMEWORK")
        title.setFont(QFont("Consolas", 24, QFont.Weight.Bold))
        title.setStyleSheet("color: #00ff88;")
        title_layout.addWidget(title)
        
        subtitle = QLabel("Smart Device Security Testing Platform")
        subtitle.setStyleSheet("color: #8888aa; font-size: 12px;")
        title_layout.addWidget(subtitle)
        
        layout.addLayout(title_layout)
        layout.addStretch()
        
        # Stats
        stats_layout = QHBoxLayout()
        stats_layout.setSpacing(30)
        
        self.device_count = self._create_stat("Devices", "0")
        self.vuln_count = self._create_stat("Vulns", "0")
        self.exploit_count = self._create_stat("Exploits", "7")
        
        stats_layout.addWidget(self.device_count)
        stats_layout.addWidget(self.vuln_count)
        stats_layout.addWidget(self.exploit_count)
        
        layout.addLayout(stats_layout)
        
        return frame
    
    def _create_stat(self, label: str, value: str) -> QFrame:
        """Create stat display"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background: rgba(0, 212, 255, 0.1);
                border: 1px solid #00d4ff;
                border-radius: 10px;
                padding: 10px;
            }
        """)
        
        layout = QVBoxLayout(frame)
        layout.setContentsMargins(15, 10, 15, 10)
        
        value_label = QLabel(value)
        value_label.setFont(QFont("Consolas", 20, QFont.Weight.Bold))
        value_label.setStyleSheet("color: #00d4ff;")
        value_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        value_label.setObjectName(f"stat_{label.lower()}")
        layout.addWidget(value_label)
        
        name_label = QLabel(label)
        name_label.setStyleSheet("color: #8888aa; font-size: 11px;")
        name_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(name_label)
        
        return frame
    
    def _create_discovery_tab(self) -> QWidget:
        """Create device discovery tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        layout.setSpacing(15)
        
        # Discovery controls
        control_group = QGroupBox("Device Discovery")
        control_group.setStyleSheet("""
            QGroupBox {
                color: #00d4ff;
                font-weight: bold;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px;
            }
        """)
        control_layout = QGridLayout(control_group)
        
        # Network input
        control_layout.addWidget(QLabel("Target Network:"), 0, 0)
        self.network_input = QLineEdit()
        self.network_input.setPlaceholderText("192.168.1.0/24")
        self.network_input.setStyleSheet("""
            QLineEdit {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: #ffffff;
            }
        """)
        control_layout.addWidget(self.network_input, 0, 1)
        
        # Protocol selection
        control_layout.addWidget(QLabel("Protocols:"), 1, 0)
        self.protocol_combo = QComboBox()
        self.protocol_combo.addItems([
            "All Protocols",
            "MQTT",
            "CoAP",
            "Modbus",
            "RTSP/ONVIF",
            "UPnP",
            "Telnet/SSH",
        ])
        self.protocol_combo.setStyleSheet("""
            QComboBox {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: #ffffff;
            }
        """)
        control_layout.addWidget(self.protocol_combo, 1, 1)
        
        # Timeout
        control_layout.addWidget(QLabel("Timeout (s):"), 0, 2)
        self.timeout_spin = QSpinBox()
        self.timeout_spin.setRange(1, 60)
        self.timeout_spin.setValue(10)
        self.timeout_spin.setStyleSheet("""
            QSpinBox {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: #ffffff;
            }
        """)
        control_layout.addWidget(self.timeout_spin, 0, 3)
        
        # Scan button
        self.scan_btn = QPushButton("üîç Discover Devices")
        self.scan_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #00ff88, stop:1 #00d4ff);
                border: none;
                border-radius: 8px;
                padding: 12px 25px;
                color: #1a1a2e;
                font-weight: bold;
                font-size: 14px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #00ffaa, stop:1 #00e4ff);
            }
        """)
        self.scan_btn.clicked.connect(self._start_discovery)
        control_layout.addWidget(self.scan_btn, 1, 2, 1, 2)
        
        layout.addWidget(control_group)
        
        # Progress
        self.discovery_progress = QProgressBar()
        self.discovery_progress.setStyleSheet("""
            QProgressBar {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                text-align: center;
                color: white;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #00ff88, stop:1 #00d4ff);
                border-radius: 5px;
            }
        """)
        self.discovery_progress.setVisible(False)
        layout.addWidget(self.discovery_progress)
        
        # Results
        self.discovery_log = QTextEdit()
        self.discovery_log.setReadOnly(True)
        self.discovery_log.setStyleSheet("""
            QTextEdit {
                background: #0d0d1a;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
                color: #00ff88;
                font-family: Consolas, monospace;
                padding: 10px;
            }
        """)
        self.discovery_log.setPlaceholderText("Discovery results will appear here...")
        layout.addWidget(self.discovery_log)
        
        return widget
    
    def _create_devices_tab(self) -> QWidget:
        """Create devices management tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        layout.setSpacing(15)
        
        # Splitter for devices and details
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Device list
        device_frame = QFrame()
        device_frame.setStyleSheet("""
            QFrame {
                background: #1a1a2e;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
            }
        """)
        device_layout = QVBoxLayout(device_frame)
        
        device_header = QHBoxLayout()
        device_header.addWidget(QLabel("üîå Discovered Devices"))
        
        self.refresh_btn = QPushButton("üîÑ Refresh")
        self.refresh_btn.setStyleSheet("""
            QPushButton {
                background: #3a3a4a;
                border: none;
                border-radius: 5px;
                padding: 5px 15px;
                color: white;
            }
            QPushButton:hover { background: #4a4a5a; }
        """)
        device_header.addWidget(self.refresh_btn)
        device_layout.addLayout(device_header)
        
        self.device_tree = QTreeWidget()
        self.device_tree.setHeaderLabels(["Device", "IP", "Type", "Risk"])
        self.device_tree.setStyleSheet("""
            QTreeWidget {
                background: #0d0d1a;
                border: none;
                color: white;
            }
            QTreeWidget::item:selected {
                background: rgba(0, 212, 255, 0.3);
            }
        """)
        self.device_tree.itemClicked.connect(self._on_device_selected)
        device_layout.addWidget(self.device_tree)
        
        splitter.addWidget(device_frame)
        
        # Device details
        details_frame = QFrame()
        details_frame.setStyleSheet("""
            QFrame {
                background: #1a1a2e;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
            }
        """)
        details_layout = QVBoxLayout(details_frame)
        details_layout.addWidget(QLabel("üìã Device Details"))
        
        self.device_details = QTextEdit()
        self.device_details.setReadOnly(True)
        self.device_details.setStyleSheet("""
            QTextEdit {
                background: #0d0d1a;
                border: none;
                color: #00d4ff;
                font-family: Consolas, monospace;
            }
        """)
        details_layout.addWidget(self.device_details)
        
        # Action buttons
        action_layout = QHBoxLayout()
        
        self.scan_vulns_btn = QPushButton("üîç Scan Vulns")
        self.scan_vulns_btn.setStyleSheet("""
            QPushButton {
                background: #ff6b00;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                color: white;
                font-weight: bold;
            }
            QPushButton:hover { background: #ff8800; }
        """)
        self.scan_vulns_btn.clicked.connect(self._scan_device_vulns)
        action_layout.addWidget(self.scan_vulns_btn)
        
        self.exploit_btn = QPushButton("üíÄ Exploit")
        self.exploit_btn.setStyleSheet("""
            QPushButton {
                background: #ff0055;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                color: white;
                font-weight: bold;
            }
            QPushButton:hover { background: #ff2277; }
        """)
        self.exploit_btn.clicked.connect(self._show_exploits)
        action_layout.addWidget(self.exploit_btn)
        
        details_layout.addLayout(action_layout)
        
        splitter.addWidget(details_frame)
        splitter.setSizes([400, 400])
        
        layout.addWidget(splitter)
        
        return widget
    
    def _create_firmware_tab(self) -> QWidget:
        """Create firmware analysis tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        layout.setSpacing(15)
        
        # Firmware upload
        upload_group = QGroupBox("Firmware Analysis")
        upload_group.setStyleSheet("""
            QGroupBox {
                color: #00d4ff;
                font-weight: bold;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
            }
        """)
        upload_layout = QHBoxLayout(upload_group)
        
        self.firmware_path = QLineEdit()
        self.firmware_path.setPlaceholderText("Select firmware file...")
        self.firmware_path.setStyleSheet("""
            QLineEdit {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: white;
            }
        """)
        upload_layout.addWidget(self.firmware_path)
        
        browse_btn = QPushButton("üìÅ Browse")
        browse_btn.setStyleSheet("""
            QPushButton {
                background: #3a3a4a;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                color: white;
            }
            QPushButton:hover { background: #4a4a5a; }
        """)
        browse_btn.clicked.connect(self._browse_firmware)
        upload_layout.addWidget(browse_btn)
        
        self.analyze_btn = QPushButton("üî¨ Analyze")
        self.analyze_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #ff00ff, stop:1 #00d4ff);
                border: none;
                border-radius: 5px;
                padding: 8px 20px;
                color: white;
                font-weight: bold;
            }
        """)
        self.analyze_btn.clicked.connect(self._analyze_firmware)
        upload_layout.addWidget(self.analyze_btn)
        
        layout.addWidget(upload_group)
        
        # Analysis results
        results_splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Extracted data
        extract_frame = QFrame()
        extract_frame.setStyleSheet("""
            QFrame {
                background: #1a1a2e;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
            }
        """)
        extract_layout = QVBoxLayout(extract_frame)
        extract_layout.addWidget(QLabel("üì¶ Extracted Data"))
        
        self.extract_tree = QTreeWidget()
        self.extract_tree.setHeaderLabels(["Type", "Value", "Severity"])
        self.extract_tree.setStyleSheet("""
            QTreeWidget {
                background: #0d0d1a;
                border: none;
                color: white;
            }
        """)
        extract_layout.addWidget(self.extract_tree)
        results_splitter.addWidget(extract_frame)
        
        # Secrets found
        secrets_frame = QFrame()
        secrets_frame.setStyleSheet("""
            QFrame {
                background: #1a1a2e;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
            }
        """)
        secrets_layout = QVBoxLayout(secrets_frame)
        secrets_layout.addWidget(QLabel("üîë Secrets & Backdoors"))
        
        self.secrets_table = QTableWidget()
        self.secrets_table.setColumnCount(3)
        self.secrets_table.setHorizontalHeaderLabels(["Type", "Value", "Location"])
        self.secrets_table.horizontalHeader().setStretchLastSection(True)
        self.secrets_table.setStyleSheet("""
            QTableWidget {
                background: #0d0d1a;
                border: none;
                color: white;
                gridline-color: #3a3a4a;
            }
            QHeaderView::section {
                background: #252535;
                color: #00d4ff;
                padding: 8px;
                border: none;
            }
        """)
        secrets_layout.addWidget(self.secrets_table)
        results_splitter.addWidget(secrets_frame)
        
        layout.addWidget(results_splitter)
        
        return widget
    
    def _create_exploits_tab(self) -> QWidget:
        """Create exploits tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        layout.setSpacing(15)
        
        # Available exploits
        exploits_group = QGroupBox("Available Exploits")
        exploits_group.setStyleSheet("""
            QGroupBox {
                color: #ff0055;
                font-weight: bold;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
            }
        """)
        exploits_layout = QVBoxLayout(exploits_group)
        
        self.exploits_table = QTableWidget()
        self.exploits_table.setColumnCount(4)
        self.exploits_table.setHorizontalHeaderLabels(["Exploit", "Protocol", "Description", "Status"])
        self.exploits_table.horizontalHeader().setStretchLastSection(True)
        self.exploits_table.setStyleSheet("""
            QTableWidget {
                background: #0d0d1a;
                border: none;
                color: white;
                gridline-color: #3a3a4a;
            }
            QHeaderView::section {
                background: #252535;
                color: #ff0055;
                padding: 8px;
                border: none;
            }
        """)
        
        # Populate exploits
        exploits = [
            ("Telnet Brute Force", "Telnet", "Brute force Telnet credentials", "Ready"),
            ("SSH Brute Force", "SSH", "Brute force SSH credentials", "Ready"),
            ("MQTT Anonymous", "MQTT", "Exploit anonymous MQTT access", "Ready"),
            ("UPnP SOAP Injection", "UPnP", "Command injection via UPnP", "Ready"),
            ("RTSP Buffer Overflow", "RTSP", "RTSP protocol overflow", "Ready"),
            ("Camera Backdoor", "HTTP", "Known camera backdoors", "Ready"),
            ("Modbus Write", "Modbus", "Write to Modbus registers", "Ready"),
        ]
        
        self.exploits_table.setRowCount(len(exploits))
        for i, (name, proto, desc, status) in enumerate(exploits):
            self.exploits_table.setItem(i, 0, QTableWidgetItem(name))
            self.exploits_table.setItem(i, 1, QTableWidgetItem(proto))
            self.exploits_table.setItem(i, 2, QTableWidgetItem(desc))
            
            status_item = QTableWidgetItem(status)
            status_item.setForeground(QColor("#00ff88"))
            self.exploits_table.setItem(i, 3, status_item)
        
        exploits_layout.addWidget(self.exploits_table)
        
        # Exploit controls
        control_layout = QHBoxLayout()
        
        control_layout.addWidget(QLabel("Target Device:"))
        self.target_combo = QComboBox()
        self.target_combo.setStyleSheet("""
            QComboBox {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: white;
                min-width: 200px;
            }
        """)
        control_layout.addWidget(self.target_combo)
        
        self.run_exploit_btn = QPushButton("üíÄ Run Exploit")
        self.run_exploit_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #ff0055, stop:1 #ff6600);
                border: none;
                border-radius: 8px;
                padding: 10px 25px;
                color: white;
                font-weight: bold;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #ff2277, stop:1 #ff8822);
            }
        """)
        self.run_exploit_btn.clicked.connect(self._run_exploit)
        control_layout.addWidget(self.run_exploit_btn)
        
        exploits_layout.addLayout(control_layout)
        
        layout.addWidget(exploits_group)
        
        # Exploit output
        output_group = QGroupBox("Exploit Output")
        output_group.setStyleSheet("""
            QGroupBox {
                color: #00ff88;
                font-weight: bold;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
                margin-top: 10px;
            }
        """)
        output_layout = QVBoxLayout(output_group)
        
        self.exploit_output = QTextEdit()
        self.exploit_output.setReadOnly(True)
        self.exploit_output.setStyleSheet("""
            QTextEdit {
                background: #0d0d1a;
                border: none;
                color: #00ff88;
                font-family: Consolas, monospace;
            }
        """)
        output_layout.addWidget(self.exploit_output)
        
        layout.addWidget(output_group)
        
        return widget
    
    def _create_fuzzing_tab(self) -> QWidget:
        """Create protocol fuzzing tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        layout.setSpacing(15)
        
        # Fuzzing controls
        fuzz_group = QGroupBox("Protocol Fuzzing")
        fuzz_group.setStyleSheet("""
            QGroupBox {
                color: #ff00ff;
                font-weight: bold;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
            }
        """)
        fuzz_layout = QGridLayout(fuzz_group)
        
        # Target selection
        fuzz_layout.addWidget(QLabel("Target Device:"), 0, 0)
        self.fuzz_target_combo = QComboBox()
        self.fuzz_target_combo.setStyleSheet("""
            QComboBox {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: white;
            }
        """)
        fuzz_layout.addWidget(self.fuzz_target_combo, 0, 1)
        
        # Protocol selection
        fuzz_layout.addWidget(QLabel("Protocol:"), 0, 2)
        self.fuzz_protocol_combo = QComboBox()
        self.fuzz_protocol_combo.addItems([
            "MQTT", "Modbus", "RTSP", "CoAP", "Telnet"
        ])
        self.fuzz_protocol_combo.setStyleSheet("""
            QComboBox {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: white;
            }
        """)
        fuzz_layout.addWidget(self.fuzz_protocol_combo, 0, 3)
        
        # Iterations
        fuzz_layout.addWidget(QLabel("Iterations:"), 1, 0)
        self.fuzz_iterations = QSpinBox()
        self.fuzz_iterations.setRange(10, 10000)
        self.fuzz_iterations.setValue(100)
        self.fuzz_iterations.setStyleSheet("""
            QSpinBox {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                padding: 8px;
                color: white;
            }
        """)
        fuzz_layout.addWidget(self.fuzz_iterations, 1, 1)
        
        # Start fuzzing
        self.start_fuzz_btn = QPushButton("üîÄ Start Fuzzing")
        self.start_fuzz_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #ff00ff, stop:1 #00d4ff);
                border: none;
                border-radius: 8px;
                padding: 10px 25px;
                color: white;
                font-weight: bold;
            }
        """)
        self.start_fuzz_btn.clicked.connect(self._start_fuzzing)
        fuzz_layout.addWidget(self.start_fuzz_btn, 1, 2, 1, 2)
        
        layout.addWidget(fuzz_group)
        
        # Fuzzing progress
        self.fuzz_progress = QProgressBar()
        self.fuzz_progress.setStyleSheet("""
            QProgressBar {
                background: #252535;
                border: 1px solid #3a3a4a;
                border-radius: 5px;
                text-align: center;
                color: white;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #ff00ff, stop:1 #00d4ff);
                border-radius: 5px;
            }
        """)
        layout.addWidget(self.fuzz_progress)
        
        # Crash reports
        crash_group = QGroupBox("Crash Reports")
        crash_group.setStyleSheet("""
            QGroupBox {
                color: #ff0055;
                font-weight: bold;
                border: 1px solid #3a3a4a;
                border-radius: 8px;
            }
        """)
        crash_layout = QVBoxLayout(crash_group)
        
        self.crash_table = QTableWidget()
        self.crash_table.setColumnCount(4)
        self.crash_table.setHorizontalHeaderLabels(["Iteration", "Input", "Result", "Crash"])
        self.crash_table.horizontalHeader().setStretchLastSection(True)
        self.crash_table.setStyleSheet("""
            QTableWidget {
                background: #0d0d1a;
                border: none;
                color: white;
                gridline-color: #3a3a4a;
            }
            QHeaderView::section {
                background: #252535;
                color: #ff0055;
                padding: 8px;
                border: none;
            }
        """)
        crash_layout.addWidget(self.crash_table)
        
        layout.addWidget(crash_group)
        
        return widget
    
    def _start_discovery(self):
        """Start device discovery"""
        if not self.iot_framework:
            QMessageBox.warning(self, "Error", "IoT framework not initialized")
            return
        
        network = self.network_input.text().strip()
        if not network:
            network = "192.168.1.0/24"
            self.network_input.setText(network)
        
        self.discovery_progress.setVisible(True)
        self.discovery_progress.setRange(0, 0)
        self.scan_btn.setEnabled(False)
        
        self.discovery_log.append(f"[{datetime.now().strftime('%H:%M:%S')}] Starting discovery on {network}...")
        
        self.current_worker = IoTWorker(
            self.iot_framework.discover_devices,
            network,
            timeout=float(self.timeout_spin.value())
        )
        self.current_worker.finished.connect(self._on_discovery_complete)
        self.current_worker.error.connect(self._on_error)
        self.current_worker.start()
    
    def _on_discovery_complete(self, devices):
        """Handle discovery completion"""
        self.discovery_progress.setVisible(False)
        self.scan_btn.setEnabled(True)
        
        if devices:
            self.discovery_log.append(f"[{datetime.now().strftime('%H:%M:%S')}] Found {len(devices)} devices!")
            
            for device in devices:
                self.devices[device.id] = device
                self.discovery_log.append(
                    f"  üì° {device.ip_address} - {device.manufacturer} {device.model} "
                    f"({device.category.value})"
                )
                
                # Add to device tree
                item = QTreeWidgetItem([
                    f"{device.manufacturer} {device.model}",
                    device.ip_address,
                    device.category.value,
                    f"{device.risk_score:.1f}"
                ])
                self.device_tree.addTopLevelItem(item)
                
                # Add to target combos
                self.target_combo.addItem(f"{device.ip_address} ({device.manufacturer})", device.id)
                self.fuzz_target_combo.addItem(f"{device.ip_address}", device.id)
            
            # Update stats
            self.device_count.findChild(QLabel, "stat_devices").setText(str(len(self.devices)))
        else:
            self.discovery_log.append(f"[{datetime.now().strftime('%H:%M:%S')}] No devices found")
    
    def _on_error(self, error):
        """Handle error"""
        self.discovery_progress.setVisible(False)
        self.scan_btn.setEnabled(True)
        self.discovery_log.append(f"[ERROR] {error}")
    
    def _on_device_selected(self, item):
        """Handle device selection"""
        ip = item.text(1)
        
        # Find device by IP
        device = None
        for d in self.devices.values():
            if d.ip_address == ip:
                device = d
                break
        
        if device:
            details = f"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë         DEVICE INFORMATION           ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
  IP Address:    {device.ip_address}
  MAC Address:   {device.mac_address or 'Unknown'}
  Manufacturer:  {device.manufacturer}
  Model:         {device.model}
  Firmware:      {device.firmware_version}
  Category:      {device.category.value}
  Risk Score:    {device.risk_score:.1f}/10.0
  
  Open Ports:    {', '.join(map(str, device.open_ports))}
  Protocols:     {', '.join(p.value for p in device.protocols)}
  
  Vulnerabilities: {len(device.vulnerabilities)}
  Credentials:     {len(device.credentials)}
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"""
            self.device_details.setText(details)
    
    def _scan_device_vulns(self):
        """Scan selected device for vulnerabilities"""
        if not self.device_tree.currentItem():
            QMessageBox.warning(self, "Error", "Please select a device first")
            return
        
        ip = self.device_tree.currentItem().text(1)
        device_id = None
        for d in self.devices.values():
            if d.ip_address == ip:
                device_id = d.id
                break
        
        if device_id and self.iot_framework:
            self.current_worker = IoTWorker(
                self.iot_framework.scan_vulnerabilities,
                device_id
            )
            self.current_worker.finished.connect(self._on_vuln_scan_complete)
            self.current_worker.error.connect(self._on_error)
            self.current_worker.start()
    
    def _on_vuln_scan_complete(self, vulns):
        """Handle vulnerability scan completion"""
        if vulns:
            total_vulns = sum(len(d.vulnerabilities) for d in self.devices.values())
            self.vuln_count.findChild(QLabel, "stat_vulns").setText(str(total_vulns))
            
            QMessageBox.information(
                self, "Scan Complete",
                f"Found {len(vulns)} vulnerabilities!"
            )
    
    def _show_exploits(self):
        """Show available exploits for selected device"""
        pass
    
    def _browse_firmware(self):
        """Browse for firmware file"""
        path, _ = QFileDialog.getOpenFileName(
            self, "Select Firmware File",
            "", "Firmware Files (*.bin *.img *.fw *.rom);;All Files (*)"
        )
        if path:
            self.firmware_path.setText(path)
    
    def _analyze_firmware(self):
        """Analyze firmware file"""
        path = self.firmware_path.text().strip()
        if not path:
            QMessageBox.warning(self, "Error", "Please select a firmware file")
            return
        
        if self.iot_framework:
            self.current_worker = IoTWorker(
                self.iot_framework.analyze_firmware,
                path
            )
            self.current_worker.finished.connect(self._on_firmware_analyzed)
            self.current_worker.error.connect(self._on_error)
            self.current_worker.start()
    
    def _on_firmware_analyzed(self, analysis):
        """Handle firmware analysis completion"""
        # Populate extract tree
        self.extract_tree.clear()
        
        # Architecture info
        arch_item = QTreeWidgetItem(["Architecture", analysis.architecture, "INFO"])
        self.extract_tree.addTopLevelItem(arch_item)
        
        # Filesystem
        if "filesystem" in analysis.metadata:
            fs_item = QTreeWidgetItem(["Filesystem", analysis.metadata["filesystem"], "INFO"])
            self.extract_tree.addTopLevelItem(fs_item)
        
        # Vulnerabilities
        for vuln in analysis.vulnerabilities:
            vuln_item = QTreeWidgetItem([
                vuln.get("type", "Unknown"),
                vuln.get("description", ""),
                vuln.get("severity", "MEDIUM")
            ])
            self.extract_tree.addTopLevelItem(vuln_item)
        
        # Populate secrets table
        self.secrets_table.setRowCount(len(analysis.hardcoded_secrets) + len(analysis.backdoors))
        row = 0
        
        for secret in analysis.hardcoded_secrets:
            self.secrets_table.setItem(row, 0, QTableWidgetItem(secret.get("type", "")))
            self.secrets_table.setItem(row, 1, QTableWidgetItem(secret.get("value", "")[:50]))
            self.secrets_table.setItem(row, 2, QTableWidgetItem("Firmware"))
            row += 1
        
        for backdoor in analysis.backdoors:
            self.secrets_table.setItem(row, 0, QTableWidgetItem("Backdoor"))
            self.secrets_table.setItem(row, 1, QTableWidgetItem(backdoor.get("description", "")))
            self.secrets_table.setItem(row, 2, QTableWidgetItem(f"Offset: {backdoor.get('offset', 0)}"))
            row += 1
        
        QMessageBox.information(
            self, "Analysis Complete",
            f"Found {len(analysis.hardcoded_secrets)} secrets, "
            f"{len(analysis.backdoors)} backdoors, "
            f"{len(analysis.vulnerabilities)} vulnerabilities"
        )
    
    def _run_exploit(self):
        """Run selected exploit"""
        if self.target_combo.currentIndex() < 0:
            QMessageBox.warning(self, "Error", "Please select a target device")
            return
        
        if self.exploits_table.currentRow() < 0:
            QMessageBox.warning(self, "Error", "Please select an exploit")
            return
        
        device_id = self.target_combo.currentData()
        exploit_name = self.exploits_table.item(self.exploits_table.currentRow(), 0).text()
        
        # Map display name to internal name
        exploit_map = {
            "Telnet Brute Force": "telnet_bruteforce",
            "SSH Brute Force": "ssh_bruteforce",
            "MQTT Anonymous": "mqtt_anonymous",
            "UPnP SOAP Injection": "upnp_soap_injection",
            "RTSP Buffer Overflow": "rtsp_overflow",
            "Camera Backdoor": "camera_backdoor",
            "Modbus Write": "modbus_write",
        }
        
        internal_name = exploit_map.get(exploit_name)
        if internal_name and self.iot_framework:
            self.exploit_output.append(f"\n[*] Running {exploit_name}...")
            
            self.current_worker = IoTWorker(
                self.iot_framework.exploit_device,
                device_id,
                internal_name
            )
            self.current_worker.finished.connect(self._on_exploit_complete)
            self.current_worker.error.connect(self._on_error)
            self.current_worker.start()
    
    def _on_exploit_complete(self, result):
        """Handle exploit completion"""
        if result.success:
            self.exploit_output.append(f"[+] SUCCESS! {result.output}")
            if result.credentials_obtained:
                self.exploit_output.append("[+] Credentials obtained:")
                for cred in result.credentials_obtained:
                    self.exploit_output.append(f"    {cred}")
        else:
            self.exploit_output.append(f"[-] Failed: {result.output or result.error}")
    
    def _start_fuzzing(self):
        """Start protocol fuzzing"""
        if self.fuzz_target_combo.currentIndex() < 0:
            QMessageBox.warning(self, "Error", "Please select a target device")
            return
        
        device_id = self.fuzz_target_combo.currentData()
        protocol_name = self.fuzz_protocol_combo.currentText().lower()
        iterations = self.fuzz_iterations.value()
        
        self.fuzz_progress.setRange(0, iterations)
        self.fuzz_progress.setValue(0)
        
        # In real implementation, would run fuzzing
        QMessageBox.information(
            self, "Fuzzing",
            f"Fuzzing {protocol_name} on device with {iterations} iterations"
        )
