"""
HydraRecon Penetration Testing Report Page
Professional reporting with OWASP, PTES, and NIST frameworks
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,
    QFrame, QScrollArea, QGridLayout, QLineEdit, QTextEdit,
    QComboBox, QTableWidget, QTableWidgetItem, QHeaderView,
    QTabWidget, QSplitter, QTreeWidget, QTreeWidgetItem,
    QGroupBox, QSpinBox, QCheckBox, QProgressBar, QMenu,
    QDialog, QDialogButtonBox, QFormLayout, QMessageBox,
    QListWidget, QListWidgetItem, QStackedWidget, QDateEdit,
    QPlainTextEdit, QFileDialog
)
from PyQt6.QtCore import Qt, pyqtSignal, QTimer, QThread, QDate
from PyQt6.QtGui import QFont, QColor, QAction, QIcon, QTextDocument
from datetime import datetime, timedelta
from typing import Dict, List, Any, Optional
import asyncio
import json


class PentestReportPage(QWidget):
    """Penetration Testing Report Generator Page"""
    
    report_generated = pyqtSignal(str)  # Report ID
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.main_window = parent
        self.engagements = {}
        self.findings = []
        self.templates = {}
        
        self._setup_ui()
        self._connect_signals()
        self._apply_styles()
        self._load_sample_data()
    
    def _setup_ui(self):
        """Setup the report generator interface"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(24, 24, 24, 24)
        layout.setSpacing(16)
        
        # Header
        header = self._create_header()
        layout.addWidget(header)
        
        # Main content with tabs
        self.tab_widget = QTabWidget()
        self.tab_widget.setDocumentMode(True)
        
        # Engagements tab
        engagements_tab = self._create_engagements_tab()
        self.tab_widget.addTab(engagements_tab, "üéØ Engagements")
        
        # Findings tab
        findings_tab = self._create_findings_tab()
        self.tab_widget.addTab(findings_tab, "üîç Findings")
        
        # Templates tab
        templates_tab = self._create_templates_tab()
        self.tab_widget.addTab(templates_tab, "üìÑ Templates")
        
        # Generate tab
        generate_tab = self._create_generate_tab()
        self.tab_widget.addTab(generate_tab, "üìä Generate Report")
        
        # Reports tab
        reports_tab = self._create_reports_tab()
        self.tab_widget.addTab(reports_tab, "üìÅ Generated Reports")
        
        layout.addWidget(self.tab_widget)
    
    def _create_header(self) -> QFrame:
        """Create header section"""
        header = QFrame()
        header.setStyleSheet("""
            QFrame {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #1a1a2e, stop:1 #16213e);
                border-radius: 12px;
                padding: 20px;
            }
        """)
        
        layout = QHBoxLayout(header)
        
        # Title section
        title_layout = QVBoxLayout()
        
        title = QLabel("üìã Pentest Report Generator")
        title.setFont(QFont("Segoe UI", 24, QFont.Weight.Bold))
        title.setStyleSheet("color: #00d4ff;")
        title_layout.addWidget(title)
        
        subtitle = QLabel("Professional security assessment reports with OWASP, PTES, and NIST frameworks")
        subtitle.setStyleSheet("color: #8b949e; font-size: 14px;")
        title_layout.addWidget(subtitle)
        
        layout.addLayout(title_layout)
        layout.addStretch()
        
        # Stats cards
        stats_layout = QHBoxLayout()
        stats_layout.setSpacing(16)
        
        self.engagements_label = self._create_stat_card("Engagements", "0", "#00d4ff")
        stats_layout.addWidget(self.engagements_label)
        
        self.findings_label = self._create_stat_card("Findings", "0", "#ff6b6b")
        stats_layout.addWidget(self.findings_label)
        
        self.critical_label = self._create_stat_card("Critical", "0", "#dc3545")
        stats_layout.addWidget(self.critical_label)
        
        self.reports_label = self._create_stat_card("Reports", "0", "#00ff88")
        stats_layout.addWidget(self.reports_label)
        
        layout.addLayout(stats_layout)
        
        # Action buttons
        btn_layout = QVBoxLayout()
        
        new_engagement_btn = QPushButton("‚ûï New Engagement")
        new_engagement_btn.setStyleSheet("""
            QPushButton {
                background: #238636;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #2ea043;
            }
        """)
        new_engagement_btn.clicked.connect(self._show_new_engagement_dialog)
        btn_layout.addWidget(new_engagement_btn)
        
        generate_btn = QPushButton("üìä Quick Report")
        generate_btn.setStyleSheet("""
            QPushButton {
                background: #1f6feb;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #388bfd;
            }
        """)
        generate_btn.clicked.connect(self._quick_generate_report)
        btn_layout.addWidget(generate_btn)
        
        layout.addLayout(btn_layout)
        
        return header
    
    def _create_stat_card(self, title: str, value: str, color: str) -> QFrame:
        """Create a statistics card"""
        card = QFrame()
        card.setStyleSheet(f"""
            QFrame {{
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid {color}40;
                border-radius: 8px;
                padding: 12px;
            }}
        """)
        card.setFixedWidth(100)
        
        layout = QVBoxLayout(card)
        layout.setContentsMargins(8, 8, 8, 8)
        layout.setSpacing(4)
        
        value_label = QLabel(value)
        value_label.setFont(QFont("Segoe UI", 20, QFont.Weight.Bold))
        value_label.setStyleSheet(f"color: {color};")
        value_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(value_label)
        
        title_label = QLabel(title)
        title_label.setStyleSheet("color: #8b949e; font-size: 11px;")
        title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(title_label)
        
        card.value_label = value_label
        
        return card
    
    def _create_engagements_tab(self) -> QWidget:
        """Create Engagements tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Toolbar
        toolbar = QHBoxLayout()
        
        search = QLineEdit()
        search.setPlaceholderText("üîç Search engagements...")
        search.setStyleSheet("""
            QLineEdit {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 10px;
                color: #c9d1d9;
            }
        """)
        toolbar.addWidget(search, stretch=2)
        
        status_filter = QComboBox()
        status_filter.addItems(["All Status", "Active", "Completed", "Archived"])
        status_filter.setStyleSheet("""
            QComboBox {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 10px;
                color: #c9d1d9;
                min-width: 120px;
            }
        """)
        toolbar.addWidget(status_filter)
        
        layout.addLayout(toolbar)
        
        # Engagements table
        self.engagement_table = QTableWidget()
        self.engagement_table.setColumnCount(8)
        self.engagement_table.setHorizontalHeaderLabels([
            "Name", "Client", "Type", "Status", "Lead Tester",
            "Findings", "Start Date", "Actions"
        ])
        self.engagement_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.engagement_table.setStyleSheet("""
            QTableWidget {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 8px;
            }
            QTableWidget::item {
                padding: 10px;
            }
            QHeaderView::section {
                background: #161b22;
                color: #8b949e;
                padding: 10px;
                border: none;
            }
        """)
        layout.addWidget(self.engagement_table)
        
        return widget
    
    def _create_findings_tab(self) -> QWidget:
        """Create Findings tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Toolbar
        toolbar = QHBoxLayout()
        
        add_finding_btn = QPushButton("‚ûï Add Finding")
        add_finding_btn.setStyleSheet("""
            QPushButton {
                background: #238636;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
            }
            QPushButton:hover {
                background: #2ea043;
            }
        """)
        add_finding_btn.clicked.connect(self._show_add_finding_dialog)
        toolbar.addWidget(add_finding_btn)
        
        import_btn = QPushButton("üì• Import from Scanner")
        import_btn.setStyleSheet("""
            QPushButton {
                background: #1f6feb;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
            }
        """)
        toolbar.addWidget(import_btn)
        
        toolbar.addStretch()
        
        # Filters
        severity_filter = QComboBox()
        severity_filter.addItems(["All Severities", "Critical", "High", "Medium", "Low", "Info"])
        severity_filter.setStyleSheet("""
            QComboBox {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 8px;
                color: #c9d1d9;
            }
        """)
        toolbar.addWidget(severity_filter)
        
        owasp_filter = QComboBox()
        owasp_filter.addItems([
            "All OWASP", "A01: Broken Access Control", "A02: Cryptographic Failures",
            "A03: Injection", "A04: Insecure Design", "A05: Security Misconfiguration"
        ])
        owasp_filter.setStyleSheet("""
            QComboBox {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 8px;
                color: #c9d1d9;
            }
        """)
        toolbar.addWidget(owasp_filter)
        
        layout.addLayout(toolbar)
        
        # Findings table
        self.findings_table = QTableWidget()
        self.findings_table.setColumnCount(9)
        self.findings_table.setHorizontalHeaderLabels([
            "Title", "Severity", "CVSS", "Affected Asset", "Type",
            "OWASP", "Status", "Evidence", "Actions"
        ])
        self.findings_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.findings_table.setStyleSheet("""
            QTableWidget {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 8px;
            }
            QTableWidget::item {
                padding: 10px;
            }
            QHeaderView::section {
                background: #161b22;
                color: #8b949e;
                padding: 10px;
                border: none;
            }
        """)
        self.findings_table.doubleClicked.connect(self._show_finding_details)
        layout.addWidget(self.findings_table)
        
        return widget
    
    def _create_templates_tab(self) -> QWidget:
        """Create Templates tab"""
        widget = QWidget()
        layout = QHBoxLayout(widget)
        
        # Template list
        list_panel = QFrame()
        list_panel.setStyleSheet("""
            QFrame {
                background: #161b22;
                border-radius: 8px;
            }
        """)
        list_layout = QVBoxLayout(list_panel)
        
        list_label = QLabel("üìÑ Report Templates")
        list_label.setFont(QFont("Segoe UI", 14, QFont.Weight.Bold))
        list_label.setStyleSheet("color: #00d4ff; padding: 12px;")
        list_layout.addWidget(list_label)
        
        self.template_list = QListWidget()
        self.template_list.setStyleSheet("""
            QListWidget {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                color: #c9d1d9;
            }
            QListWidget::item {
                padding: 12px;
                border-bottom: 1px solid #21262d;
            }
            QListWidget::item:selected {
                background: #1f6feb30;
            }
            QListWidget::item:hover {
                background: #21262d;
            }
        """)
        self.template_list.currentItemChanged.connect(self._on_template_selected)
        list_layout.addWidget(self.template_list)
        
        # Add custom template button
        add_template_btn = QPushButton("‚ûï Create Custom Template")
        add_template_btn.setStyleSheet("""
            QPushButton {
                background: #238636;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 6px;
            }
        """)
        list_layout.addWidget(add_template_btn)
        
        layout.addWidget(list_panel)
        
        # Template preview
        preview_panel = QFrame()
        preview_panel.setStyleSheet("""
            QFrame {
                background: #161b22;
                border-radius: 8px;
            }
        """)
        preview_layout = QVBoxLayout(preview_panel)
        
        preview_label = QLabel("üëÅÔ∏è Template Preview")
        preview_label.setFont(QFont("Segoe UI", 14, QFont.Weight.Bold))
        preview_label.setStyleSheet("color: #00d4ff; padding: 12px;")
        preview_layout.addWidget(preview_label)
        
        self.template_preview = QTextEdit()
        self.template_preview.setReadOnly(True)
        self.template_preview.setStyleSheet("""
            QTextEdit {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                color: #c9d1d9;
                font-family: 'Consolas', monospace;
            }
        """)
        preview_layout.addWidget(self.template_preview)
        
        layout.addWidget(preview_panel, stretch=2)
        
        return widget
    
    def _create_generate_tab(self) -> QWidget:
        """Create Generate Report tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Configuration panel
        config_frame = QFrame()
        config_frame.setStyleSheet("""
            QFrame {
                background: #161b22;
                border-radius: 8px;
                padding: 20px;
            }
        """)
        config_layout = QGridLayout(config_frame)
        config_layout.setSpacing(16)
        
        # Engagement selection
        eng_label = QLabel("Select Engagement:")
        eng_label.setStyleSheet("color: #8b949e;")
        config_layout.addWidget(eng_label, 0, 0)
        
        self.engagement_combo = QComboBox()
        self.engagement_combo.setStyleSheet("""
            QComboBox {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 10px;
                color: #c9d1d9;
                min-width: 300px;
            }
        """)
        config_layout.addWidget(self.engagement_combo, 0, 1)
        
        # Template selection
        template_label = QLabel("Report Template:")
        template_label.setStyleSheet("color: #8b949e;")
        config_layout.addWidget(template_label, 1, 0)
        
        self.template_combo = QComboBox()
        self.template_combo.addItems([
            "Executive Summary", "Full Technical Report",
            "OWASP Top 10 Report", "PCI-DSS Assessment",
            "Red Team Report", "Vulnerability Report"
        ])
        self.template_combo.setStyleSheet("""
            QComboBox {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 10px;
                color: #c9d1d9;
                min-width: 300px;
            }
        """)
        config_layout.addWidget(self.template_combo, 1, 1)
        
        # Output format
        format_label = QLabel("Output Format:")
        format_label.setStyleSheet("color: #8b949e;")
        config_layout.addWidget(format_label, 2, 0)
        
        self.format_combo = QComboBox()
        self.format_combo.addItems(["HTML", "PDF", "Markdown", "DOCX", "JSON"])
        self.format_combo.setStyleSheet("""
            QComboBox {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 10px;
                color: #c9d1d9;
                min-width: 300px;
            }
        """)
        config_layout.addWidget(self.format_combo, 2, 1)
        
        # Options
        options_label = QLabel("Include Sections:")
        options_label.setStyleSheet("color: #8b949e;")
        config_layout.addWidget(options_label, 3, 0)
        
        options_widget = QWidget()
        options_layout = QHBoxLayout(options_widget)
        options_layout.setContentsMargins(0, 0, 0, 0)
        
        self.include_exec = QCheckBox("Executive Summary")
        self.include_exec.setChecked(True)
        self.include_exec.setStyleSheet("color: #c9d1d9;")
        options_layout.addWidget(self.include_exec)
        
        self.include_method = QCheckBox("Methodology")
        self.include_method.setChecked(True)
        self.include_method.setStyleSheet("color: #c9d1d9;")
        options_layout.addWidget(self.include_method)
        
        self.include_findings = QCheckBox("Detailed Findings")
        self.include_findings.setChecked(True)
        self.include_findings.setStyleSheet("color: #c9d1d9;")
        options_layout.addWidget(self.include_findings)
        
        self.include_remediation = QCheckBox("Remediation Plan")
        self.include_remediation.setChecked(True)
        self.include_remediation.setStyleSheet("color: #c9d1d9;")
        options_layout.addWidget(self.include_remediation)
        
        config_layout.addWidget(options_widget, 3, 1)
        
        layout.addWidget(config_frame)
        
        # Generate button
        generate_btn = QPushButton("üìä Generate Report")
        generate_btn.setFont(QFont("Segoe UI", 14, QFont.Weight.Bold))
        generate_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #238636, stop:1 #2ea043);
                color: white;
                border: none;
                padding: 16px 32px;
                border-radius: 8px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #2ea043, stop:1 #3fb950);
            }
        """)
        generate_btn.clicked.connect(self._generate_report)
        layout.addWidget(generate_btn, alignment=Qt.AlignmentFlag.AlignCenter)
        
        # Preview area
        preview_frame = QFrame()
        preview_frame.setStyleSheet("""
            QFrame {
                background: #161b22;
                border-radius: 8px;
            }
        """)
        preview_layout = QVBoxLayout(preview_frame)
        
        preview_header = QHBoxLayout()
        preview_label = QLabel("üìÑ Report Preview")
        preview_label.setFont(QFont("Segoe UI", 14, QFont.Weight.Bold))
        preview_label.setStyleSheet("color: #00d4ff;")
        preview_header.addWidget(preview_label)
        
        preview_header.addStretch()
        
        export_btn = QPushButton("üì§ Export")
        export_btn.setStyleSheet("""
            QPushButton {
                background: #1f6feb;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
            }
        """)
        export_btn.clicked.connect(self._export_report)
        preview_header.addWidget(export_btn)
        
        preview_layout.addLayout(preview_header)
        
        self.report_preview = QTextEdit()
        self.report_preview.setReadOnly(True)
        self.report_preview.setStyleSheet("""
            QTextEdit {
                background: white;
                border: 1px solid #30363d;
                border-radius: 6px;
                color: #333;
                font-family: Arial, sans-serif;
            }
        """)
        preview_layout.addWidget(self.report_preview)
        
        layout.addWidget(preview_frame)
        
        return widget
    
    def _create_reports_tab(self) -> QWidget:
        """Create Generated Reports tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Reports table
        self.reports_table = QTableWidget()
        self.reports_table.setColumnCount(8)
        self.reports_table.setHorizontalHeaderLabels([
            "Title", "Engagement", "Template", "Format", "Findings",
            "Risk Score", "Generated", "Actions"
        ])
        self.reports_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.reports_table.setStyleSheet("""
            QTableWidget {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 8px;
            }
            QTableWidget::item {
                padding: 10px;
            }
            QHeaderView::section {
                background: #161b22;
                color: #8b949e;
                padding: 10px;
                border: none;
            }
        """)
        layout.addWidget(self.reports_table)
        
        return widget
    
    def _connect_signals(self):
        """Connect signals"""
        pass
    
    def _apply_styles(self):
        """Apply consistent styling"""
        self.setStyleSheet("""
            QWidget {
                background: #0d1117;
                color: #c9d1d9;
            }
            QTabWidget::pane {
                border: none;
                background: transparent;
            }
            QTabBar::tab {
                background: #161b22;
                color: #8b949e;
                padding: 12px 24px;
                margin-right: 4px;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            QTabBar::tab:selected {
                background: #21262d;
                color: #00d4ff;
            }
            QTabBar::tab:hover:!selected {
                background: #1c2128;
            }
        """)
    
    def _load_sample_data(self):
        """Load sample data for demonstration"""
        # Sample engagements
        engagements = [
            ("Web App Assessment", "Acme Corp", "Web Application", "Active", "John Smith", 15, "2024-01-10"),
            ("Network Penetration Test", "TechGlobal Inc", "Network", "Completed", "Jane Doe", 8, "2024-01-05"),
            ("API Security Review", "DataFlow Ltd", "API", "Active", "Bob Wilson", 12, "2024-01-15"),
            ("Cloud Infrastructure Audit", "CloudFirst Co", "Cloud", "Active", "Alice Brown", 6, "2024-01-12"),
            ("Mobile App Security", "AppMakers Inc", "Mobile", "Completed", "Charlie Davis", 10, "2024-01-08")
        ]
        
        self.engagement_table.setRowCount(len(engagements))
        
        for row, eng in enumerate(engagements):
            for col, value in enumerate(eng):
                item = QTableWidgetItem(str(value))
                
                if col == 3:  # Status
                    colors = {"Active": "#00ff88", "Completed": "#00d4ff", "Archived": "#6e7681"}
                    item.setForeground(QColor(colors.get(value, "#c9d1d9")))
                
                self.engagement_table.setItem(row, col, item)
            
            # Actions
            actions_widget = QWidget()
            actions_layout = QHBoxLayout(actions_widget)
            actions_layout.setContentsMargins(4, 4, 4, 4)
            
            view_btn = QPushButton("üëÅÔ∏è")
            view_btn.setFixedSize(28, 28)
            view_btn.setStyleSheet("background: #1f6feb; border: none; border-radius: 4px;")
            actions_layout.addWidget(view_btn)
            
            report_btn = QPushButton("üìä")
            report_btn.setFixedSize(28, 28)
            report_btn.setStyleSheet("background: #238636; border: none; border-radius: 4px;")
            actions_layout.addWidget(report_btn)
            
            self.engagement_table.setCellWidget(row, 7, actions_widget)
        
        # Sample findings
        findings = [
            ("SQL Injection in Login Form", "Critical", "9.8", "web.example.com", "Injection", "A03", "Open"),
            ("Cross-Site Scripting (XSS)", "High", "7.5", "app.example.com", "XSS", "A03", "Open"),
            ("Insecure Direct Object Reference", "High", "7.2", "api.example.com", "Access Control", "A01", "Open"),
            ("Missing Security Headers", "Medium", "5.3", "web.example.com", "Misconfiguration", "A05", "Open"),
            ("Outdated TLS Configuration", "Medium", "5.0", "mail.example.com", "Crypto", "A02", "Fixed"),
            ("Information Disclosure", "Low", "3.5", "docs.example.com", "Information Leak", "A01", "Open"),
            ("Verbose Error Messages", "Low", "2.5", "api.example.com", "Information Leak", "A05", "Open"),
            ("Session Timeout Too Long", "Medium", "4.5", "app.example.com", "Session Mgmt", "A07", "Open")
        ]
        
        self.findings_table.setRowCount(len(findings))
        
        for row, finding in enumerate(findings):
            for col, value in enumerate(finding):
                item = QTableWidgetItem(str(value))
                
                if col == 1:  # Severity
                    colors = {
                        "Critical": "#dc3545", "High": "#fd7e14",
                        "Medium": "#ffc107", "Low": "#17a2b8", "Info": "#6c757d"
                    }
                    item.setForeground(QColor(colors.get(value, "#c9d1d9")))
                
                if col == 6:  # Status
                    colors = {"Open": "#ff6b6b", "Fixed": "#00ff88", "Accepted": "#ffa500"}
                    item.setForeground(QColor(colors.get(value, "#c9d1d9")))
                
                self.findings_table.setItem(row, col, item)
            
            # Evidence
            evidence_item = QTableWidgetItem("üì∏ 3 files")
            evidence_item.setForeground(QColor("#00d4ff"))
            self.findings_table.setItem(row, 7, evidence_item)
            
            # Actions
            actions_widget = QWidget()
            actions_layout = QHBoxLayout(actions_widget)
            actions_layout.setContentsMargins(4, 4, 4, 4)
            
            edit_btn = QPushButton("‚úèÔ∏è")
            edit_btn.setFixedSize(28, 28)
            edit_btn.setStyleSheet("background: #1f6feb; border: none; border-radius: 4px;")
            actions_layout.addWidget(edit_btn)
            
            delete_btn = QPushButton("üóëÔ∏è")
            delete_btn.setFixedSize(28, 28)
            delete_btn.setStyleSheet("background: #da3633; border: none; border-radius: 4px;")
            actions_layout.addWidget(delete_btn)
            
            self.findings_table.setCellWidget(row, 8, actions_widget)
        
        # Load templates
        templates = [
            "üìã Executive Summary",
            "üìÑ Full Technical Report",
            "üîí OWASP Top 10 Report",
            "üí≥ PCI-DSS Assessment",
            "‚öîÔ∏è Red Team Report",
            "üîç Vulnerability Report",
            "üìä Risk Assessment Report",
            "üîÑ Retesting Report"
        ]
        
        for template in templates:
            self.template_list.addItem(template)
        
        # Populate engagement combo
        for eng in engagements:
            self.engagement_combo.addItem(f"{eng[0]} - {eng[1]}")
        
        # Update stats
        self.engagements_label.value_label.setText(str(len(engagements)))
        self.findings_label.value_label.setText(str(len(findings)))
        critical_count = sum(1 for f in findings if f[1] == "Critical")
        self.critical_label.value_label.setText(str(critical_count))
        self.reports_label.value_label.setText("5")
        
        # Load sample generated reports
        self._load_sample_reports()
    
    def _load_sample_reports(self):
        """Load sample generated reports"""
        reports = [
            ("Web App Assessment - Full Technical Report", "Web App Assessment", "Full Technical", "HTML", 15, 7.8, "2024-01-15 14:30"),
            ("Network Pentest - Executive Summary", "Network Penetration Test", "Executive Summary", "PDF", 8, 6.2, "2024-01-10 09:15"),
            ("API Security - OWASP Report", "API Security Review", "OWASP Top 10", "HTML", 12, 8.1, "2024-01-18 16:45"),
            ("Cloud Audit - Technical Report", "Cloud Infrastructure Audit", "Full Technical", "DOCX", 6, 5.5, "2024-01-14 11:20"),
            ("Mobile Security - Vulnerability Report", "Mobile App Security", "Vulnerability Report", "PDF", 10, 6.9, "2024-01-12 10:00")
        ]
        
        self.reports_table.setRowCount(len(reports))
        
        for row, report in enumerate(reports):
            for col, value in enumerate(report):
                item = QTableWidgetItem(str(value))
                
                if col == 5:  # Risk score
                    score = float(value)
                    if score >= 8:
                        item.setForeground(QColor("#dc3545"))
                    elif score >= 6:
                        item.setForeground(QColor("#fd7e14"))
                    elif score >= 4:
                        item.setForeground(QColor("#ffc107"))
                    else:
                        item.setForeground(QColor("#00ff88"))
                
                self.reports_table.setItem(row, col, item)
            
            # Actions
            actions_widget = QWidget()
            actions_layout = QHBoxLayout(actions_widget)
            actions_layout.setContentsMargins(4, 4, 4, 4)
            
            view_btn = QPushButton("üëÅÔ∏è")
            view_btn.setFixedSize(28, 28)
            view_btn.setStyleSheet("background: #1f6feb; border: none; border-radius: 4px;")
            actions_layout.addWidget(view_btn)
            
            download_btn = QPushButton("‚¨áÔ∏è")
            download_btn.setFixedSize(28, 28)
            download_btn.setStyleSheet("background: #238636; border: none; border-radius: 4px;")
            actions_layout.addWidget(download_btn)
            
            self.reports_table.setCellWidget(row, 7, actions_widget)
    
    def _on_template_selected(self, current, previous):
        """Handle template selection"""
        if current:
            template_name = current.text()
            preview = self._get_template_preview(template_name)
            self.template_preview.setPlainText(preview)
    
    def _get_template_preview(self, template_name: str) -> str:
        """Get template preview content"""
        previews = {
            "üìã Executive Summary": """EXECUTIVE SUMMARY TEMPLATE
===========================

Sections:
- Cover Page
- Executive Summary
- Key Findings Overview
- Risk Rating
- Recommendations Summary
- Next Steps

Best for:
‚Ä¢ Board presentations
‚Ä¢ Management briefings
‚Ä¢ Quick overview reports""",
            
            "üìÑ Full Technical Report": """FULL TECHNICAL REPORT TEMPLATE
================================

Sections:
- Cover Page
- Table of Contents
- Executive Summary
- Engagement Overview
- Methodology
- Testing Scope
- Tools Used
- Findings Summary
- Detailed Findings
- Risk Assessment
- Remediation Roadmap
- Appendix A: Raw Data
- Appendix B: Screenshots
- Appendix C: References

Best for:
‚Ä¢ Technical teams
‚Ä¢ Detailed assessments
‚Ä¢ Compliance evidence""",
            
            "üîí OWASP Top 10 Report": """OWASP TOP 10 REPORT TEMPLATE
==============================

Sections:
- A01: Broken Access Control
- A02: Cryptographic Failures
- A03: Injection
- A04: Insecure Design
- A05: Security Misconfiguration
- A06: Vulnerable Components
- A07: Authentication Failures
- A08: Integrity Failures
- A09: Logging Failures
- A10: SSRF

Compliance: OWASP Top 10 2021"""
        }
        
        for key, value in previews.items():
            if key in template_name:
                return value
        
        return "Select a template to see preview..."
    
    def _show_new_engagement_dialog(self):
        """Show new engagement dialog"""
        dialog = QDialog(self)
        dialog.setWindowTitle("New Engagement")
        dialog.setMinimumSize(500, 600)
        dialog.setStyleSheet("""
            QDialog {
                background: #161b22;
            }
            QLabel {
                color: #c9d1d9;
            }
            QLineEdit, QComboBox, QTextEdit, QDateEdit {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 8px;
                color: #c9d1d9;
            }
        """)
        
        layout = QFormLayout(dialog)
        
        name_edit = QLineEdit()
        name_edit.setPlaceholderText("e.g., Web Application Security Assessment")
        layout.addRow("Engagement Name:", name_edit)
        
        client_edit = QLineEdit()
        client_edit.setPlaceholderText("Client organization name")
        layout.addRow("Client:", client_edit)
        
        scope_combo = QComboBox()
        scope_combo.addItems([
            "Web Application", "Network", "API", "Mobile",
            "Cloud", "IoT", "Red Team", "Social Engineering"
        ])
        layout.addRow("Scope Type:", scope_combo)
        
        testing_combo = QComboBox()
        testing_combo.addItems(["Black Box", "Gray Box", "White Box"])
        layout.addRow("Testing Type:", testing_combo)
        
        method_combo = QComboBox()
        method_combo.addItems(["PTES", "OWASP", "NIST", "Custom"])
        layout.addRow("Methodology:", method_combo)
        
        lead_edit = QLineEdit()
        lead_edit.setPlaceholderText("Lead tester name")
        layout.addRow("Lead Tester:", lead_edit)
        
        start_date = QDateEdit()
        start_date.setDate(QDate.currentDate())
        layout.addRow("Start Date:", start_date)
        
        end_date = QDateEdit()
        end_date.setDate(QDate.currentDate().addDays(14))
        layout.addRow("End Date:", end_date)
        
        scope_edit = QTextEdit()
        scope_edit.setPlaceholderText("List in-scope targets (one per line)")
        scope_edit.setMaximumHeight(100)
        layout.addRow("In-Scope Targets:", scope_edit)
        
        buttons = QDialogButtonBox(
            QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel
        )
        buttons.accepted.connect(dialog.accept)
        buttons.rejected.connect(dialog.reject)
        layout.addRow(buttons)
        
        dialog.exec()
    
    def _show_add_finding_dialog(self):
        """Show add finding dialog"""
        dialog = QDialog(self)
        dialog.setWindowTitle("Add Finding")
        dialog.setMinimumSize(600, 700)
        dialog.setStyleSheet("""
            QDialog {
                background: #161b22;
            }
            QLabel {
                color: #c9d1d9;
            }
            QLineEdit, QComboBox, QTextEdit, QSpinBox, QDoubleSpinBox {
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 8px;
                color: #c9d1d9;
            }
        """)
        
        layout = QFormLayout(dialog)
        
        title_edit = QLineEdit()
        title_edit.setPlaceholderText("e.g., SQL Injection in Login Form")
        layout.addRow("Title:", title_edit)
        
        severity_combo = QComboBox()
        severity_combo.addItems(["Critical", "High", "Medium", "Low", "Informational"])
        layout.addRow("Severity:", severity_combo)
        
        cvss_spin = QLineEdit()
        cvss_spin.setPlaceholderText("0.0 - 10.0")
        layout.addRow("CVSS Score:", cvss_spin)
        
        asset_edit = QLineEdit()
        asset_edit.setPlaceholderText("Affected system/application")
        layout.addRow("Affected Asset:", asset_edit)
        
        type_combo = QComboBox()
        type_combo.addItems([
            "Injection", "XSS", "Access Control", "Cryptographic Failure",
            "Misconfiguration", "Outdated Component", "Authentication",
            "SSRF", "Information Disclosure", "Other"
        ])
        layout.addRow("Vulnerability Type:", type_combo)
        
        owasp_combo = QComboBox()
        owasp_combo.addItems([
            "A01: Broken Access Control",
            "A02: Cryptographic Failures",
            "A03: Injection",
            "A04: Insecure Design",
            "A05: Security Misconfiguration",
            "A06: Vulnerable Components",
            "A07: Authentication Failures",
            "A08: Integrity Failures",
            "A09: Logging Failures",
            "A10: SSRF"
        ])
        layout.addRow("OWASP Category:", owasp_combo)
        
        desc_edit = QTextEdit()
        desc_edit.setPlaceholderText("Detailed description of the vulnerability...")
        desc_edit.setMaximumHeight(100)
        layout.addRow("Description:", desc_edit)
        
        impact_edit = QTextEdit()
        impact_edit.setPlaceholderText("Business impact of this vulnerability...")
        impact_edit.setMaximumHeight(80)
        layout.addRow("Business Impact:", impact_edit)
        
        poc_edit = QTextEdit()
        poc_edit.setPlaceholderText("Steps to reproduce / Proof of concept...")
        poc_edit.setMaximumHeight(100)
        layout.addRow("Proof of Concept:", poc_edit)
        
        rec_edit = QTextEdit()
        rec_edit.setPlaceholderText("Recommended remediation steps...")
        rec_edit.setMaximumHeight(80)
        layout.addRow("Recommendation:", rec_edit)
        
        buttons = QDialogButtonBox(
            QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel
        )
        buttons.accepted.connect(dialog.accept)
        buttons.rejected.connect(dialog.reject)
        layout.addRow(buttons)
        
        dialog.exec()
    
    def _show_finding_details(self, index):
        """Show finding details dialog"""
        row = index.row()
        title = self.findings_table.item(row, 0).text() if self.findings_table.item(row, 0) else "Unknown"
        
        dialog = QDialog(self)
        dialog.setWindowTitle(f"Finding Details - {title}")
        dialog.setMinimumSize(700, 600)
        dialog.setStyleSheet("""
            QDialog {
                background: #161b22;
            }
            QLabel {
                color: #c9d1d9;
            }
        """)
        
        layout = QVBoxLayout(dialog)
        
        # Header
        header = QLabel(f"üîç {title}")
        header.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
        header.setStyleSheet("color: #00d4ff;")
        layout.addWidget(header)
        
        # Details in tabs
        tabs = QTabWidget()
        
        # Overview tab
        overview = QWidget()
        overview_layout = QFormLayout(overview)
        
        for col in range(self.findings_table.columnCount() - 1):
            header_text = self.findings_table.horizontalHeaderItem(col).text()
            value = self.findings_table.item(row, col).text() if self.findings_table.item(row, col) else "N/A"
            value_label = QLabel(value)
            value_label.setStyleSheet("color: #c9d1d9;")
            overview_layout.addRow(f"{header_text}:", value_label)
        
        tabs.addTab(overview, "Overview")
        
        # Evidence tab
        evidence = QWidget()
        evidence_layout = QVBoxLayout(evidence)
        evidence_list = QListWidget()
        evidence_list.addItems([
            "üì∏ screenshot_login_page.png",
            "üìÑ request_response.txt",
            "üé• poc_video.mp4"
        ])
        evidence_layout.addWidget(evidence_list)
        tabs.addTab(evidence, "Evidence")
        
        # Remediation tab
        remediation = QWidget()
        rem_layout = QVBoxLayout(remediation)
        rem_text = QTextEdit()
        rem_text.setPlainText("""Recommended Remediation Steps:

1. Implement parameterized queries or prepared statements
2. Use stored procedures when possible
3. Apply input validation and sanitization
4. Implement proper error handling
5. Apply least privilege database permissions
6. Use Web Application Firewall (WAF) rules

References:
- OWASP SQL Injection Prevention Cheat Sheet
- CWE-89: Improper Neutralization of Special Elements""")
        rem_text.setReadOnly(True)
        rem_layout.addWidget(rem_text)
        tabs.addTab(remediation, "Remediation")
        
        layout.addWidget(tabs)
        
        # Close button
        close_btn = QPushButton("Close")
        close_btn.setStyleSheet("""
            QPushButton {
                background: #21262d;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
            }
        """)
        close_btn.clicked.connect(dialog.close)
        layout.addWidget(close_btn, alignment=Qt.AlignmentFlag.AlignRight)
        
        dialog.exec()
    
    def _generate_report(self):
        """Generate the report"""
        engagement = self.engagement_combo.currentText()
        template = self.template_combo.currentText()
        format_type = self.format_combo.currentText()
        
        # Generate sample HTML report
        report_html = f"""
<html>
<head>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; color: #333; }}
        .header {{ background: #1a1a2e; color: white; padding: 30px; border-radius: 8px; }}
        .header h1 {{ margin: 0; color: #00d4ff; }}
        .section {{ margin: 30px 0; }}
        .section h2 {{ color: #1a1a2e; border-bottom: 2px solid #00d4ff; padding-bottom: 10px; }}
        .finding {{ background: #f8f9fa; padding: 20px; margin: 15px 0; border-left: 4px solid #dc3545; border-radius: 4px; }}
        .severity {{ display: inline-block; padding: 4px 12px; border-radius: 4px; color: white; background: #dc3545; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí Security Assessment Report</h1>
        <p>{engagement}</p>
        <p>Template: {template} | Format: {format_type}</p>
        <p>Generated: {datetime.now().strftime('%B %d, %Y at %H:%M')}</p>
    </div>
    
    <div class="section">
        <h2>Executive Summary</h2>
        <p>This security assessment identified <strong>8 findings</strong> across the target systems.</p>
        <table width="100%" cellpadding="10" style="border-collapse: collapse;">
            <tr style="background: #f8f9fa;">
                <td>üî¥ Critical: <strong>1</strong></td>
                <td>üü† High: <strong>2</strong></td>
                <td>üü° Medium: <strong>3</strong></td>
                <td>üîµ Low: <strong>2</strong></td>
            </tr>
        </table>
    </div>
    
    <div class="section">
        <h2>Key Findings</h2>
        
        <div class="finding">
            <h3>SQL Injection in Login Form</h3>
            <span class="severity">CRITICAL</span> CVSS: 9.8
            <p><strong>Affected Asset:</strong> web.example.com</p>
            <p>The login form is vulnerable to SQL injection attacks, allowing attackers to bypass authentication and access sensitive data.</p>
            <p><strong>Recommendation:</strong> Implement parameterized queries and input validation.</p>
        </div>
        
        <div class="finding" style="border-left-color: #fd7e14;">
            <h3>Cross-Site Scripting (XSS)</h3>
            <span class="severity" style="background: #fd7e14;">HIGH</span> CVSS: 7.5
            <p><strong>Affected Asset:</strong> app.example.com</p>
            <p>Stored XSS vulnerability allows attackers to inject malicious scripts.</p>
            <p><strong>Recommendation:</strong> Implement output encoding and Content Security Policy.</p>
        </div>
    </div>
    
    <div class="section">
        <h2>Remediation Priorities</h2>
        <ol>
            <li><strong>SQL Injection</strong> - Critical - Immediate action required</li>
            <li><strong>XSS Vulnerability</strong> - High - Fix within 7 days</li>
            <li><strong>Access Control Issues</strong> - High - Fix within 14 days</li>
            <li><strong>Security Misconfigurations</strong> - Medium - Fix within 30 days</li>
        </ol>
    </div>
</body>
</html>
"""
        
        self.report_preview.setHtml(report_html)
        
        QMessageBox.information(
            self, "Report Generated",
            f"Report generated successfully!\n\nEngagement: {engagement}\nTemplate: {template}\nFormat: {format_type}"
        )
    
    def _quick_generate_report(self):
        """Quick generate report with defaults"""
        self.tab_widget.setCurrentIndex(3)  # Switch to Generate tab
        self._generate_report()
    
    def _export_report(self):
        """Export the generated report"""
        format_type = self.format_combo.currentText().lower()
        
        file_path, _ = QFileDialog.getSaveFileName(
            self, "Export Report", f"security_report.{format_type}",
            f"{format_type.upper()} Files (*.{format_type})"
        )
        
        if file_path:
            QMessageBox.information(
                self, "Export Complete",
                f"Report exported to:\n{file_path}"
            )
