"""
Malware Analysis Page - GUI for malware research and analysis
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,
    QTableWidget, QTableWidgetItem, QTabWidget, QTextEdit,
    QGroupBox, QFormLayout, QLineEdit, QComboBox, QCheckBox,
    QProgressBar, QSplitter, QFileDialog, QHeaderView,
    QFrame, QScrollArea, QTreeWidget, QTreeWidgetItem,
    QSpinBox, QMessageBox
)
from PyQt6.QtCore import Qt, pyqtSignal, QThread
from PyQt6.QtGui import QFont, QColor
from datetime import datetime
from typing import Optional
import json


class AnalysisWorker(QThread):
    """Background worker for malware analysis"""
    progress = pyqtSignal(int, str)
    finished = pyqtSignal(object)
    error = pyqtSignal(str)
    log = pyqtSignal(str, str)
    
    def __init__(self, engine, file_path: str, analysis_types: list):
        super().__init__()
        self.engine = engine
        self.file_path = file_path
        self.analysis_types = analysis_types
    
    def run(self):
        try:
            import asyncio
            
            self.engine.progress_callback = lambda p, s: self.progress.emit(p, s)
            self.engine.log_callback = lambda m, l: self.log.emit(m, l)
            
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            result = loop.run_until_complete(
                self.engine.analyze_sample(self.file_path, self.analysis_types)
            )
            loop.close()
            
            self.finished.emit(result)
        except Exception as e:
            self.error.emit(str(e))


class MalwareAnalysisPage(QWidget):
    """Malware Analysis Engine GUI Page"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.main_window = parent
        self.engine = None
        self.current_report = None
        self.analysis_worker = None
        self._init_engine()
        self._init_ui()
    
    def _init_engine(self):
        """Initialize the malware analysis engine"""
        try:
            from core.malware_analysis import MalwareAnalysisEngine
            self.engine = MalwareAnalysisEngine()
        except ImportError as e:
            print(f"Could not import malware analysis engine: {e}")
    
    def _init_ui(self):
        """Initialize the user interface"""
        layout = QVBoxLayout(self)
        layout.setSpacing(10)
        
        # Header
        header = QLabel("üî¨ Malware Analysis Engine")
        header.setFont(QFont("Segoe UI", 24, QFont.Weight.Bold))
        header.setStyleSheet("color: #00ff88;")
        layout.addWidget(header)
        
        subtitle = QLabel("Static and dynamic malware analysis with YARA, behavioral detection, and IOC extraction")
        subtitle.setStyleSheet("color: #888; font-size: 12px; margin-bottom: 10px;")
        layout.addWidget(subtitle)
        
        # Main splitter
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Left panel - Controls
        left_panel = QWidget()
        left_layout = QVBoxLayout(left_panel)
        left_layout.setContentsMargins(0, 0, 10, 0)
        
        # Sample selection
        sample_group = QGroupBox("üìÅ Sample Selection")
        sample_layout = QVBoxLayout(sample_group)
        
        file_row = QHBoxLayout()
        self.file_path_input = QLineEdit()
        self.file_path_input.setPlaceholderText("Select malware sample...")
        self.file_path_input.setStyleSheet("""
            QLineEdit {
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 5px;
                padding: 8px;
                color: white;
            }
        """)
        file_row.addWidget(self.file_path_input)
        
        browse_btn = QPushButton("Browse")
        browse_btn.setStyleSheet("""
            QPushButton {
                background: #00d4ff;
                color: black;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #00b8e6;
            }
        """)
        browse_btn.clicked.connect(self._browse_file)
        file_row.addWidget(browse_btn)
        sample_layout.addLayout(file_row)
        
        left_layout.addWidget(sample_group)
        
        # Analysis options
        options_group = QGroupBox("‚öôÔ∏è Analysis Options")
        options_layout = QVBoxLayout(options_group)
        
        self.static_check = QCheckBox("Static Analysis")
        self.static_check.setChecked(True)
        self.static_check.setStyleSheet("color: white;")
        options_layout.addWidget(self.static_check)
        
        self.behavioral_check = QCheckBox("Behavioral Analysis")
        self.behavioral_check.setChecked(True)
        self.behavioral_check.setStyleSheet("color: white;")
        options_layout.addWidget(self.behavioral_check)
        
        self.dynamic_check = QCheckBox("Dynamic Analysis (Sandbox)")
        self.dynamic_check.setStyleSheet("color: white;")
        options_layout.addWidget(self.dynamic_check)
        
        self.network_check = QCheckBox("Network Analysis")
        self.network_check.setChecked(True)
        self.network_check.setStyleSheet("color: white;")
        options_layout.addWidget(self.network_check)
        
        self.memory_check = QCheckBox("Memory Analysis")
        self.memory_check.setStyleSheet("color: white;")
        options_layout.addWidget(self.memory_check)
        
        left_layout.addWidget(options_group)
        
        # YARA options
        yara_group = QGroupBox("üéØ YARA Configuration")
        yara_layout = QFormLayout(yara_group)
        
        self.yara_path_input = QLineEdit("rules/")
        self.yara_path_input.setStyleSheet("""
            QLineEdit {
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 5px;
                padding: 5px;
                color: white;
            }
        """)
        yara_layout.addRow("Rules Path:", self.yara_path_input)
        
        left_layout.addWidget(yara_group)
        
        # Control buttons
        btn_layout = QHBoxLayout()
        
        self.analyze_btn = QPushButton("üî¨ Analyze Sample")
        self.analyze_btn.setStyleSheet("""
            QPushButton {
                background: #00ff88;
                color: black;
                border: none;
                border-radius: 5px;
                padding: 12px;
                font-weight: bold;
                font-size: 14px;
            }
            QPushButton:hover {
                background: #00cc6e;
            }
            QPushButton:disabled {
                background: #555;
                color: #888;
            }
        """)
        self.analyze_btn.clicked.connect(self._start_analysis)
        btn_layout.addWidget(self.analyze_btn)
        
        self.stop_btn = QPushButton("‚èπ Stop")
        self.stop_btn.setEnabled(False)
        self.stop_btn.setStyleSheet("""
            QPushButton {
                background: #ff4444;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 12px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #cc3333;
            }
            QPushButton:disabled {
                background: #555;
                color: #888;
            }
        """)
        self.stop_btn.clicked.connect(self._stop_analysis)
        btn_layout.addWidget(self.stop_btn)
        
        left_layout.addLayout(btn_layout)
        
        # Progress
        self.progress_bar = QProgressBar()
        self.progress_bar.setStyleSheet("""
            QProgressBar {
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 5px;
                height: 25px;
                text-align: center;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #00ff88, stop:1 #00d4ff);
                border-radius: 4px;
            }
        """)
        left_layout.addWidget(self.progress_bar)
        
        self.status_label = QLabel("Ready")
        self.status_label.setStyleSheet("color: #888;")
        left_layout.addWidget(self.status_label)
        
        # Quick stats
        stats_group = QGroupBox("üìä Quick Stats")
        stats_layout = QFormLayout(stats_group)
        
        self.stat_threat = QLabel("-")
        self.stat_threat.setStyleSheet("color: #00ff88; font-weight: bold;")
        stats_layout.addRow("Threat Level:", self.stat_threat)
        
        self.stat_type = QLabel("-")
        self.stat_type.setStyleSheet("color: #00d4ff;")
        stats_layout.addRow("Malware Type:", self.stat_type)
        
        self.stat_yara = QLabel("-")
        self.stat_yara.setStyleSheet("color: #ff8800;")
        stats_layout.addRow("YARA Matches:", self.stat_yara)
        
        self.stat_behaviors = QLabel("-")
        self.stat_behaviors.setStyleSheet("color: #ff4444;")
        stats_layout.addRow("Behaviors:", self.stat_behaviors)
        
        self.stat_iocs = QLabel("-")
        self.stat_iocs.setStyleSheet("color: #aa88ff;")
        stats_layout.addRow("IOCs:", self.stat_iocs)
        
        left_layout.addWidget(stats_group)
        
        left_layout.addStretch()
        
        splitter.addWidget(left_panel)
        
        # Right panel - Results
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)
        right_layout.setContentsMargins(10, 0, 0, 0)
        
        # Results tabs
        self.results_tabs = QTabWidget()
        self.results_tabs.setStyleSheet("""
            QTabWidget::pane {
                border: 1px solid #333;
                background: #16213e;
                border-radius: 5px;
            }
            QTabBar::tab {
                background: #1a1a2e;
                color: #888;
                padding: 8px 15px;
                margin-right: 2px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            QTabBar::tab:selected {
                background: #16213e;
                color: #00ff88;
            }
        """)
        
        # Overview tab
        overview_tab = QWidget()
        overview_layout = QVBoxLayout(overview_tab)
        
        self.overview_text = QTextEdit()
        self.overview_text.setReadOnly(True)
        self.overview_text.setStyleSheet("""
            QTextEdit {
                background: #1a1a2e;
                border: none;
                color: white;
                font-family: 'Consolas', 'Monaco', monospace;
            }
        """)
        self.overview_text.setPlaceholderText("Analysis overview will appear here...")
        overview_layout.addWidget(self.overview_text)
        
        self.results_tabs.addTab(overview_tab, "üìã Overview")
        
        # File Info tab
        file_tab = QWidget()
        file_layout = QVBoxLayout(file_tab)
        
        self.file_info_table = QTableWidget()
        self.file_info_table.setColumnCount(2)
        self.file_info_table.setHorizontalHeaderLabels(["Property", "Value"])
        self.file_info_table.horizontalHeader().setStretchLastSection(True)
        self.file_info_table.setStyleSheet("""
            QTableWidget {
                background: #1a1a2e;
                border: none;
                gridline-color: #333;
            }
            QTableWidget::item {
                padding: 8px;
                color: white;
            }
            QHeaderView::section {
                background: #16213e;
                color: #00ff88;
                padding: 8px;
                border: none;
            }
        """)
        file_layout.addWidget(self.file_info_table)
        
        self.results_tabs.addTab(file_tab, "üìÅ File Info")
        
        # Strings tab
        strings_tab = QWidget()
        strings_layout = QVBoxLayout(strings_tab)
        
        self.strings_tree = QTreeWidget()
        self.strings_tree.setHeaderLabels(["Category", "Count", "Sample Values"])
        self.strings_tree.setStyleSheet("""
            QTreeWidget {
                background: #1a1a2e;
                border: none;
                color: white;
            }
            QTreeWidget::item {
                padding: 5px;
            }
            QTreeWidget::item:selected {
                background: #00ff88;
                color: black;
            }
            QHeaderView::section {
                background: #16213e;
                color: #00ff88;
                padding: 8px;
                border: none;
            }
        """)
        strings_layout.addWidget(self.strings_tree)
        
        self.results_tabs.addTab(strings_tab, "üìù Strings")
        
        # PE Analysis tab
        pe_tab = QWidget()
        pe_layout = QVBoxLayout(pe_tab)
        
        self.pe_tree = QTreeWidget()
        self.pe_tree.setHeaderLabels(["Property", "Value", "Notes"])
        self.pe_tree.setStyleSheet("""
            QTreeWidget {
                background: #1a1a2e;
                border: none;
                color: white;
            }
            QTreeWidget::item {
                padding: 5px;
            }
            QHeaderView::section {
                background: #16213e;
                color: #00ff88;
                padding: 8px;
                border: none;
            }
        """)
        pe_layout.addWidget(self.pe_tree)
        
        self.results_tabs.addTab(pe_tab, "üîß PE Analysis")
        
        # YARA tab
        yara_tab = QWidget()
        yara_layout = QVBoxLayout(yara_tab)
        
        self.yara_table = QTableWidget()
        self.yara_table.setColumnCount(4)
        self.yara_table.setHorizontalHeaderLabels(["Rule", "Tags", "Severity", "Strings"])
        self.yara_table.horizontalHeader().setStretchLastSection(True)
        self.yara_table.setStyleSheet("""
            QTableWidget {
                background: #1a1a2e;
                border: none;
                gridline-color: #333;
            }
            QTableWidget::item {
                padding: 8px;
                color: white;
            }
            QHeaderView::section {
                background: #16213e;
                color: #00ff88;
                padding: 8px;
                border: none;
            }
        """)
        yara_layout.addWidget(self.yara_table)
        
        self.results_tabs.addTab(yara_tab, "üéØ YARA Matches")
        
        # Behaviors tab
        behaviors_tab = QWidget()
        behaviors_layout = QVBoxLayout(behaviors_tab)
        
        self.behaviors_table = QTableWidget()
        self.behaviors_table.setColumnCount(4)
        self.behaviors_table.setHorizontalHeaderLabels(["Severity", "Category", "Description", "MITRE ATT&CK"])
        self.behaviors_table.horizontalHeader().setStretchLastSection(True)
        self.behaviors_table.setStyleSheet("""
            QTableWidget {
                background: #1a1a2e;
                border: none;
                gridline-color: #333;
            }
            QTableWidget::item {
                padding: 8px;
                color: white;
            }
            QHeaderView::section {
                background: #16213e;
                color: #00ff88;
                padding: 8px;
                border: none;
            }
        """)
        behaviors_layout.addWidget(self.behaviors_table)
        
        self.results_tabs.addTab(behaviors_tab, "‚ö†Ô∏è Behaviors")
        
        # IOCs tab
        iocs_tab = QWidget()
        iocs_layout = QVBoxLayout(iocs_tab)
        
        self.iocs_table = QTableWidget()
        self.iocs_table.setColumnCount(3)
        self.iocs_table.setHorizontalHeaderLabels(["Type", "Value", "Confidence"])
        self.iocs_table.horizontalHeader().setStretchLastSection(True)
        self.iocs_table.setStyleSheet("""
            QTableWidget {
                background: #1a1a2e;
                border: none;
                gridline-color: #333;
            }
            QTableWidget::item {
                padding: 8px;
                color: white;
            }
            QHeaderView::section {
                background: #16213e;
                color: #00ff88;
                padding: 8px;
                border: none;
            }
        """)
        iocs_layout.addWidget(self.iocs_table)
        
        # Export IOCs button
        export_iocs_btn = QPushButton("üì§ Export IOCs")
        export_iocs_btn.setStyleSheet("""
            QPushButton {
                background: #aa88ff;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 10px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #9977ee;
            }
        """)
        export_iocs_btn.clicked.connect(self._export_iocs)
        iocs_layout.addWidget(export_iocs_btn)
        
        self.results_tabs.addTab(iocs_tab, "üéØ IOCs")
        
        # MITRE ATT&CK tab
        mitre_tab = QWidget()
        mitre_layout = QVBoxLayout(mitre_tab)
        
        self.mitre_table = QTableWidget()
        self.mitre_table.setColumnCount(2)
        self.mitre_table.setHorizontalHeaderLabels(["Technique ID", "Name"])
        self.mitre_table.horizontalHeader().setStretchLastSection(True)
        self.mitre_table.setStyleSheet("""
            QTableWidget {
                background: #1a1a2e;
                border: none;
                gridline-color: #333;
            }
            QTableWidget::item {
                padding: 8px;
                color: white;
            }
            QHeaderView::section {
                background: #16213e;
                color: #00ff88;
                padding: 8px;
                border: none;
            }
        """)
        mitre_layout.addWidget(self.mitre_table)
        
        self.results_tabs.addTab(mitre_tab, "üó∫Ô∏è MITRE ATT&CK")
        
        # Log tab
        log_tab = QWidget()
        log_layout = QVBoxLayout(log_tab)
        
        self.log_output = QTextEdit()
        self.log_output.setReadOnly(True)
        self.log_output.setStyleSheet("""
            QTextEdit {
                background: #0f0f1a;
                border: none;
                color: #00ff88;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 11px;
            }
        """)
        log_layout.addWidget(self.log_output)
        
        self.results_tabs.addTab(log_tab, "üìú Log")
        
        right_layout.addWidget(self.results_tabs)
        
        # Export buttons
        export_layout = QHBoxLayout()
        
        export_json_btn = QPushButton("üìÑ Export JSON")
        export_json_btn.setStyleSheet("""
            QPushButton {
                background: #16213e;
                color: #00d4ff;
                border: 1px solid #00d4ff;
                border-radius: 5px;
                padding: 8px 15px;
            }
            QPushButton:hover {
                background: #00d4ff;
                color: black;
            }
        """)
        export_json_btn.clicked.connect(lambda: self._export_report("json"))
        export_layout.addWidget(export_json_btn)
        
        export_md_btn = QPushButton("üìù Export Markdown")
        export_md_btn.setStyleSheet("""
            QPushButton {
                background: #16213e;
                color: #ff8800;
                border: 1px solid #ff8800;
                border-radius: 5px;
                padding: 8px 15px;
            }
            QPushButton:hover {
                background: #ff8800;
                color: black;
            }
        """)
        export_md_btn.clicked.connect(lambda: self._export_report("markdown"))
        export_layout.addWidget(export_md_btn)
        
        export_html_btn = QPushButton("üåê Export HTML")
        export_html_btn.setStyleSheet("""
            QPushButton {
                background: #16213e;
                color: #00ff88;
                border: 1px solid #00ff88;
                border-radius: 5px;
                padding: 8px 15px;
            }
            QPushButton:hover {
                background: #00ff88;
                color: black;
            }
        """)
        export_html_btn.clicked.connect(lambda: self._export_report("html"))
        export_layout.addWidget(export_html_btn)
        
        right_layout.addLayout(export_layout)
        
        splitter.addWidget(right_panel)
        splitter.setSizes([350, 700])
        
        layout.addWidget(splitter)
    
    def _browse_file(self):
        """Browse for malware sample"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Select Malware Sample",
            "",
            "All Files (*.*)"
        )
        if file_path:
            self.file_path_input.setText(file_path)
    
    def _start_analysis(self):
        """Start malware analysis"""
        if not self.engine:
            self._log("Malware analysis engine not available", "error")
            return
        
        file_path = self.file_path_input.text().strip()
        if not file_path:
            QMessageBox.warning(self, "Error", "Please select a file to analyze")
            return
        
        # Get analysis types
        from core.malware_analysis import AnalysisType
        analysis_types = []
        if self.static_check.isChecked():
            analysis_types.append(AnalysisType.STATIC)
        if self.behavioral_check.isChecked():
            analysis_types.append(AnalysisType.BEHAVIORAL)
        if self.dynamic_check.isChecked():
            analysis_types.append(AnalysisType.DYNAMIC)
        if self.network_check.isChecked():
            analysis_types.append(AnalysisType.NETWORK)
        if self.memory_check.isChecked():
            analysis_types.append(AnalysisType.MEMORY)
        
        # Update YARA path
        self.engine.yara_rules_path = self.yara_path_input.text().strip()
        
        # Clear previous results
        self._clear_results()
        
        # Start worker
        self.analysis_worker = AnalysisWorker(self.engine, file_path, analysis_types)
        self.analysis_worker.progress.connect(self._update_progress)
        self.analysis_worker.finished.connect(self._analysis_complete)
        self.analysis_worker.error.connect(self._analysis_error)
        self.analysis_worker.log.connect(self._log)
        
        self.analyze_btn.setEnabled(False)
        self.stop_btn.setEnabled(True)
        self.status_label.setText("Starting analysis...")
        
        self.analysis_worker.start()
    
    def _stop_analysis(self):
        """Stop running analysis"""
        if self.analysis_worker and self.analysis_worker.isRunning():
            self.analysis_worker.terminate()
            self.analysis_worker.wait()
            self._log("Analysis stopped by user", "warning")
        
        self.analyze_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.status_label.setText("Analysis stopped")
    
    def _update_progress(self, value: int, status: str):
        """Update progress bar"""
        self.progress_bar.setValue(value)
        self.status_label.setText(status)
    
    def _analysis_complete(self, report):
        """Handle analysis completion"""
        self.current_report = report
        self.analyze_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.status_label.setText(f"Analysis complete in {report.analysis_time:.2f}s")
        
        self._display_results(report)
        self._log(f"Analysis complete: {report.threat_level.value} threat detected", "info")
    
    def _analysis_error(self, error: str):
        """Handle analysis error"""
        self.analyze_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.status_label.setText("Analysis failed")
        self._log(f"Error: {error}", "error")
        QMessageBox.critical(self, "Analysis Error", error)
    
    def _clear_results(self):
        """Clear all result displays"""
        self.overview_text.clear()
        self.file_info_table.setRowCount(0)
        self.strings_tree.clear()
        self.pe_tree.clear()
        self.yara_table.setRowCount(0)
        self.behaviors_table.setRowCount(0)
        self.iocs_table.setRowCount(0)
        self.mitre_table.setRowCount(0)
        self.log_output.clear()
        
        self.stat_threat.setText("-")
        self.stat_type.setText("-")
        self.stat_yara.setText("-")
        self.stat_behaviors.setText("-")
        self.stat_iocs.setText("-")
    
    def _display_results(self, report):
        """Display analysis results"""
        # Update quick stats
        threat_colors = {
            "benign": "#00ff00",
            "low": "#ffff00",
            "medium": "#ffa500",
            "high": "#ff4500",
            "critical": "#ff0000"
        }
        threat_level = report.threat_level.value
        self.stat_threat.setText(threat_level.upper())
        self.stat_threat.setStyleSheet(f"color: {threat_colors.get(threat_level, '#fff')}; font-weight: bold;")
        
        self.stat_type.setText(report.malware_type.value.upper())
        self.stat_yara.setText(str(len(report.yara_matches)))
        self.stat_behaviors.setText(str(len(report.behaviors)))
        self.stat_iocs.setText(str(len(report.iocs)))
        
        # Overview
        overview = f"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  MALWARE ANALYSIS REPORT                                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÅ FILE: {report.file_info.name}
üìè SIZE: {report.file_info.size:,} bytes
üìÑ TYPE: {report.file_info.file_type}
üî¢ ENTROPY: {report.file_info.entropy:.4f}

üîí HASHES:
   MD5:    {report.file_info.md5}
   SHA1:   {report.file_info.sha1}
   SHA256: {report.file_info.sha256}

‚ö†Ô∏è CLASSIFICATION:
   Threat Level: {report.threat_level.value.upper()}
   Malware Type: {report.malware_type.value}
   Confidence:   {report.confidence:.1f}%

üìä SUMMARY:
   YARA Matches:    {len(report.yara_matches)}
   Behaviors:       {len(report.behaviors)}
   IOCs Extracted:  {len(report.iocs)}
   MITRE Techniques: {len(report.mitre_techniques)}

‚è±Ô∏è Analysis completed in {report.analysis_time:.2f} seconds
"""
        self.overview_text.setPlainText(overview)
        
        # File info table
        file_info_items = [
            ("Filename", report.file_info.name),
            ("Path", report.file_info.path),
            ("Size", f"{report.file_info.size:,} bytes"),
            ("File Type", report.file_info.file_type),
            ("Magic Bytes", report.file_info.magic_bytes[:32] + "..."),
            ("Entropy", f"{report.file_info.entropy:.4f}"),
            ("MD5", report.file_info.md5),
            ("SHA1", report.file_info.sha1),
            ("SHA256", report.file_info.sha256),
            ("Created", str(report.file_info.created)),
            ("Modified", str(report.file_info.modified))
        ]
        
        self.file_info_table.setRowCount(len(file_info_items))
        for i, (prop, value) in enumerate(file_info_items):
            self.file_info_table.setItem(i, 0, QTableWidgetItem(prop))
            self.file_info_table.setItem(i, 1, QTableWidgetItem(str(value)))
        
        # Strings tree
        if report.strings:
            strings_categories = [
                ("URLs", report.strings.urls),
                ("IP Addresses", report.strings.ip_addresses),
                ("Domains", report.strings.domains),
                ("Email Addresses", report.strings.emails),
                ("Registry Keys", report.strings.registry_keys),
                ("File Paths", report.strings.file_paths),
                ("Crypto Strings", report.strings.crypto_strings),
                ("Suspicious Strings", report.strings.suspicious_strings)
            ]
            
            for category, strings in strings_categories:
                if strings:
                    parent = QTreeWidgetItem([category, str(len(strings)), ", ".join(strings[:3]) + ("..." if len(strings) > 3 else "")])
                    for s in strings:
                        QTreeWidgetItem(parent, ["", "", s])
                    self.strings_tree.addTopLevelItem(parent)
        
        # PE Analysis tree
        if report.pe_analysis and report.pe_analysis.is_pe:
            pe = report.pe_analysis
            
            # Basic info
            basic = QTreeWidgetItem(["Basic Info", "", ""])
            QTreeWidgetItem(basic, ["Architecture", pe.architecture, ""])
            QTreeWidgetItem(basic, ["Entry Point", f"0x{pe.entry_point:08x}", ""])
            QTreeWidgetItem(basic, ["Image Base", f"0x{pe.image_base:08x}", ""])
            QTreeWidgetItem(basic, ["Subsystem", pe.subsystem, ""])
            QTreeWidgetItem(basic, ["Compile Time", str(pe.compile_time), ""])
            self.pe_tree.addTopLevelItem(basic)
            
            # Sections
            sections = QTreeWidgetItem(["Sections", str(len(pe.sections)), ""])
            for sec in pe.sections:
                notes = []
                if sec.get("entropy", 0) > 7.0:
                    notes.append("HIGH ENTROPY")
                if sec.get("executable"):
                    notes.append("EXEC")
                if sec.get("writable"):
                    notes.append("WRITE")
                QTreeWidgetItem(sections, [
                    sec.get("name", ""),
                    f"Size: {sec.get('raw_size', 0):,}, Entropy: {sec.get('entropy', 0):.2f}",
                    ", ".join(notes)
                ])
            self.pe_tree.addTopLevelItem(sections)
            
            # Anomalies
            if pe.anomalies:
                anomalies = QTreeWidgetItem(["Anomalies", str(len(pe.anomalies)), "‚ö†Ô∏è"])
                for a in pe.anomalies:
                    QTreeWidgetItem(anomalies, ["", a, ""])
                self.pe_tree.addTopLevelItem(anomalies)
        
        # YARA matches
        self.yara_table.setRowCount(len(report.yara_matches))
        for i, match in enumerate(report.yara_matches):
            self.yara_table.setItem(i, 0, QTableWidgetItem(match.rule_name))
            self.yara_table.setItem(i, 1, QTableWidgetItem(", ".join(match.tags)))
            severity = match.meta.get("severity", "unknown")
            severity_item = QTableWidgetItem(severity)
            if severity == "critical":
                severity_item.setForeground(QColor("#ff0000"))
            elif severity == "high":
                severity_item.setForeground(QColor("#ff4500"))
            elif severity == "medium":
                severity_item.setForeground(QColor("#ffa500"))
            self.yara_table.setItem(i, 2, severity_item)
            self.yara_table.setItem(i, 3, QTableWidgetItem(str(len(match.strings))))
        
        # Behaviors
        self.behaviors_table.setRowCount(len(report.behaviors))
        for i, behavior in enumerate(report.behaviors):
            severity_item = QTableWidgetItem(behavior.severity.value.upper())
            if behavior.severity.value == "critical":
                severity_item.setForeground(QColor("#ff0000"))
            elif behavior.severity.value == "high":
                severity_item.setForeground(QColor("#ff4500"))
            elif behavior.severity.value == "medium":
                severity_item.setForeground(QColor("#ffa500"))
            self.behaviors_table.setItem(i, 0, severity_item)
            self.behaviors_table.setItem(i, 1, QTableWidgetItem(behavior.category))
            self.behaviors_table.setItem(i, 2, QTableWidgetItem(behavior.description))
            self.behaviors_table.setItem(i, 3, QTableWidgetItem(", ".join(behavior.mitre_attack)))
        
        # IOCs
        self.iocs_table.setRowCount(len(report.iocs))
        for i, ioc in enumerate(report.iocs):
            self.iocs_table.setItem(i, 0, QTableWidgetItem(ioc.get("type", "")))
            self.iocs_table.setItem(i, 1, QTableWidgetItem(ioc.get("value", "")))
            self.iocs_table.setItem(i, 2, QTableWidgetItem(f"{ioc.get('confidence', 0)}%"))
        
        # MITRE ATT&CK
        self.mitre_table.setRowCount(len(report.mitre_techniques))
        for i, technique in enumerate(report.mitre_techniques):
            self.mitre_table.setItem(i, 0, QTableWidgetItem(technique.get("id", "")))
            self.mitre_table.setItem(i, 1, QTableWidgetItem(technique.get("name", "")))
    
    def _log(self, message: str, level: str = "info"):
        """Add log message"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        colors = {
            "info": "#00ff88",
            "warning": "#ffaa00",
            "error": "#ff4444",
            "debug": "#888888"
        }
        color = colors.get(level, "#ffffff")
        self.log_output.append(f'<span style="color: #888;">[{timestamp}]</span> <span style="color: {color};">[{level.upper()}]</span> {message}')
    
    def _export_report(self, format: str):
        """Export analysis report"""
        if not self.current_report:
            QMessageBox.warning(self, "Export Error", "No analysis report to export")
            return
        
        extensions = {"json": "JSON Files (*.json)", "markdown": "Markdown Files (*.md)", "html": "HTML Files (*.html)"}
        ext_map = {"json": ".json", "markdown": ".md", "html": ".html"}
        
        file_path, _ = QFileDialog.getSaveFileName(
            self,
            f"Export Report as {format.upper()}",
            f"malware_report{ext_map[format]}",
            extensions[format]
        )
        
        if file_path:
            try:
                import asyncio
                loop = asyncio.new_event_loop()
                content = loop.run_until_complete(self.engine.generate_report(self.current_report, format))
                loop.close()
                
                with open(file_path, "w") as f:
                    f.write(content)
                
                self._log(f"Report exported to {file_path}", "info")
                QMessageBox.information(self, "Export Complete", f"Report saved to:\n{file_path}")
            except Exception as e:
                self._log(f"Export error: {e}", "error")
                QMessageBox.critical(self, "Export Error", str(e))
    
    def _export_iocs(self):
        """Export IOCs"""
        if not self.current_report or not self.current_report.iocs:
            QMessageBox.warning(self, "Export Error", "No IOCs to export")
            return
        
        file_path, _ = QFileDialog.getSaveFileName(
            self,
            "Export IOCs",
            "iocs.json",
            "JSON Files (*.json)"
        )
        
        if file_path:
            try:
                with open(file_path, "w") as f:
                    json.dump(self.current_report.iocs, f, indent=2)
                
                self._log(f"IOCs exported to {file_path}", "info")
                QMessageBox.information(self, "Export Complete", f"IOCs saved to:\n{file_path}")
            except Exception as e:
                self._log(f"Export error: {e}", "error")
                QMessageBox.critical(self, "Export Error", str(e))
