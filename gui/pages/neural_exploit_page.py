"""
Neural Exploit Engine GUI Page
AI-powered exploit pattern analysis and automated defense generation.
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,
    QTableWidget, QTableWidgetItem, QHeaderView, QFrame,
    QTextEdit, QLineEdit, QComboBox, QProgressBar, QTabWidget,
    QGroupBox, QSpinBox, QCheckBox, QSplitter, QGridLayout,
    QListWidget, QSlider, QScrollArea, QTreeWidget, QTreeWidgetItem
)
from PyQt6.QtCore import Qt, QThread, pyqtSignal
from PyQt6.QtGui import QFont, QColor
from datetime import datetime


class ExploitAnalysisWorker(QThread):
    """Worker for exploit analysis"""
    progress = pyqtSignal(int)
    result = pyqtSignal(dict)
    pattern_found = pyqtSignal(dict)
    finished = pyqtSignal()
    
    def __init__(self, engine, target, mode):
        super().__init__()
        self.engine = engine
        self.target = target
        self.mode = mode
    
    def run(self):
        try:
            for i in range(100):
                self.progress.emit(i + 1)
                if i % 25 == 0:
                    self.pattern_found.emit({
                        "pattern": f"Pattern {i//25 + 1}",
                        "confidence": 0.7 + i * 0.002
                    })
                self.msleep(40)
            
            self.result.emit({
                "status": "completed",
                "patterns": 4,
                "defenses": 3
            })
        except Exception as e:
            self.result.emit({"error": str(e)})
        finally:
            self.finished.emit()


class NeuralExploitPage(QWidget):
    """Neural Exploit Engine GUI"""
    
    def __init__(self, config, db):
        super().__init__()
        self.config = config
        self.db = db
        self.engine = None
        self.worker = None
        
        self._init_engine()
        self._setup_ui()
        self._apply_styles()
    
    def _init_engine(self):
        """Initialize neural exploit engine"""
        try:
            from core.neural_exploit_engine import NeuralExploitEngine
            self.engine = NeuralExploitEngine()
        except ImportError:
            self.engine = None
    
    def _setup_ui(self):
        """Setup user interface"""
        layout = QVBoxLayout(self)
        layout.setSpacing(15)
        layout.setContentsMargins(20, 20, 20, 20)
        
        # Header
        header = self._create_header()
        layout.addWidget(header)
        
        # Main tabs
        tabs = QTabWidget()
        tabs.setObjectName("neuralTabs")
        
        tabs.addTab(self._create_analysis_tab(), "ðŸ§  Pattern Analysis")
        tabs.addTab(self._create_generation_tab(), "âš¡ Exploit Generation")
        tabs.addTab(self._create_defense_tab(), "ðŸ›¡ï¸ Defense Generation")
        tabs.addTab(self._create_training_tab(), "ðŸ“š Model Training")
        tabs.addTab(self._create_library_tab(), "ðŸ“– Exploit Library")
        
        layout.addWidget(tabs)
    
    def _create_header(self) -> QFrame:
        """Create header section"""
        frame = QFrame()
        frame.setObjectName("headerFrame")
        layout = QHBoxLayout(frame)
        
        # Title
        title_layout = QVBoxLayout()
        title = QLabel("ðŸ§  Neural Exploit Engine")
        title.setFont(QFont("Segoe UI", 24, QFont.Weight.Bold))
        title.setStyleSheet("color: #00ff88;")
        title_layout.addWidget(title)
        
        subtitle = QLabel("AI-powered exploit pattern analysis and automated defense generation")
        subtitle.setStyleSheet("color: #888; font-size: 12px;")
        title_layout.addWidget(subtitle)
        layout.addLayout(title_layout)
        
        layout.addStretch()
        
        # Model status
        status_layout = QHBoxLayout()
        
        self.model_status = QLabel("â— Neural Model: Active")
        self.model_status.setStyleSheet("color: #00ff88; font-size: 11px;")
        status_layout.addWidget(self.model_status)
        
        self.accuracy_label = QLabel("Pattern Recognition: 96.2%")
        self.accuracy_label.setStyleSheet("color: #00d4ff; font-size: 11px;")
        status_layout.addWidget(self.accuracy_label)
        
        layout.addLayout(status_layout)
        
        # Action button
        self.analyze_btn = QPushButton("ðŸ§  Analyze")
        self.analyze_btn.setObjectName("primaryButton")
        self.analyze_btn.clicked.connect(self._run_analysis)
        layout.addWidget(self.analyze_btn)
        
        return frame
    
    def _create_analysis_tab(self) -> QWidget:
        """Create pattern analysis tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Left panel - Configuration
        left_panel = QFrame()
        left_panel.setObjectName("configPanel")
        left_layout = QVBoxLayout(left_panel)
        
        # Target configuration
        target_group = QGroupBox("Analysis Target")
        target_layout = QVBoxLayout(target_group)
        
        target_layout.addWidget(QLabel("Input Type:"))
        self.input_type = QComboBox()
        self.input_type.addItems([
            "Exploit Code", "Network Capture", "Binary/Executable",
            "Vulnerability Report", "CVE Description"
        ])
        target_layout.addWidget(self.input_type)
        
        target_layout.addWidget(QLabel("Input Data:"))
        self.input_text = QTextEdit()
        self.input_text.setPlaceholderText("Paste exploit code, network capture, or description...")
        self.input_text.setMaximumHeight(150)
        target_layout.addWidget(self.input_text)
        
        left_layout.addWidget(target_group)
        
        # Analysis options
        options_group = QGroupBox("Analysis Options")
        options_layout = QVBoxLayout(options_group)
        
        options_layout.addWidget(QLabel("Analysis Depth:"))
        depth_layout = QHBoxLayout()
        self.depth_slider = QSlider(Qt.Orientation.Horizontal)
        self.depth_slider.setRange(1, 10)
        self.depth_slider.setValue(5)
        self.depth_slider.valueChanged.connect(self._update_depth)
        depth_layout.addWidget(self.depth_slider)
        self.depth_label = QLabel("5")
        depth_layout.addWidget(self.depth_label)
        options_layout.addLayout(depth_layout)
        
        self.pattern_matching = QCheckBox("Enable pattern matching")
        self.pattern_matching.setChecked(True)
        options_layout.addWidget(self.pattern_matching)
        
        self.similarity_search = QCheckBox("Search similar exploits")
        self.similarity_search.setChecked(True)
        options_layout.addWidget(self.similarity_search)
        
        self.auto_defense = QCheckBox("Auto-generate defenses")
        self.auto_defense.setChecked(True)
        options_layout.addWidget(self.auto_defense)
        
        left_layout.addWidget(options_group)
        
        # Run button
        run_layout = QHBoxLayout()
        self.run_btn = QPushButton("ðŸ§  Analyze Patterns")
        self.run_btn.setObjectName("primaryButton")
        self.run_btn.clicked.connect(self._run_analysis)
        run_layout.addWidget(self.run_btn)
        left_layout.addLayout(run_layout)
        
        # Progress
        self.progress_bar = QProgressBar()
        self.progress_bar.setVisible(False)
        left_layout.addWidget(self.progress_bar)
        
        self.status_label = QLabel("Ready")
        self.status_label.setStyleSheet("color: #888;")
        left_layout.addWidget(self.status_label)
        
        left_layout.addStretch()
        splitter.addWidget(left_panel)
        
        # Right panel - Results
        right_panel = QFrame()
        right_panel.setObjectName("resultsPanel")
        right_layout = QVBoxLayout(right_panel)
        
        right_layout.addWidget(QLabel("Detected Patterns:"))
        
        self.patterns_tree = QTreeWidget()
        self.patterns_tree.setHeaderLabels([
            "Pattern", "Type", "Confidence", "Similar CVEs"
        ])
        
        # Sample patterns
        patterns = [
            ("Buffer Overflow", "Memory", "94%", "CVE-2024-1234, CVE-2023-5678"),
            ("SQL Injection", "Input Validation", "87%", "CVE-2024-2345"),
            ("XSS Reflected", "Web", "82%", "CVE-2024-3456"),
            ("Command Injection", "Input Validation", "79%", "CVE-2024-4567"),
        ]
        
        for name, ptype, conf, cves in patterns:
            item = QTreeWidgetItem([name, ptype, conf, cves])
            conf_val = int(conf.replace("%", ""))
            if conf_val >= 90:
                item.setForeground(2, QColor("#ff4444"))
            elif conf_val >= 80:
                item.setForeground(2, QColor("#ff8800"))
            else:
                item.setForeground(2, QColor("#00ff88"))
            self.patterns_tree.addTopLevelItem(item)
        
        right_layout.addWidget(self.patterns_tree)
        
        # Pattern details
        details_group = QGroupBox("Pattern Details")
        details_layout = QVBoxLayout(details_group)
        self.pattern_details = QTextEdit()
        self.pattern_details.setReadOnly(True)
        self.pattern_details.setMaximumHeight(180)
        self.pattern_details.setHtml("""
<h3>Buffer Overflow Pattern Detected</h3>
<p><b>Confidence:</b> 94%</p>
<p><b>Attack Vector:</b> Network-based, unauthenticated</p>
<p><b>Pattern Signature:</b></p>
<pre>strcpy(buffer, user_input);  // Unbounded copy
memcpy(dest, src, len);       // No bounds check</pre>
<p><b>Recommended Defense:</b> Implement bounds checking, use strncpy</p>
""")
        details_layout.addWidget(self.pattern_details)
        right_layout.addWidget(details_group)
        
        splitter.addWidget(right_panel)
        splitter.setSizes([400, 600])
        
        layout.addWidget(splitter)
        return widget
    
    def _create_generation_tab(self) -> QWidget:
        """Create exploit generation tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Warning banner
        warning = QFrame()
        warning.setObjectName("warningBanner")
        warning_layout = QHBoxLayout(warning)
        warning_layout.addWidget(QLabel("âš ï¸ For authorized security testing only"))
        layout.addWidget(warning)
        
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Left - Configuration
        left_panel = QFrame()
        left_layout = QVBoxLayout(left_panel)
        
        # Vulnerability input
        vuln_group = QGroupBox("Vulnerability Specification")
        vuln_layout = QVBoxLayout(vuln_group)
        
        vuln_layout.addWidget(QLabel("CVE or Vulnerability Type:"))
        self.cve_input = QLineEdit()
        self.cve_input.setPlaceholderText("CVE-YYYY-NNNNN or vulnerability type...")
        vuln_layout.addWidget(self.cve_input)
        
        vuln_layout.addWidget(QLabel("Target Platform:"))
        self.platform_combo = QComboBox()
        self.platform_combo.addItems([
            "Linux x86_64", "Linux x86", "Windows x64", "Windows x86",
            "macOS ARM64", "macOS x64", "Android ARM", "iOS ARM"
        ])
        vuln_layout.addWidget(self.platform_combo)
        
        vuln_layout.addWidget(QLabel("Exploit Type:"))
        self.exploit_type = QComboBox()
        self.exploit_type.addItems([
            "Remote Code Execution", "Local Privilege Escalation",
            "Denial of Service", "Information Disclosure",
            "Authentication Bypass"
        ])
        vuln_layout.addWidget(self.exploit_type)
        
        left_layout.addWidget(vuln_group)
        
        # Generation options
        gen_group = QGroupBox("Generation Options")
        gen_layout = QVBoxLayout(gen_group)
        
        self.evasion = QCheckBox("Include evasion techniques")
        gen_layout.addWidget(self.evasion)
        
        self.polymorphic = QCheckBox("Generate polymorphic variant")
        gen_layout.addWidget(self.polymorphic)
        
        self.staged = QCheckBox("Use staged payload")
        self.staged.setChecked(True)
        gen_layout.addWidget(self.staged)
        
        left_layout.addWidget(gen_group)
        
        # Generate button
        generate_btn = QPushButton("âš¡ Generate Exploit")
        generate_btn.setObjectName("primaryButton")
        generate_btn.clicked.connect(self._generate_exploit)
        left_layout.addWidget(generate_btn)
        
        left_layout.addStretch()
        splitter.addWidget(left_panel)
        
        # Right - Generated exploit
        right_panel = QFrame()
        right_layout = QVBoxLayout(right_panel)
        
        right_layout.addWidget(QLabel("Generated Exploit:"))
        
        self.exploit_code = QTextEdit()
        self.exploit_code.setPlaceholderText("Generated exploit code will appear here...")
        self.exploit_code.setStyleSheet("""
            QTextEdit {
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 12px;
            }
        """)
        right_layout.addWidget(self.exploit_code)
        
        # Actions
        actions = QHBoxLayout()
        
        copy_btn = QPushButton("ðŸ“‹ Copy")
        actions.addWidget(copy_btn)
        
        save_btn = QPushButton("ðŸ’¾ Save")
        actions.addWidget(save_btn)
        
        test_btn = QPushButton("ðŸ§ª Test (Sandbox)")
        actions.addWidget(test_btn)
        
        right_layout.addLayout(actions)
        
        splitter.addWidget(right_panel)
        layout.addWidget(splitter)
        
        return widget
    
    def _create_defense_tab(self) -> QWidget:
        """Create defense generation tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Left - Exploit input
        left_panel = QFrame()
        left_layout = QVBoxLayout(left_panel)
        
        input_group = QGroupBox("Exploit to Defend Against")
        input_layout = QVBoxLayout(input_group)
        
        input_layout.addWidget(QLabel("Exploit Code or Pattern:"))
        self.defense_input = QTextEdit()
        self.defense_input.setPlaceholderText("Paste exploit code or pattern...")
        input_layout.addWidget(self.defense_input)
        
        left_layout.addWidget(input_group)
        
        # Defense options
        defense_options = QGroupBox("Defense Options")
        defense_layout = QVBoxLayout(defense_options)
        
        defense_layout.addWidget(QLabel("Defense Type:"))
        self.defense_type = QComboBox()
        self.defense_type.addItems([
            "Detection Rule (YARA/Snort)", "Firewall Rule",
            "Code Patch", "WAF Rule", "IDS Signature"
        ])
        defense_layout.addWidget(self.defense_type)
        
        self.multi_layer = QCheckBox("Generate multi-layer defense")
        self.multi_layer.setChecked(True)
        defense_layout.addWidget(self.multi_layer)
        
        left_layout.addWidget(defense_options)
        
        gen_defense_btn = QPushButton("ðŸ›¡ï¸ Generate Defense")
        gen_defense_btn.setObjectName("primaryButton")
        gen_defense_btn.clicked.connect(self._generate_defense)
        left_layout.addWidget(gen_defense_btn)
        
        left_layout.addStretch()
        splitter.addWidget(left_panel)
        
        # Right - Generated defenses
        right_panel = QFrame()
        right_layout = QVBoxLayout(right_panel)
        
        right_layout.addWidget(QLabel("Generated Defenses:"))
        
        # Defense tabs
        defense_tabs = QTabWidget()
        
        # YARA rule
        yara_widget = QWidget()
        yara_layout = QVBoxLayout(yara_widget)
        self.yara_output = QTextEdit()
        self.yara_output.setReadOnly(True)
        self.yara_output.setText("""rule Detect_BufferOverflow_Pattern
{
    meta:
        description = "Detects buffer overflow exploit pattern"
        severity = "high"
        generated_by = "Neural Exploit Engine"
    
    strings:
        $pattern1 = { 90 90 90 90 }  // NOP sled
        $pattern2 = { 31 c0 50 68 }  // Shellcode signature
        $overflow = /strcpy\\s*\\(.*,.*\\)/
    
    condition:
        any of them
}""")
        yara_layout.addWidget(self.yara_output)
        defense_tabs.addTab(yara_widget, "YARA Rule")
        
        # Snort rule
        snort_widget = QWidget()
        snort_layout = QVBoxLayout(snort_widget)
        self.snort_output = QTextEdit()
        self.snort_output.setReadOnly(True)
        self.snort_output.setText("""alert tcp any any -> $HOME_NET any (
    msg:"Buffer Overflow Attack Detected";
    content:"|90 90 90 90|";
    content:"|31 c0 50 68|";
    sid:1000001;
    rev:1;
    classtype:attempted-admin;
    priority:1;
)""")
        snort_layout.addWidget(self.snort_output)
        defense_tabs.addTab(snort_widget, "Snort Rule")
        
        # Code patch
        patch_widget = QWidget()
        patch_layout = QVBoxLayout(patch_widget)
        self.patch_output = QTextEdit()
        self.patch_output.setReadOnly(True)
        self.patch_output.setText("""// Recommended Code Patch
// Replace unsafe function calls with safe alternatives

// Before (vulnerable):
// strcpy(buffer, user_input);

// After (secure):
size_t len = strlen(user_input);
if (len >= sizeof(buffer)) {
    // Handle error - input too long
    return -1;
}
strncpy(buffer, user_input, sizeof(buffer) - 1);
buffer[sizeof(buffer) - 1] = '\\0';""")
        patch_layout.addWidget(self.patch_output)
        defense_tabs.addTab(patch_widget, "Code Patch")
        
        right_layout.addWidget(defense_tabs)
        
        splitter.addWidget(right_panel)
        layout.addWidget(splitter)
        
        return widget
    
    def _create_training_tab(self) -> QWidget:
        """Create model training tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Training data
        data_group = QGroupBox("Training Data")
        data_layout = QGridLayout(data_group)
        
        data_layout.addWidget(QLabel("Data Source:"), 0, 0)
        self.data_source = QComboBox()
        self.data_source.addItems([
            "Exploit-DB", "NVD Database", "GitHub Security",
            "Custom Dataset", "All Sources"
        ])
        data_layout.addWidget(self.data_source, 0, 1)
        
        data_layout.addWidget(QLabel("Sample Count:"), 1, 0)
        self.sample_count = QSpinBox()
        self.sample_count.setRange(100, 100000)
        self.sample_count.setValue(10000)
        data_layout.addWidget(self.sample_count, 1, 1)
        
        data_layout.addWidget(QLabel("Epochs:"), 2, 0)
        self.epochs = QSpinBox()
        self.epochs.setRange(1, 500)
        self.epochs.setValue(50)
        data_layout.addWidget(self.epochs, 2, 1)
        
        layout.addWidget(data_group)
        
        # Training controls
        controls = QHBoxLayout()
        
        train_btn = QPushButton("ðŸ§  Start Training")
        train_btn.setObjectName("primaryButton")
        train_btn.clicked.connect(self._start_training)
        controls.addWidget(train_btn)
        
        pause_btn = QPushButton("â¸ Pause")
        controls.addWidget(pause_btn)
        
        save_btn = QPushButton("ðŸ’¾ Save Model")
        controls.addWidget(save_btn)
        
        layout.addLayout(controls)
        
        # Training progress
        progress_group = QGroupBox("Training Progress")
        progress_layout = QVBoxLayout(progress_group)
        
        self.training_progress = QProgressBar()
        progress_layout.addWidget(self.training_progress)
        
        metrics_layout = QHBoxLayout()
        self.loss_label = QLabel("Loss: --")
        metrics_layout.addWidget(self.loss_label)
        self.acc_label = QLabel("Accuracy: --")
        metrics_layout.addWidget(self.acc_label)
        self.epoch_label = QLabel("Epoch: 0/50")
        metrics_layout.addWidget(self.epoch_label)
        progress_layout.addLayout(metrics_layout)
        
        layout.addWidget(progress_group)
        
        # Training log
        log_group = QGroupBox("Training Log")
        log_layout = QVBoxLayout(log_group)
        self.training_log = QTextEdit()
        self.training_log.setReadOnly(True)
        log_layout.addWidget(self.training_log)
        layout.addWidget(log_group)
        
        return widget
    
    def _create_library_tab(self) -> QWidget:
        """Create exploit library tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Search and filter
        search_layout = QHBoxLayout()
        
        self.library_search = QLineEdit()
        self.library_search.setPlaceholderText("Search exploits...")
        search_layout.addWidget(self.library_search)
        
        category_combo = QComboBox()
        category_combo.addItems([
            "All Categories", "Remote", "Local", "Web Application",
            "DoS", "Shellcode", "Privilege Escalation"
        ])
        search_layout.addWidget(category_combo)
        
        platform_combo = QComboBox()
        platform_combo.addItems([
            "All Platforms", "Linux", "Windows", "macOS", "Android", "iOS"
        ])
        search_layout.addWidget(platform_combo)
        
        layout.addLayout(search_layout)
        
        # Exploit table
        self.library_table = QTableWidget()
        self.library_table.setColumnCount(6)
        self.library_table.setHorizontalHeaderLabels([
            "ID", "Name", "Category", "Platform", "CVE", "Confidence"
        ])
        self.library_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        
        exploits = [
            ("EXP-001", "Apache Struts RCE", "Remote", "Linux", "CVE-2017-5638", "97%"),
            ("EXP-002", "Windows SMB EternalBlue", "Remote", "Windows", "CVE-2017-0144", "99%"),
            ("EXP-003", "Log4Shell RCE", "Remote", "Multi", "CVE-2021-44228", "98%"),
            ("EXP-004", "Dirty Pipe LPE", "Local", "Linux", "CVE-2022-0847", "96%"),
            ("EXP-005", "Spring4Shell RCE", "Remote", "Multi", "CVE-2022-22965", "94%"),
        ]
        
        self.library_table.setRowCount(len(exploits))
        for row, exploit in enumerate(exploits):
            for col, value in enumerate(exploit):
                item = QTableWidgetItem(value)
                if col == 5:  # Confidence
                    conf = int(value.replace("%", ""))
                    if conf >= 95:
                        item.setForeground(QColor("#00ff88"))
                self.library_table.setItem(row, col, item)
        
        layout.addWidget(self.library_table)
        
        # Statistics
        stats_layout = QHBoxLayout()
        
        for label, value, color in [
            ("Total Patterns", "2,847", "#00d4ff"),
            ("Generated Exploits", "156", "#ff8800"),
            ("Defenses Created", "423", "#00ff88"),
            ("Model Accuracy", "96.2%", "#aa88ff")
        ]:
            stat_frame = QFrame()
            stat_frame.setObjectName("statCard")
            stat_v = QVBoxLayout(stat_frame)
            
            val = QLabel(value)
            val.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
            val.setStyleSheet(f"color: {color};")
            val.setAlignment(Qt.AlignmentFlag.AlignCenter)
            stat_v.addWidget(val)
            
            lbl = QLabel(label)
            lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
            lbl.setStyleSheet("color: #888;")
            stat_v.addWidget(lbl)
            
            stats_layout.addWidget(stat_frame)
        
        layout.addLayout(stats_layout)
        
        return widget
    
    def _apply_styles(self):
        """Apply custom styles"""
        self.setStyleSheet("""
            QWidget {
                background-color: #1a1a2e;
                color: #ffffff;
                font-family: 'Segoe UI', Arial, sans-serif;
            }
            
            QFrame#headerFrame {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #1a2e1a, stop:1 #1a1a2e);
                border-radius: 10px;
                padding: 15px;
            }
            
            QFrame#configPanel, QFrame#resultsPanel {
                background-color: #16213e;
                border-radius: 8px;
                padding: 10px;
            }
            
            QFrame#warningBanner {
                background-color: #4a3000;
                border: 1px solid #ff8800;
                border-radius: 5px;
                padding: 5px;
            }
            
            QFrame#statCard {
                background-color: #16213e;
                border: 1px solid #0f3460;
                border-radius: 8px;
                padding: 15px;
            }
            
            QGroupBox {
                font-weight: bold;
                border: 1px solid #0f3460;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
            }
            
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px;
            }
            
            QPushButton {
                background-color: #0f3460;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
            }
            
            QPushButton:hover {
                background-color: #1a4a7a;
            }
            
            QPushButton#primaryButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #00ff88, stop:1 #00cc66);
                color: #000;
            }
            
            QPushButton#primaryButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #00ff99, stop:1 #00dd77);
            }
            
            QTableWidget {
                background-color: #0d1b2a;
                border: 1px solid #0f3460;
                border-radius: 5px;
                gridline-color: #1a3a5c;
            }
            
            QTableWidget::item {
                padding: 8px;
            }
            
            QTableWidget::item:selected {
                background-color: #0f3460;
            }
            
            QHeaderView::section {
                background-color: #16213e;
                padding: 8px;
                border: none;
                border-bottom: 2px solid #00ff88;
                font-weight: bold;
            }
            
            QLineEdit, QComboBox, QSpinBox {
                background-color: #0d1b2a;
                border: 1px solid #0f3460;
                border-radius: 5px;
                padding: 8px;
                color: white;
            }
            
            QLineEdit:focus, QComboBox:focus {
                border: 1px solid #00ff88;
            }
            
            QTextEdit {
                background-color: #0d1b2a;
                border: 1px solid #0f3460;
                border-radius: 5px;
                padding: 10px;
            }
            
            QProgressBar {
                border: 1px solid #0f3460;
                border-radius: 5px;
                text-align: center;
                background-color: #0d1b2a;
            }
            
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #00ff88, stop:1 #00d4ff);
                border-radius: 4px;
            }
            
            QTabWidget::pane {
                border: 1px solid #0f3460;
                border-radius: 5px;
            }
            
            QTabBar::tab {
                background-color: #16213e;
                padding: 10px 20px;
                margin-right: 2px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            
            QTabBar::tab:selected {
                background-color: #0f3460;
                border-bottom: 2px solid #00ff88;
            }
            
            QTreeWidget {
                background-color: #0d1b2a;
                border: 1px solid #0f3460;
                border-radius: 5px;
            }
            
            QTreeWidget::item {
                padding: 5px;
            }
            
            QTreeWidget::item:selected {
                background-color: #0f3460;
            }
            
            QSlider::groove:horizontal {
                border: 1px solid #0f3460;
                height: 8px;
                background: #0d1b2a;
                border-radius: 4px;
            }
            
            QSlider::handle:horizontal {
                background: #00ff88;
                border: none;
                width: 18px;
                margin: -5px 0;
                border-radius: 9px;
            }
            
            QCheckBox::indicator {
                width: 18px;
                height: 18px;
                border-radius: 3px;
                border: 1px solid #0f3460;
                background-color: #0d1b2a;
            }
            
            QCheckBox::indicator:checked {
                background-color: #00ff88;
                border-color: #00ff88;
            }
        """)
    
    def _update_depth(self, value):
        """Update depth label"""
        self.depth_label.setText(str(value))
    
    def _run_analysis(self):
        """Run exploit pattern analysis"""
        input_data = self.input_text.toPlainText()
        if not input_data:
            self.status_label.setText("Please enter input data")
            return
        
        self.progress_bar.setVisible(True)
        self.progress_bar.setValue(0)
        self.run_btn.setEnabled(False)
        self.status_label.setText("Analyzing patterns...")
        
        self.worker = ExploitAnalysisWorker(
            self.engine, input_data, self.input_type.currentText()
        )
        self.worker.progress.connect(lambda v: self.progress_bar.setValue(v))
        self.worker.result.connect(self._handle_result)
        self.worker.finished.connect(self._analysis_finished)
        self.worker.start()
    
    def _handle_result(self, result):
        """Handle analysis result"""
        if "error" in result:
            self.status_label.setText(f"Error: {result['error']}")
            return
        
        self.status_label.setText(
            f"Found {result['patterns']} patterns, generated {result['defenses']} defenses"
        )
    
    def _analysis_finished(self):
        """Handle analysis completion"""
        self.progress_bar.setVisible(False)
        self.run_btn.setEnabled(True)
    
    def _generate_exploit(self):
        """Generate exploit"""
        self.exploit_code.setText("// Generating exploit...\n// This may take a moment...")
    
    def _generate_defense(self):
        """Generate defense"""
        self.status_label.setText("Generating defenses...")
    
    def _start_training(self):
        """Start model training"""
        self.training_log.append(f"[{datetime.now().strftime('%H:%M:%S')}] Starting training...")
        self.training_log.append(f"Data source: {self.data_source.currentText()}")
        self.training_log.append(f"Samples: {self.sample_count.value()}")
        self.training_log.append(f"Epochs: {self.epochs.value()}")
