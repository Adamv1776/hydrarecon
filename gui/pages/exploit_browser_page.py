"""
Exploit Browser Page
GUI for searching and managing exploits
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,
    QLineEdit, QTextEdit, QTableWidget, QTableWidgetItem,
    QTabWidget, QGroupBox, QComboBox, QCheckBox, QProgressBar,
    QSplitter, QFrame, QHeaderView, QSpinBox, QListWidget,
    QListWidgetItem
)
from PyQt6.QtCore import Qt, pyqtSignal, QThread
from PyQt6.QtGui import QFont, QColor
import asyncio
import json


class ExploitSearchWorker(QThread):
    """Worker thread for exploit search"""
    progress = pyqtSignal(str)
    finished = pyqtSignal(object)
    error = pyqtSignal(str)
    
    def __init__(self, query, sources=None, exploit_type=None, platform=None):
        super().__init__()
        self.query = query
        self.sources = sources
        self.exploit_type = exploit_type
        self.platform = platform
        
    def run(self):
        try:
            # Import here to avoid circular imports
            import sys
            sys.path.insert(0, '..')
            from core.exploit_browser import ExploitBrowser
            
            async def search():
                browser = ExploitBrowser()
                results = await browser.search(
                    self.query,
                    limit=100
                )
                return results
                
            results = asyncio.run(search())
            self.finished.emit(results)
            
        except Exception as e:
            self.error.emit(str(e))


class ExploitBrowserPage(QWidget):
    """Exploit Browser Page"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self._setup_ui()
        
    def _setup_ui(self):
        """Setup the UI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(16)
        
        # Header
        header = QLabel("üíÄ Exploit Browser & Database")
        header.setStyleSheet("""
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            padding-bottom: 10px;
        """)
        layout.addWidget(header)
        
        # Search section
        search_group = QGroupBox("Search Exploits")
        search_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 1px solid #333;
                border-radius: 8px;
                margin-top: 12px;
                padding-top: 10px;
                background-color: #1a1a2e;
            }
            QGroupBox::title {
                color: #ff6b6b;
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px;
            }
        """)
        search_layout = QVBoxLayout(search_group)
        
        # Search input row
        search_row = QHBoxLayout()
        
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("CVE-2021-44228, Apache Struts, Log4j, etc...")
        self.search_input.setStyleSheet("""
            QLineEdit {
                padding: 12px;
                border: 1px solid #333;
                border-radius: 5px;
                background-color: #16213e;
                color: white;
                font-size: 14px;
            }
        """)
        self.search_input.returnPressed.connect(self._search)
        
        self.search_btn = QPushButton("üîç Search")
        self.search_btn.setStyleSheet("""
            QPushButton {
                background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
                color: white;
                font-weight: bold;
                padding: 12px 30px;
                border-radius: 5px;
                border: none;
            }
            QPushButton:hover {
                background: linear-gradient(135deg, #ee5a5a, #ff6b6b);
            }
        """)
        self.search_btn.clicked.connect(self._search)
        
        search_row.addWidget(self.search_input)
        search_row.addWidget(self.search_btn)
        search_layout.addLayout(search_row)
        
        # Filters row
        filters_row = QHBoxLayout()
        
        # Platform filter
        platform_label = QLabel("Platform:")
        platform_label.setStyleSheet("color: #888;")
        self.platform_combo = QComboBox()
        self.platform_combo.addItems([
            "All", "Linux", "Windows", "macOS", "Web", "Android", "iOS", "Hardware"
        ])
        self.platform_combo.setStyleSheet("""
            QComboBox {
                padding: 8px;
                border: 1px solid #333;
                border-radius: 5px;
                background-color: #16213e;
                color: white;
                min-width: 100px;
            }
        """)
        
        # Type filter
        type_label = QLabel("Type:")
        type_label.setStyleSheet("color: #888;")
        self.type_combo = QComboBox()
        self.type_combo.addItems([
            "All", "Remote", "Local", "WebApps", "DoS", "Shellcode"
        ])
        self.type_combo.setStyleSheet("""
            QComboBox {
                padding: 8px;
                border: 1px solid #333;
                border-radius: 5px;
                background-color: #16213e;
                color: white;
                min-width: 100px;
            }
        """)
        
        # Sources
        self.source_exploitdb = QCheckBox("Exploit-DB")
        self.source_exploitdb.setChecked(True)
        self.source_exploitdb.setStyleSheet("color: white;")
        
        self.source_github = QCheckBox("GitHub")
        self.source_github.setChecked(True)
        self.source_github.setStyleSheet("color: white;")
        
        self.source_nvd = QCheckBox("NVD")
        self.source_nvd.setChecked(True)
        self.source_nvd.setStyleSheet("color: white;")
        
        filters_row.addWidget(platform_label)
        filters_row.addWidget(self.platform_combo)
        filters_row.addWidget(type_label)
        filters_row.addWidget(self.type_combo)
        filters_row.addStretch()
        filters_row.addWidget(self.source_exploitdb)
        filters_row.addWidget(self.source_github)
        filters_row.addWidget(self.source_nvd)
        
        search_layout.addLayout(filters_row)
        layout.addWidget(search_group)
        
        # Progress bar
        self.progress_bar = QProgressBar()
        self.progress_bar.setStyleSheet("""
            QProgressBar {
                border: 1px solid #333;
                border-radius: 5px;
                background-color: #16213e;
                height: 20px;
            }
            QProgressBar::chunk {
                background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
            }
        """)
        self.progress_bar.setVisible(False)
        layout.addWidget(self.progress_bar)
        
        # Results splitter
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Results list
        results_widget = QWidget()
        results_layout = QVBoxLayout(results_widget)
        results_layout.setContentsMargins(0, 0, 0, 0)
        
        results_label = QLabel("Search Results")
        results_label.setStyleSheet("color: #888; font-weight: bold;")
        results_layout.addWidget(results_label)
        
        self.results_list = QListWidget()
        self.results_list.setStyleSheet("""
            QListWidget {
                background-color: #16213e;
                color: white;
                border: 1px solid #333;
                border-radius: 5px;
            }
            QListWidget::item {
                padding: 10px;
                border-bottom: 1px solid #333;
            }
            QListWidget::item:selected {
                background-color: #0f3460;
            }
            QListWidget::item:hover {
                background-color: #1a3a5e;
            }
        """)
        self.results_list.currentRowChanged.connect(self._show_exploit_details)
        results_layout.addWidget(self.results_list)
        
        splitter.addWidget(results_widget)
        
        # Details panel
        details_widget = QWidget()
        details_layout = QVBoxLayout(details_widget)
        details_layout.setContentsMargins(0, 0, 0, 0)
        
        details_label = QLabel("Exploit Details")
        details_label.setStyleSheet("color: #888; font-weight: bold;")
        details_layout.addWidget(details_label)
        
        # Details tabs
        self.details_tabs = QTabWidget()
        self.details_tabs.setStyleSheet("""
            QTabWidget::pane {
                border: 1px solid #333;
                background-color: #1a1a2e;
                border-radius: 5px;
            }
            QTabBar::tab {
                background-color: #16213e;
                color: #888;
                padding: 8px 15px;
                margin-right: 2px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            QTabBar::tab:selected {
                background-color: #1a1a2e;
                color: #ff6b6b;
            }
        """)
        
        # Info tab
        info_widget = QWidget()
        info_layout = QVBoxLayout(info_widget)
        
        self.info_text = QTextEdit()
        self.info_text.setReadOnly(True)
        self.info_text.setStyleSheet("""
            QTextEdit {
                background-color: #16213e;
                color: white;
                border: none;
            }
        """)
        info_layout.addWidget(self.info_text)
        
        self.details_tabs.addTab(info_widget, "üìã Info")
        
        # Code tab
        code_widget = QWidget()
        code_layout = QVBoxLayout(code_widget)
        
        self.code_text = QTextEdit()
        self.code_text.setReadOnly(True)
        self.code_text.setStyleSheet("""
            QTextEdit {
                background-color: #0f0f1a;
                color: #00ff88;
                border: none;
                font-family: 'Fira Code', 'Consolas', monospace;
            }
        """)
        code_layout.addWidget(self.code_text)
        
        # Code actions
        code_actions = QHBoxLayout()
        
        copy_btn = QPushButton("üìã Copy")
        copy_btn.clicked.connect(self._copy_code)
        copy_btn.setStyleSheet("""
            QPushButton {
                background-color: #16213e;
                color: white;
                padding: 8px 15px;
                border: 1px solid #333;
                border-radius: 5px;
            }
            QPushButton:hover {
                background-color: #1a3a5e;
            }
        """)
        
        download_btn = QPushButton("üíæ Download")
        download_btn.clicked.connect(self._download_exploit)
        download_btn.setStyleSheet("""
            QPushButton {
                background-color: #16213e;
                color: white;
                padding: 8px 15px;
                border: 1px solid #333;
                border-radius: 5px;
            }
            QPushButton:hover {
                background-color: #1a3a5e;
            }
        """)
        
        code_actions.addWidget(copy_btn)
        code_actions.addWidget(download_btn)
        code_actions.addStretch()
        code_layout.addLayout(code_actions)
        
        self.details_tabs.addTab(code_widget, "üíª Code")
        
        # References tab
        refs_widget = QWidget()
        refs_layout = QVBoxLayout(refs_widget)
        
        self.refs_list = QListWidget()
        self.refs_list.setStyleSheet("""
            QListWidget {
                background-color: #16213e;
                color: #00bfff;
                border: none;
            }
            QListWidget::item {
                padding: 5px;
            }
        """)
        refs_layout.addWidget(self.refs_list)
        
        self.details_tabs.addTab(refs_widget, "üîó References")
        
        details_layout.addWidget(self.details_tabs)
        splitter.addWidget(details_widget)
        
        splitter.setSizes([400, 600])
        layout.addWidget(splitter)
        
        # Status bar
        status_row = QHBoxLayout()
        
        self.status_label = QLabel("Ready to search")
        self.status_label.setStyleSheet("color: #888;")
        
        self.results_count = QLabel("0 results")
        self.results_count.setStyleSheet("color: #00ff88;")
        
        status_row.addWidget(self.status_label)
        status_row.addStretch()
        status_row.addWidget(self.results_count)
        
        layout.addLayout(status_row)
        
        # Store exploits data
        self.current_exploits = []
        
    def _search(self):
        """Perform exploit search"""
        query = self.search_input.text().strip()
        
        if not query:
            self.status_label.setText("‚ùå Please enter a search query")
            return
            
        self.search_btn.setEnabled(False)
        self.progress_bar.setVisible(True)
        self.progress_bar.setRange(0, 0)
        self.status_label.setText(f"Searching for '{query}'...")
        
        # Start worker
        self.worker = ExploitSearchWorker(query)
        self.worker.progress.connect(lambda msg: self.status_label.setText(msg))
        self.worker.finished.connect(self._on_search_complete)
        self.worker.error.connect(self._on_search_error)
        self.worker.start()
        
    def _on_search_complete(self, results):
        """Handle search completion"""
        self.progress_bar.setVisible(False)
        self.search_btn.setEnabled(True)
        
        self.results_list.clear()
        self.current_exploits = results.results if hasattr(results, 'results') else []
        
        for exploit in self.current_exploits:
            # Create list item
            item = QListWidgetItem()
            
            # Format display text
            cves = ', '.join(exploit.cve_ids[:3]) if exploit.cve_ids else 'No CVE'
            text = f"[{exploit.source.value}] {exploit.title[:60]}...\n"
            text += f"CVEs: {cves} | CVSS: {exploit.cvss_score}"
            
            item.setText(text)
            
            # Color by severity
            if exploit.cvss_score >= 9.0:
                item.setBackground(QColor(80, 20, 20))
            elif exploit.cvss_score >= 7.0:
                item.setBackground(QColor(60, 30, 10))
                
            self.results_list.addItem(item)
            
        count = len(self.current_exploits)
        self.results_count.setText(f"{count} results")
        self.status_label.setText(f"‚úÖ Found {count} exploits in {results.search_time:.2f}s")
        
    def _on_search_error(self, error):
        """Handle search error"""
        self.progress_bar.setVisible(False)
        self.search_btn.setEnabled(True)
        self.status_label.setText(f"‚ùå Error: {error}")
        
    def _show_exploit_details(self, row):
        """Show details for selected exploit"""
        if row < 0 or row >= len(self.current_exploits):
            return
            
        exploit = self.current_exploits[row]
        
        # Update info tab
        info = f"""
<h2 style="color: #ff6b6b;">{exploit.title}</h2>
<hr>
<p><b>Exploit ID:</b> {exploit.exploit_id}</p>
<p><b>Source:</b> {exploit.source.value}</p>
<p><b>Platform:</b> {exploit.platform.value}</p>
<p><b>Type:</b> {exploit.exploit_type.value}</p>
<p><b>Author:</b> {exploit.author or 'Unknown'}</p>
<p><b>Published:</b> {exploit.published_date or 'Unknown'}</p>
<p><b>CVSS Score:</b> <span style="color: {'#ff6b6b' if exploit.cvss_score >= 7 else '#ffcc00'};">{exploit.cvss_score}</span></p>
<p><b>Verified:</b> {'‚úÖ Yes' if exploit.verified else '‚ùå No'}</p>

<h3>CVEs</h3>
<p>{', '.join(exploit.cve_ids) if exploit.cve_ids else 'No CVEs associated'}</p>

<h3>Description</h3>
<p>{exploit.description or 'No description available'}</p>

<h3>Affected Products</h3>
<p>{', '.join(exploit.affected_products) if exploit.affected_products else 'Not specified'}</p>

<h3>Tags</h3>
<p>{', '.join(exploit.tags) if exploit.tags else 'No tags'}</p>

<p><a href="{exploit.source_url}" style="color: #00bfff;">View on {exploit.source.value}</a></p>
"""
        self.info_text.setHtml(info)
        
        # Update code tab
        if exploit.code:
            self.code_text.setPlainText(exploit.code)
        else:
            self.code_text.setPlainText("# Code not available\n# Visit the source URL to view the exploit")
            
        # Update references
        self.refs_list.clear()
        for ref in exploit.references:
            self.refs_list.addItem(ref)
        if exploit.source_url:
            self.refs_list.addItem(exploit.source_url)
            
    def _copy_code(self):
        """Copy exploit code to clipboard"""
        from PyQt6.QtWidgets import QApplication
        QApplication.clipboard().setText(self.code_text.toPlainText())
        self.status_label.setText("‚úÖ Code copied to clipboard")
        
    def _download_exploit(self):
        """Download exploit to file"""
        if not self.results_list.currentRow() >= 0:
            return
            
        exploit = self.current_exploits[self.results_list.currentRow()]
        
        from PyQt6.QtWidgets import QFileDialog
        filepath, _ = QFileDialog.getSaveFileName(
            self,
            "Save Exploit",
            f"{exploit.exploit_id}.txt",
            "All Files (*.*)"
        )
        
        if filepath:
            with open(filepath, 'w') as f:
                f.write(f"# {exploit.title}\n")
                f.write(f"# Source: {exploit.source_url}\n")
                f.write(f"# CVEs: {', '.join(exploit.cve_ids)}\n")
                f.write(f"# CVSS: {exploit.cvss_score}\n\n")
                f.write(exploit.code or "# No code available")
                
            self.status_label.setText(f"‚úÖ Saved to {filepath}")
