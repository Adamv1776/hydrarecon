"""
Evolutionary Exploit Page
Genetic algorithm-based exploit development interface.
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,
    QFrame, QScrollArea, QGridLayout, QLineEdit, QTextEdit,
    QProgressBar, QTableWidget, QTableWidgetItem, QHeaderView,
    QGroupBox, QSpinBox, QComboBox, QTabWidget, QSplitter,
    QListWidget, QListWidgetItem, QDoubleSpinBox, QSlider
)
from PyQt6.QtCore import Qt, pyqtSignal, QTimer
from PyQt6.QtGui import QFont, QColor


class EvolutionaryExploitPage(QWidget):
    """Evolutionary exploit generation interface"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setup_ui()
    
    def setup_ui(self):
        """Setup the UI"""
        layout = QVBoxLayout(self)
        layout.setSpacing(15)
        layout.setContentsMargins(20, 20, 20, 20)
        
        # Header
        header = self._create_header()
        layout.addWidget(header)
        
        # Main content
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Left - Configuration
        left = self._create_config_panel()
        splitter.addWidget(left)
        
        # Right - Evolution view
        right = self._create_evolution_panel()
        splitter.addWidget(right)
        
        splitter.setSizes([350, 650])
        layout.addWidget(splitter, 1)
        
        self.setStyleSheet(self._get_styles())
    
    def _create_header(self) -> QFrame:
        """Create header"""
        frame = QFrame()
        frame.setObjectName("headerFrame")
        layout = QHBoxLayout(frame)
        
        # Title
        title_layout = QVBoxLayout()
        
        title = QLabel("ðŸ§¬ Evolutionary Exploit Engine")
        title.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
        title.setStyleSheet("color: #9b59b6;")
        title_layout.addWidget(title)
        
        subtitle = QLabel("Genetic algorithm-based exploit development")
        subtitle.setStyleSheet("color: #888;")
        title_layout.addWidget(subtitle)
        
        layout.addLayout(title_layout)
        layout.addStretch()
        
        # Stats
        stats_layout = QHBoxLayout()
        
        self.gen_stat = self._create_stat("Generation", "0")
        stats_layout.addWidget(self.gen_stat)
        
        self.fitness_stat = self._create_stat("Best Fitness", "0.00")
        stats_layout.addWidget(self.fitness_stat)
        
        self.pop_stat = self._create_stat("Population", "50")
        stats_layout.addWidget(self.pop_stat)
        
        layout.addLayout(stats_layout)
        
        return frame
    
    def _create_stat(self, label: str, value: str) -> QFrame:
        """Create stat widget"""
        frame = QFrame()
        frame.setObjectName("statWidget")
        layout = QVBoxLayout(frame)
        layout.setContentsMargins(15, 10, 15, 10)
        
        value_lbl = QLabel(value)
        value_lbl.setFont(QFont("Consolas", 16, QFont.Weight.Bold))
        value_lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
        value_lbl.setStyleSheet("color: #9b59b6;")
        value_lbl.setObjectName(f"stat_{label.replace(' ', '_')}")
        layout.addWidget(value_lbl)
        
        name_lbl = QLabel(label)
        name_lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
        name_lbl.setStyleSheet("color: #888; font-size: 11px;")
        layout.addWidget(name_lbl)
        
        return frame
    
    def _create_config_panel(self) -> QFrame:
        """Create configuration panel"""
        frame = QFrame()
        frame.setObjectName("configPanel")
        layout = QVBoxLayout(frame)
        
        # Exploit type
        type_group = QGroupBox("Exploit Type")
        type_layout = QVBoxLayout(type_group)
        
        self.exploit_combo = QComboBox()
        self.exploit_combo.addItems([
            "Buffer Overflow",
            "Format String",
            "Use-After-Free",
            "Integer Overflow",
            "Heap Spray",
            "ROP Chain",
            "JIT Spray",
            "Type Confusion",
            "Deserialization",
            "Command Injection"
        ])
        type_layout.addWidget(self.exploit_combo)
        
        layout.addWidget(type_group)
        
        # Target info
        target_group = QGroupBox("Target Configuration")
        target_layout = QGridLayout(target_group)
        
        target_layout.addWidget(QLabel("Architecture:"), 0, 0)
        self.arch_combo = QComboBox()
        self.arch_combo.addItems(["x86", "x64", "ARM", "ARM64", "MIPS"])
        target_layout.addWidget(self.arch_combo, 0, 1)
        
        target_layout.addWidget(QLabel("OS:"), 1, 0)
        self.os_combo = QComboBox()
        self.os_combo.addItems(["Linux", "Windows", "macOS", "FreeBSD"])
        target_layout.addWidget(self.os_combo, 1, 1)
        
        target_layout.addWidget(QLabel("ASLR:"), 2, 0)
        self.aslr_combo = QComboBox()
        self.aslr_combo.addItems(["Disabled", "Partial", "Full"])
        target_layout.addWidget(self.aslr_combo, 2, 1)
        
        target_layout.addWidget(QLabel("DEP/NX:"), 3, 0)
        self.dep_combo = QComboBox()
        self.dep_combo.addItems(["Disabled", "Enabled"])
        target_layout.addWidget(self.dep_combo, 3, 1)
        
        layout.addWidget(target_group)
        
        # Genetic parameters
        genetic_group = QGroupBox("Genetic Parameters")
        genetic_layout = QGridLayout(genetic_group)
        
        genetic_layout.addWidget(QLabel("Population:"), 0, 0)
        self.pop_spin = QSpinBox()
        self.pop_spin.setRange(10, 500)
        self.pop_spin.setValue(50)
        genetic_layout.addWidget(self.pop_spin, 0, 1)
        
        genetic_layout.addWidget(QLabel("Generations:"), 1, 0)
        self.gen_spin = QSpinBox()
        self.gen_spin.setRange(10, 1000)
        self.gen_spin.setValue(100)
        genetic_layout.addWidget(self.gen_spin, 1, 1)
        
        genetic_layout.addWidget(QLabel("Mutation Rate:"), 2, 0)
        self.mutation_slider = QSlider(Qt.Orientation.Horizontal)
        self.mutation_slider.setRange(1, 50)
        self.mutation_slider.setValue(15)
        genetic_layout.addWidget(self.mutation_slider, 2, 1)
        
        genetic_layout.addWidget(QLabel("Crossover Rate:"), 3, 0)
        self.crossover_slider = QSlider(Qt.Orientation.Horizontal)
        self.crossover_slider.setRange(1, 100)
        self.crossover_slider.setValue(70)
        genetic_layout.addWidget(self.crossover_slider, 3, 1)
        
        genetic_layout.addWidget(QLabel("Elite Count:"), 4, 0)
        self.elite_spin = QSpinBox()
        self.elite_spin.setRange(1, 20)
        self.elite_spin.setValue(5)
        genetic_layout.addWidget(self.elite_spin, 4, 1)
        
        layout.addWidget(genetic_group)
        
        # Fitness weights
        fitness_group = QGroupBox("Fitness Weights")
        fitness_layout = QGridLayout(fitness_group)
        
        weights = [
            ("Evasion:", 0.30),
            ("Reliability:", 0.25),
            ("Stealth:", 0.20),
            ("Size:", 0.10),
            ("Speed:", 0.05),
            ("Target Match:", 0.10)
        ]
        
        for i, (name, val) in enumerate(weights):
            fitness_layout.addWidget(QLabel(name), i, 0)
            spin = QDoubleSpinBox()
            spin.setRange(0.0, 1.0)
            spin.setSingleStep(0.05)
            spin.setValue(val)
            fitness_layout.addWidget(spin, i, 1)
        
        layout.addWidget(fitness_group)
        
        # Action buttons
        btn_layout = QHBoxLayout()
        
        self.evolve_btn = QPushButton("ðŸ§¬ Start Evolution")
        self.evolve_btn.setObjectName("primaryButton")
        self.evolve_btn.clicked.connect(self._start_evolution)
        btn_layout.addWidget(self.evolve_btn)
        
        self.stop_btn = QPushButton("â¹ Stop")
        self.stop_btn.setEnabled(False)
        self.stop_btn.clicked.connect(self._stop_evolution)
        btn_layout.addWidget(self.stop_btn)
        
        layout.addLayout(btn_layout)
        
        # Progress
        self.progress = QProgressBar()
        self.progress.setVisible(False)
        layout.addWidget(self.progress)
        
        layout.addStretch()
        
        return frame
    
    def _create_evolution_panel(self) -> QFrame:
        """Create evolution visualization panel"""
        frame = QFrame()
        frame.setObjectName("evolutionPanel")
        layout = QVBoxLayout(frame)
        
        # Tabs
        tabs = QTabWidget()
        
        # Population tab
        pop_tab = QWidget()
        pop_layout = QVBoxLayout(pop_tab)
        
        self.pop_table = QTableWidget()
        self.pop_table.setColumnCount(6)
        self.pop_table.setHorizontalHeaderLabels([
            "ID", "Fitness", "Evasion", "Reliability", "Size", "Mutations"
        ])
        self.pop_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        pop_layout.addWidget(self.pop_table)
        
        tabs.addTab(pop_tab, "ðŸ‘¥ Population")
        
        # Best exploit tab
        best_tab = QWidget()
        best_layout = QVBoxLayout(best_tab)
        
        # Best exploit info
        info_group = QGroupBox("Best Evolved Exploit")
        info_layout = QGridLayout(info_group)
        
        info_layout.addWidget(QLabel("Fitness:"), 0, 0)
        self.best_fitness = QLabel("0.00")
        self.best_fitness.setStyleSheet("color: #00ff88; font-weight: bold;")
        info_layout.addWidget(self.best_fitness, 0, 1)
        
        info_layout.addWidget(QLabel("Generation:"), 1, 0)
        self.best_gen = QLabel("0")
        info_layout.addWidget(self.best_gen, 1, 1)
        
        info_layout.addWidget(QLabel("Size:"), 2, 0)
        self.best_size = QLabel("0 bytes")
        info_layout.addWidget(self.best_size, 2, 1)
        
        info_layout.addWidget(QLabel("Mutations:"), 3, 0)
        self.best_mutations = QLabel("-")
        info_layout.addWidget(self.best_mutations, 3, 1)
        
        best_layout.addWidget(info_group)
        
        # Payload view
        payload_group = QGroupBox("Payload (Hex)")
        payload_layout = QVBoxLayout(payload_group)
        
        self.payload_view = QTextEdit()
        self.payload_view.setReadOnly(True)
        self.payload_view.setFont(QFont("Consolas", 10))
        self.payload_view.setPlaceholderText("Evolved payload hex will appear here...")
        payload_layout.addWidget(self.payload_view)
        
        export_btn = QPushButton("ðŸ’¾ Export Payload")
        export_btn.clicked.connect(self._export_payload)
        payload_layout.addWidget(export_btn)
        
        best_layout.addWidget(payload_group)
        
        tabs.addTab(best_tab, "â­ Best Exploit")
        
        # Fitness graph tab
        graph_tab = QWidget()
        graph_layout = QVBoxLayout(graph_tab)
        
        self.fitness_log = QTextEdit()
        self.fitness_log.setReadOnly(True)
        self.fitness_log.setFont(QFont("Consolas", 9))
        graph_layout.addWidget(self.fitness_log)
        
        tabs.addTab(graph_tab, "ðŸ“ˆ Evolution Log")
        
        # Mutations tab
        mut_tab = QWidget()
        mut_layout = QVBoxLayout(mut_tab)
        
        self.mutation_table = QTableWidget()
        self.mutation_table.setColumnCount(3)
        self.mutation_table.setHorizontalHeaderLabels([
            "Mutation Type", "Count", "Success Rate"
        ])
        self.mutation_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        
        # Add mutation types
        mutations = [
            ("Bit Flip", "0", "0%"),
            ("Byte Swap", "0", "0%"),
            ("Block Shuffle", "0", "0%"),
            ("Instruction Substitute", "0", "0%"),
            ("NOP Insert", "0", "0%"),
            ("Junk Insert", "0", "0%"),
            ("Register Swap", "0", "0%"),
            ("Opcode Equivalent", "0", "0%"),
            ("Encoding Change", "0", "0%"),
        ]
        
        self.mutation_table.setRowCount(len(mutations))
        for i, (mut, count, rate) in enumerate(mutations):
            self.mutation_table.setItem(i, 0, QTableWidgetItem(mut))
            self.mutation_table.setItem(i, 1, QTableWidgetItem(count))
            self.mutation_table.setItem(i, 2, QTableWidgetItem(rate))
        
        mut_layout.addWidget(self.mutation_table)
        
        tabs.addTab(mut_tab, "ðŸ”€ Mutations")
        
        layout.addWidget(tabs)
        
        return frame
    
    def _start_evolution(self):
        """Start evolution process"""
        self.evolve_btn.setEnabled(False)
        self.stop_btn.setEnabled(True)
        self.progress.setVisible(True)
        self.progress.setValue(0)
        
        self.generation = 0
        self.best = 0.0
        
        self.evolution_timer = QTimer()
        self.evolution_timer.timeout.connect(self._evolve_step)
        self.evolution_timer.start(100)
    
    def _evolve_step(self):
        """Perform one evolution step"""
        import random
        
        self.generation += 1
        max_gen = self.gen_spin.value()
        
        # Update progress
        progress = int((self.generation / max_gen) * 100)
        self.progress.setValue(progress)
        
        # Simulate fitness improvement
        self.best = min(0.95, self.best + random.uniform(0.01, 0.03))
        
        # Update stats
        self._update_stat("Generation", str(self.generation))
        self._update_stat("Best_Fitness", f"{self.best:.2f}")
        
        # Log
        self.fitness_log.append(
            f"Gen {self.generation:4d} | Best: {self.best:.4f} | "
            f"Avg: {self.best * 0.7:.4f} | Diversity: {random.uniform(0.3, 0.8):.4f}"
        )
        
        # Update population table
        self._update_population()
        
        # Update best exploit
        self.best_fitness.setText(f"{self.best:.4f}")
        self.best_gen.setText(str(self.generation))
        self.best_size.setText(f"{random.randint(100, 500)} bytes")
        
        if self.generation >= max_gen or self.best > 0.95:
            self._stop_evolution()
            self._show_final_result()
    
    def _update_population(self):
        """Update population table"""
        import random
        
        pop_size = min(10, self.pop_spin.value())
        self.pop_table.setRowCount(pop_size)
        
        for i in range(pop_size):
            fitness = self.best - (i * 0.05) + random.uniform(-0.02, 0.02)
            fitness = max(0, min(1, fitness))
            
            self.pop_table.setItem(i, 0, QTableWidgetItem(f"chrom-{i:04d}"))
            
            fitness_item = QTableWidgetItem(f"{fitness:.4f}")
            if fitness > 0.8:
                fitness_item.setForeground(QColor("#00ff88"))
            elif fitness > 0.5:
                fitness_item.setForeground(QColor("#ffff00"))
            else:
                fitness_item.setForeground(QColor("#ff4444"))
            self.pop_table.setItem(i, 1, fitness_item)
            
            self.pop_table.setItem(i, 2, QTableWidgetItem(f"{fitness * 0.9:.2f}"))
            self.pop_table.setItem(i, 3, QTableWidgetItem(f"{fitness * 0.85:.2f}"))
            self.pop_table.setItem(i, 4, QTableWidgetItem(f"{random.randint(100, 500)}"))
            self.pop_table.setItem(i, 5, QTableWidgetItem(f"{random.randint(1, 10)}"))
    
    def _stop_evolution(self):
        """Stop evolution"""
        if hasattr(self, 'evolution_timer'):
            self.evolution_timer.stop()
        
        self.evolve_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
    
    def _show_final_result(self):
        """Show final evolved result"""
        import random
        
        # Generate fake payload hex
        payload_hex = ' '.join(f'{random.randint(0, 255):02x}' for _ in range(200))
        formatted = '\n'.join(payload_hex[i:i+48] for i in range(0, len(payload_hex), 48))
        self.payload_view.setText(formatted)
        
        self.best_mutations.setText("BitFlip, NopInsert, EncodingChange")
        
        self.fitness_log.append("\n" + "=" * 50)
        self.fitness_log.append("âœ… EVOLUTION COMPLETE")
        self.fitness_log.append(f"Final Best Fitness: {self.best:.4f}")
        self.fitness_log.append("=" * 50)
    
    def _update_stat(self, name: str, value: str):
        """Update stat display"""
        stat_label = self.findChild(QLabel, f"stat_{name}")
        if stat_label:
            stat_label.setText(value)
    
    def _export_payload(self):
        """Export evolved payload"""
        from PyQt6.QtWidgets import QFileDialog
        
        file_path, _ = QFileDialog.getSaveFileName(
            self, "Export Payload", "evolved_exploit.bin", "Binary Files (*.bin)"
        )
    
    def _get_styles(self) -> str:
        """Get styles"""
        return """
            QWidget {
                background-color: #1a1a2e;
                color: #ffffff;
                font-family: 'Segoe UI', Arial, sans-serif;
            }
            
            #headerFrame {
                background-color: #16213e;
                border-radius: 10px;
                padding: 15px;
            }
            
            #statWidget {
                background-color: #1a1a2e;
                border: 1px solid #9b59b644;
                border-radius: 8px;
                min-width: 100px;
            }
            
            #configPanel, #evolutionPanel {
                background-color: #16213e;
                border-radius: 10px;
                padding: 15px;
            }
            
            QGroupBox {
                border: 1px solid #9b59b644;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 15px;
                font-weight: bold;
                color: #9b59b6;
            }
            
            QLineEdit, QComboBox, QSpinBox, QDoubleSpinBox {
                background-color: #0f0f1a;
                border: 1px solid #333;
                border-radius: 5px;
                padding: 8px;
            }
            
            QSlider::groove:horizontal {
                background: #333;
                height: 6px;
                border-radius: 3px;
            }
            
            QSlider::handle:horizontal {
                background: #9b59b6;
                width: 16px;
                height: 16px;
                margin: -5px 0;
                border-radius: 8px;
            }
            
            #primaryButton {
                background-color: #9b59b6;
                color: #fff;
                border: none;
                border-radius: 8px;
                padding: 12px 24px;
                font-weight: bold;
            }
            
            #primaryButton:hover {
                background-color: #8e44ad;
            }
            
            #primaryButton:disabled {
                background-color: #333;
            }
            
            QPushButton {
                background-color: #333;
                color: #fff;
                border: none;
                border-radius: 5px;
                padding: 8px 16px;
            }
            
            QPushButton:hover {
                background-color: #444;
            }
            
            QTableWidget {
                background-color: #0f0f1a;
                border: 1px solid #333;
                border-radius: 8px;
            }
            
            QHeaderView::section {
                background-color: #1a1a2e;
                color: #9b59b6;
                padding: 10px;
                border: none;
            }
            
            QTabWidget::pane {
                border: 1px solid #333;
                border-radius: 8px;
            }
            
            QTabBar::tab {
                background-color: #1a1a2e;
                color: #888;
                padding: 10px 20px;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            
            QTabBar::tab:selected {
                background-color: #9b59b633;
                color: #9b59b6;
            }
            
            QTextEdit {
                background-color: #0f0f1a;
                border: 1px solid #333;
                border-radius: 8px;
            }
            
            QProgressBar {
                border: none;
                border-radius: 5px;
                background-color: #0f0f1a;
                height: 10px;
            }
            
            QProgressBar::chunk {
                background-color: #9b59b6;
                border-radius: 5px;
            }
        """
